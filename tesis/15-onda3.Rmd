---
knit: purrr::partial(bookdown::render_book, output_format = 'bookdown::pdf_book', preview = FALSE)
always_allow_html: true
---

```{r setup, include=FALSE}
library(eliotesis)
library(metR)
library(data.table)
library(magrittr)
library(ggplot2)
library(tagger)
library(ggperiodic)

library(patchwork)
library(rlang)
library(kableExtra)

source(here::here("tesis/scripts/globals.R"))

blue <- "#0d52bf"
gray <- "#d4d4d4"
```

# Exploración de las formas de descripción de la onda 3 {#onda3}

En el [capítulo anterior](#intro) se introdujeron conceptualmente algunos aspectos problemáticos de las metodologías e índices normalmente utilizados en la literatura para estudiar la circulación zonalmente asimétrica en el hemisferio sur.
Este capítulo realiza una primera evaluación de la descripción de la onda zonal 3 a través del del índice propuesto por @raphael2004 y de la descomposición de Fourier.

## Métodos

### Datos

Se utilizaron datos mensuales de altura geopotencial, del European Centre for Medium-Range Weather Forecasts Reanalysis versión 5 (ERA5) [@hersbach2020] a una resolución espacial de 2,5° de longitud por 2,5° de latitud.
Se utilizaron datos del período post-satelital (`r periodo`) para garantizar la mayor cobertura posible de datos en el hemisferio sur que hayan alimentado al sistema de reanálisis.

### Índice R04


```{r point_raphael}
# The three grid points chosen to represent ZW3 lie in the approximate
# location of the ridges of the wave at latitude 49S and
# longitudes 50E, 166E and 76W. The locations are based
# on van Loon and Jenne [1972, Figure 2] which shows the
# annual average location of the ridges of ZW3 in the 500 hPa
# field.
#      - Raphael 2003

points_raphael <- data.table(lat = -49, 
                             lon = metR::ConvertLongitude(c(50, 166, -76)))

filter_raphael <- function(data, points = points_raphael) {
  data[lat %~% points_raphael$lat][lon %~% points_raphael$lon]
}
```

```{r hgt}
hgt <- ERA5_geopotential() %>%
  ReadNetCDF(vars = c(hgt = "z"),
             subset = list(level = 500,
                           latitude = -90:10,
                           time = main_period)) %>% 
  .[, hgt := hgt/9.8] %>% 
  na.omit() %>% 
  normalise_coords() %>% 
  .[, hgt_z := Anomaly(hgt), by = .(time, lat)] 
```

```{r raphael}

puntos <- hgt %>%
  copy() %>% 
  filter_raphael()


raphael_aes_used <- list(fill = blue, size = 3, shape = 21, color = gray)

raphael_aes_unused <- list(color = "black", size = 3)


raphael <- puntos %>% 
  copy() %>% 
  .[, hgt_z := frollmean(hgt_z, 3, fill = NA, align = "center"), 
    by = .(lon, lat, lev)] %>%
  na.omit() %>% 
  .[, hgt_z := scale(hgt_z), by = .(lon, lat, month(time), lev)] %>% 
  .[, .(r04 = mean(hgt_z)), by = .(time, lev)]
```

El índice definido por @raphael2004 (de acá en adelante denominado "R04") se basa en un índice similar definido por @mo1985 y es el índice más utilizado en la literatura para cuantificar la actividad de la onda zonal 3 del hemisferio sur.
Se calcula como el promedio de las anomalías zonales estandarizadas del promedio móvil de tres meses de altura geopotencial en 49ºS y en 500 hPa en tres ubicaciones elegidas para coincidir aproximadamente con los máximos climatológicos de la onda 3 según @vanloon1972: 50ºE, 166ºE y 76ºO.
Valores positivos y negativos indican, por lo tanto, anomalías positivas y negativas  alrededor de estas ubicaciones, respectivamente.
El promedio móvil de tres meses se aplica para evitar que el índice sea sensible al ciclo estacional de la localización de la onda 3 climatológica.
Dado que se utilizaron datos de reanálisis con una resolución de 2,5º, se calculó el índice con los puntos más cercanos: `r combine_words(LonLabel(unique(puntos$lon)))` en `r LatLabel(unique(puntos$lat))`.

### Envolvente

Para cuantificar la actividad de las ondas zonales, se calculó la envolvente de las ondas siguiendo a @irving2015.
Primero se calcula la transformada de Fourier de las anomalías de geopotencial en un círculo de latitud determinado, luego se le aplica la transformada inversa sólo al espectro positivo y finalmente se toma el doble de la amplitud de este resultado complejo.

```{r envolvente-ejemplo, fig.height=3, fig.width=3}
fecha_ejemplo <- "1989-09-01"
ejemplo_datos <- ERA5_geopotential() %>%
  ReadNetCDF(vars = c(hgt = "z"),
             subset = list(level = 500,
                           latitude = c(-90, 0),
                           time = fecha_ejemplo)) %>% 
  .[, hgt := hgt/9.8] %>% 
  na.omit() %>% 
  normalise_coords() %>% 
  .[, hgt_z := Anomaly(hgt), by = .(time, lat)] %>% 
  .[, env := WaveEnvelope(hgt_z), by = .(time, lat)] 


ejemplo_datos %>% 
  periodic(lon = c(0, 360)) %>% 
  ggplot(aes(lon, lat)) + 
  geom_contour_fill(aes(z = env, fill = after_stat(level))) +
  # geom_hline(yintercept = -60, linetype = 2) +
  geom_contour2(aes(z = hgt_z, linetype = after_stat(factor(-sign(level)))), 
                breaks = AnchorBreaks(0, exclude = 0)) +  geom_qmap() +
  scale_y_latitude(limits = c(-90, 0)) +
  scale_x_longitude() +
  scale_linetype(guide = "none") +
  scale_fill_divergent_discretised(NULL, guide = guide_colorsteps_bottom(10)) +
  annotate_grid() +
  coord_polar2() 
```

(ref:envolvente-ejemplo-cap) Anomalías zonales de altura geopotencial (m) en 500 hPa en septiembre de 1989 (contornos, líneas sólidas indican valores positivos y líneas punteadas indican valores negativos) y envolvente de ondas zonales (sombreado).

La Figura \@ref(fig:envolvente-ejemplo) muestra un ejemplo de la envolvente de la ondas zonales para la altura geopotencial en 500 hPa en septiembre de 1989 junto con las anomalías zonales correspondientes.
Estas anomalías son intensas al sur de Australia y Nueva Zelanda y la envolvente captura esa región.

### Software

El análisis de datos se realizó utilizando el lenguaje de programación R [@rcoreteam2020], con los paquetes data.table [@dowle2020] y metR [@campitelli2020].
Los gráficos se hicieron con ggplot2 [@wickham2009].

Los datos de reanálisis fueron descargados con el paquete ecmwfr [@hufkens2020], los datos de CMIP y DAMIP se descargaron con el paquete rcmip6 [@rcmip6] y los índices de El Niño-Oscilación del Sur (ENSO, por sus siglas en inglés) y el dipolo del Índico, con el paquete rsoi [@albers2020].

La tesis se compiló utilizando knitr y rmarkdown [@xie2015; @R-rmarkdown].

## Resultados

### Índice R04

La Figura \@ref(fig:raphael-regr) presenta la regresión lineal entre R04 y la anomalía zonal de altura geopotencial en 500 hPa junto con la onda 3 obtenida de la descomposición de Fourier del campo medio climatológico de la altura geopotencial en 500 hPa para el período `r periodo`.
La figura incluye además las ubicaciones definidas por @raphael2004 para calcular el índice.
Se observa que R04 representa una onda 3 relativamente pura con una amplitud ligeramente más alta en la región del Pacífico Sur.
Sin embargo, se puede notar que los máximos al sur de Nueva Zelanda y sobre el pasaje de Drake se encuentran más al sur que los puntos usados de referencia.

```{r raphael-regr, fig.height=3, fig.width=3}
hgt %>% 
  .[raphael, on = "time"] %>% 
  .[, FitLm(hgt_z, r04), by = .(lon, lat)] %>% 
  rm_intercept() %>% 
  # .[, envelope := WaveEnvelope(estimate), by = .(lat)] %>% 
  ggperiodic::periodic(lon = c(0, 360)) %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = estimate, fill = after_stat(level)),
                    breaks = AnchorBreaks(0, exclude = 0)) +
  geom_contour_tanaka(aes(z = estimate), breaks = AnchorBreaks(0, exclude = 0)) +
  geom_contour2(data = copy(hgt) %>% 
                  .[, .(mean = mean(hgt_z)), by = .(lon, lat)] %>% 
                  .[, mean := FilterWave(mean, 3), by = lat] %>% 
                  periodic(lon = c(0, 360)), 
                aes(z = mean, linetype = after_stat(factor(-sign(level)))), 
                breaks = AnchorBreaks(0, exclude = 0), size = 0.5) +
  inject(geom_point(data = points_raphael, !!!raphael_aes_used)) +
  geom_qmap() +
  scale_y_latitude(limits = c(-90, 0)) +
  scale_x_longitude() +
  scale_linetype(guide = "none") +
  scale_fill_divergent_discretised(NULL, guide = guide_colorsteps_bottom(10)) +
  annotate_grid() +
  coord_polar2() 
```

(ref:raphael-regr-cap) Regresión lineal entre R04 y la anomalía zonal de altura geopotencial (m) en 500 hPa (sombreado). La onda 3 obtenida de la descomposición de Fourier del campo medio climatológico de la altura geopotencial en 500 hPa se muestra en contornos; (valores positivos en línea llena y negativos en línea punteada). En azul se indican la ubicación de los puntos usado para calcular R04.

La onda 3 descrita por R04 coincide bien con la onda 3 climatológica, lo cual es esperable por construcción.
Al usar puntos fijos cercanos a estos máximos climatológicos, el índice R04 busca medir la similitud del campo de anomalías zonales de altura geopotencial con la onda 3 climatológica.

```{r pseudo-raphael, fig.height=4, fig.width=4}
qs3 <- hgt %>% 
  .[lat == -50] %>% 
  .[, .(qs3 = mean(hgt_z)), by = .(lon)] %>% 
  .[, qs3 := FilterWave(qs3, 3)] %>% 
  .[, qs3 := qs3/max(qs3)]

raphael2 <- puntos %>% 
  .[, .(zw3 = mean(hgt_z)), by = .(time, lev)]

pseudo_raphael <- hgt %>% 
  .[lat == -50] %>% 
  .[qs3, on = "lon"] %>% 
  .[, .(value = mean(qs3*hgt)*2), by = time]


lims <- range(c(pseudo_raphael$value,
                raphael2$zw3))

pseudo_raphael %>% 
  .[raphael2, on = "time"] %>% 
  {
    cor_pseudo_raphael <<- .[, correlate(zw3, value)]
    .
  } %>% 
  ggplot(aes(zw3, value)) +
  geom_point() +
  scale_x_continuous("Anomalía de altura geopotencial promedio [m]", limits = lims) +
  scale_y_continuous("Proyección [m]", limits = lims) +
  coord_equal()
```

(ref:pseudo-raphael-cap) Relación entre la anomalía zonal de altura geopotencial (m) en los tres puntos utilizados para construir R04 y la amplitud de la proyección de la altura geopotencial (m) en 50ºS y 500 hPa con la onda 3 climatológica

La Figura \@ref(fig:pseudo-raphael) muestra la relación entre la proyección de la altura geopotencial en 50ºS con la onda 3 climatológica en esa latitud y la anomalía zonal de altura geopotencial promediada en las tres ubicaciones de R04 (que no es exactamente el índice R04 ya que éste se calcula a partir de un promedio móvil de 3 meses y una estandarización previa al promediado).
Ambas series son casi idénticas, con una correlación de `r cor_pseudo_raphael$text`.
Esto ilustra que el R04 no es un índice de la amplitud de la onda 3, sino un índice de cuánto se parece la altura geopotencial en 50ºS a la onda 3 media en 50ºS.

Si bien la Figura \@ref(fig:raphael-regr) muestra que R04 está asociado con una onda 3 relativamente pura, no es sorprendente que un índice basado en el promedio de 3 puntos esté altamente correlacionado con regiones cercanas a esos puntos.
Esto no garantiza que esta estructura así definida represente un patrón físicamente coherente.

```{r raphael-correlation}
concordance <- puntos %>% 
  .[lev == 500] %>% 
  .[, .(concordant = sum(sign(hgt) == sign(hgt[1])) == 3), by = time] 

cor_puntos <- puntos %>% 
  copy() %>% 
  .[, lon := factor(LonLabel(lon), levels = LonLabel(unique(lon)))] %>% 
  widyr::pairwise_cor(lon, time, hgt_z, diag = TRUE) %>% 
  as.data.table()

cor_puntos %>% 
  dcast(item1 ~ item2, value.var = "correlation") %>% 
  setnames("item1", "") %>% 
  kbl(align = "c", 
      caption = "Correlación temporal entre la anomalía zonal de geopotential para cada posible par de ubicaciones (indicadas por su longitud) de los tres puntos utilizados para construir R04.", 
      booktabs = TRUE, digits = 2) %>%
  kable_classic_2(full_width = F)
```

Para explorar la consistencia física de la aplicación de R04 se presenta la Tabla \@ref(tab:raphael-correlation), que muestra la matriz de correlación entre la anomalía zonal de altura geopotencial en las ubicaciones utilizadas para calcular R04, indicadas por su longitud.
Las correlaciones son muy cercanas a cero, e incluso la correlación entre el punto de 75ºO y 50ºE es negativa.
Esto indica que los puntos no son covariantes, lo que implica que no serían parte de un mismo patrón de onda coherente.

```{r cor_singles}
puntos_std <- puntos %>% 
  copy() %>% 
  .[, hgt_z := frollmean(hgt_z, 3, fill = NA, align = "center"), 
    by = .(lon, lat, lev)] %>%
  na.omit() %>% 
  .[, hgt_z := scale(hgt_z), by = .(lon, lat, month(time), lev)] 

pares <- list(izquierdos = puntos_std %>% 
                .[lon %~% c(50, 165)] ,
              derechos = puntos_std %>% 
                .[lon %~% c(165, 285)],
              extremos = puntos_std %>% 
                .[lon %~% c(50, 285)]) %>% 
  rbindlist(idcol = "index")


pares_labs <- c(izquierdos = "50°E y 165°E", 
                derechos = "165°E y 75°O",
                extremos = "50°E y 75°O")

pares[, index := pares_labs[index]]

indexes <- pares %>% 
  .[, .(value = mean(hgt_z)), by = .(time, index)]

cor_singles <- hgt %>% 
  .[lat > -90] %>% 
  .[puntos_std[, .(lon_point = lon, value = hgt_z, time)], 
    on = "time", allow.cartesian = TRUE] %>%
  .[, FitLm(hgt_z, value), 
    by = .(lon, lat, lon_point)] %>% 
  rm_intercept() %>% 
  .[, index := LonLabel(lon_point)] %>% 
  .[, lon_point := NULL]


cor_dobles <- hgt %>% 
  .[indexes, on = "time", allow.cartesian = TRUE] %>% 
  .[, FitLm(hgt_z, value),
    by = .(lon, lat, index)] %>% 
  rm_intercept() 
```

```{r cor-puntos, fig.height=5, fig.width=6}
gdata <- rbind(cor_singles, 
               cor_dobles) %>% 
  .[, index := forcats::fct_inorder(index)] 

levels <- levels(gdata$index)

gdata %>%   
  periodic(lon = c(0, 360)) %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = estimate, fill = after_stat(level)), 
                    breaks = AnchorBreaks(0, exclude = 0, binwidth = 5)) +
  geom_contour_tanaka(aes(z = estimate),
                      breaks = AnchorBreaks(0, exclude = 0, binwidth = 5)) +
  inject(geom_point(data = unique(puntos[, .(lat, lon)]),
                    !!!raphael_aes_unused)) +
  
  inject(geom_point(data = unique(puntos[, .(lat, lon)] %>% 
                                    .[, index := factor(LonLabel(lon),
                                                        levels = levels)]),
                    !!!raphael_aes_used)) +
  
  inject(geom_point(data = unique(pares[, .(lon ,lat, index = factor(index, levels = levels))]),
                    !!!raphael_aes_used)) +
  
  geom_qmap() +
  scale_y_latitude(limits = c(-90, 0)) +
  scale_x_longitude() +
  scale_fill_divergent_discretised(NULL, guide = guide_colorsteps_bottom(20)) +
  annotate_grid() +
  coord_polar2() +
  facet_wrap(index~., ncol = 3) +
  tag_facets(tag = "rc")
```

(ref:cor-puntos-cap) Regresión entre las anomalías zonales de altura geopotencial en 500 hPa e índices R04 usando combinaciones de 1 y 2 puntos (m). En cada panel, los puntos azules son los puntos usados para calcular el índice y los negros, los excluidos.

La Figura \@ref(fig:cor-puntos) muestra los campos de regresión entre la anomalía zonal de altura geopotencial e índices similares a R04 pero computados considerado o bien solo un punto (Fig. \@ref(fig:cor-puntos), fila a) o promedios de combinaciones de dos puntos (Fig.\@ref(fig:cor-puntos), fila b) de los tres utilizados para computar R04.
La figura muestra que no se encuentra un patrón coherente de onda 3 asociado a los puntos individuales.
Por otra parte, los campos obtenidos a partir de las combinaciones de dos puntos se asocian a anomalías positivas en los dos puntos relevantes y negativas entre los mismos --esperable ya que se trata de anomalías zonales-- pero, crucialmente, no hay una asociación positiva con el tercer punto no incluido en el índice.

```{r raphael-top8, fig.height=4, fig.width=6, fig.ncol = 1}
#| fig.subcap = c("Meses con mayor valor de R04", "Meses con menor valor de R04")
gplot <- function(data, breaks =  AnchorBreaks(0, binwidth = 40, exclude = 0)(c(-320, 320))) {
  
  data %>% 
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = hgt_z, fill = after_stat(level)),
                      breaks = breaks) +
    geom_contour2(aes(z = hgt_za, linetype = after_stat(factor(-sign(level)))),
                  breaks = breaks) +
    inject(geom_point(data = unique(puntos[, .(lon, lat)]),
                      !!!raphael_aes_used)) +
    geom_qmap() +
    scale_y_latitude(limits = c(-90, 0)) +
    scale_x_longitude() +
    scale_linetype(guide = "none") +
    scale_fill_divergent_discretised(NULL, guide = guide_colorsteps_bottom(20), 
                                     labels = label_one_less) +
    annotate_grid() +
    coord_polar2() +
    facet_wrap(~time_factor, ncol = 4) 
}

raphael <- raphael[order(-r04)] %>% 
  .[, time_factor := forcats::fct_inorder(format(time))]

hgt %>% 
  copy() %>% 
  .[, hgt_za := Anomaly(hgt_z), by = .(lon, lat, month(time))] %>% 
  .[raphael[1:8], on = "time"] %>%
  periodic(lon = c(0, 360)) %>% 
  gplot() +
  tag_facets()

raphael <- raphael[order(r04)] %>% 
  .[, time_factor := forcats::fct_inorder(format(time))]

hgt %>% 
  copy() %>% 
  .[, hgt_za := Anomaly(hgt_z), by = .(lon, lat, month(time))] %>% 
  .[raphael[1:8], on = "time"] %>%
  periodic(lon = c(0, 360)) %>% 
  gplot() +
  tag_facets(tag_pool = letters[-c(1:8)])
```

(ref:raphael-top8-cap) Anomalía zonal de altura geopotencial (m, sombreado) y anomalía mensual de la anomalía zonal de altura geopotencial (m, contornos, valores positivos en línea sólida y valores negativos en línea punteada) en 500 hPa para los 8 meses con mayor y menor valor del índice R04. Los puntos azules indican las ubicaciones usadas en el índice R04.



Finalmente, las Figuras \@ref(fig:raphael-top8-1) y \@ref(fig:raphael-top8-2) muestran  las anomalías mensuales  zonales de la altura geopotencial para los 8 meses con mayor y menor valor del índice R04, respectivamente.
En pocos casos se observa un patrón de onda 3 bien marcado; por ejemplo, en abril de 2003 y noviembre de 1985 (paneles f y g) se observan tres zonas de anomalías positivas cercanas a las ubicaciones utilizadas para calcular R04 y tres zonas de anomalías negativas entre las mismas.
En octubre de 2009 (panel m) se observa lo contrario.
En casos para los cuales el índice es grande y positivo no hay siquiera anomalías positivas en los tres puntos, como en noviembre de 2018 (panel b) y diciembre de 1998 (panel e).
En los meses con menores valores del índice R04, parece haber un patrón de onda tipo PSA algo más definido, sin embargo, tampoco en estos casos hay buena consistencia entre los puntos.

De este análisis se desprende que el índice propuesto por @raphael2004 no sería capaz de representar las características espacio-temporales de la onda 3.

### Descomposición de Fourier

Otra forma de cuantificar la actividad de la onda 3 es, como se mencionó previamente, computando la amplitud obtenida a través de una descomposición de Fourier para este número de onda a lo largo de un círculo de latitud.
Este método también asume que la onda 3 tiene una amplitud constante a lo largo de todo el círculo de latitud y que no presenta dispersión meridional.
Esta metodología no mide exactamente lo mismo que R04, ya que en este caso es sensible a la amplitud de la onda 3 sin importar dónde esté localizada.
Esto puede observarse en la Figura \@ref(fig:fase-histogram), que presenta un histograma de la fase de la onda 3 obtenida a partir de la descomposición de Fourier de la altura geopotencial y que muestra que la localización de la onda varía considerablemente.
También se puede observar el ciclo anual de la fase.

```{r zw}
zw <- hgt %>% 
  .[lat == -50] %>% 
  .[, hgt_za := Anomaly(hgt_z), by = .(lon, lat, month(time))] %>% 
  {
    d <- .
    rbind(d[, FitWave(hgt_z, 1:4), by = time][, type := "zonal"],
          d[, FitWave(hgt_za, 1:4), by = time][, type := "time"])
    
  }

zw3 <- zw[k == 3]
```

```{r fase-histogram, fig.height=4, fig.width=6}
zw %>%
  .[k == 3] %>% 
  .[type == "zonal"] %>% 
  ggplot(aes(phase*180/pi)) +
  geom_histogram(binwidth = 10, boundary = 0, color = "black", fill = "gray70") +
  geom_rug() +
  scale_x_continuous("Fase", labels = LonLabel) +
  scale_y_continuous(NULL) +
  facet_wrap(~ season(time))
```

(ref:fase-histogram-cap) Histograma de la fase de la onda 3 de altura geopotencial en 500 hPa para cada trimestre.

Por otro lado, cabe mencionar que la onda 3 que se obtiene de la descomposición de Fourier aplicada directamente a las medias mensuales de la altura geopotencial no es idéntica a la onda 3 que surge de la descomposición de Fourier aplicada a las anomalías mensuales de altura geopotencial mensual.
Dado que la variable relevante para estudiar la variabilidad, los impactos, los forzantes y las tendencias son las anomalías con respecto a la media, desde ahora se analizarán las anomalías mensuales.

```{r time}
zw <- zw[type == "time"][, type := NULL]
zw3 <- zw[k == 3]
```

```{r zw3-top8, fig.height=4, fig.width=6}
zw3 <- zw3 %>% 
  .[order(-amplitude)] %>% 
  .[, time_factor := forcats::fct_inorder(format(time))]

hgt %>% 
  copy() %>% 
  .[, hgt_za := Anomaly(hgt_z), by = .(lon, lat, month(time))] %>% 
  .[zw3[1:8], on = "time"] %>%
  periodic(lon = c(0, 360)) %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = hgt_z, fill = after_stat(level)),
                    breaks = AnchorBreaks(0, exclude = 0)) +
  geom_contour2(aes(z = hgt_za, linetype = after_stat(factor(-sign(level)))),
                breaks = AnchorBreaks(0, exclude = 0)) +
  # inject(geom_point(data = unique(puntos[, .(lon, lat)]),
  #                   !!!raphael_aes_unused)) +
  geom_qmap() +
  scale_y_latitude(limits = c(-90, 0)) +
  scale_x_longitude() +
  scale_linetype(guide = "none") +
  scale_fill_divergent_discretised(NULL, guide = guide_colorsteps_bottom(20), 
                                   labels = label_one_less) +
  annotate_grid() +
  coord_polar2() +
  facet_wrap(~time_factor, ncol = 4) +
  tag_facets()
```

(ref:zw3-top8-cap) Anomalía zonal de altura geopotencial (m, sombreado) y anomalía mensual de la anomalía zonal de altura geopotencial (m, contornos, valores positivos en línea sólida y valores negativos en línea punteada) en 500 hPa para los 8 meses con mayor y menor valor de la amplitud de la onda 3 de la anomalía mensual de altura geopotencial en 500 hPa

La Figura \@ref(fig:zw3-top8) presenta las anomalías zonales y mensuales de altura geopotencial en 500 hPa, para los 8 meses con mayor amplitud de la onda 3 de las anomalías mensuales de altura geopotencial en 50ºS.
Algunos meses, como septiembre de 1997, abril de 1995 y octubre de 2009 (Fig. \@ref(fig:zw3-top8), paneles c, d y h) tienen máximos y mínimos de intensidad relativamente constante.
En la mayoría, aún cuando se puede observar una onda 3 relativamente clara, su amplitud no es constante a lo largo de todo el hemisferio.
Por ejemplo, en septiembre de 2008 (Fig. \@ref(fig:zw3-top8), panel a), las anomalías zonales tienen mayor intensidad y se encuentran más al sur en la zona del Pacífico y al este de Sudamérica que en el Índico y al sur de Australia.
En cambio, en junio de 1986 (Fig. \@ref(fig:zw3-top8), panel f) las anomalías tienen mayor intensidad en la zona del Pacífico y al sur de Australia y son casi nulas en el Atlántico.

```{r envelope-regr, fig.width=6, fig.height=7}
hgt %>% 
  copy() %>% 
  .[lat > -90] %>% 
  .[, hgt_za := Anomaly(hgt_z), by = .(lon, lat, month(time))] %>% 
  .[, envelope := WaveEnvelope(hgt_za), by = .(lat, time)] %>%  
  .[zw, on = c("time"), allow.cartesian = TRUE] %>%
  .[, FitLm(envelope, amplitude), by = .(lat, lon, k)] %>% 
  rm_intercept() %>%
  periodic(lon = c(0, 360)) %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = estimate, fill = after_stat(level)),
                    breaks = AnchorBreaks(0, exclude = 0)) +
  geom_contour_tanaka(aes(z = estimate),
                      breaks = AnchorBreaks(0, exclude = 0)) +
  # geom_contour2(aes(z = hgt_za, linetype = after_stat(factor(-sign(level)))),
  #               breaks = breaks) +
  geom_qmap() +
  scale_y_latitude(limits = c(-90, 0)) +
  scale_x_longitude() +
  scale_linetype(guide = "none") +
  scale_fill_divergent_discretised(NULL, guide = guide_colorsteps_bottom(20),
                                   labels = label_one_less) +
  annotate_grid() +
  coord_polar2() +
  facet_wrap(~k, ncol = 2)
```

(ref:envelope-regr-cap) Regresión entre la amplitud de las ondas 1 a 4 y la envolvente de todas las ondas zonales de las anomalías de altura geopotencial (sin unidades).

Esta diferencia longitudinal en la amplitud de las ondas puede capturarse a partir de la envolvente de las ondas.
La Figura \@ref(fig:envelope-regr) muestra la regresión entre la amplitud de las ondas 1 a 4 y la envolvente de todas las ondas zonales de las anomalías de altura geopotencial.
Se observa que la amplitud de la onda 1 se asocia a mayor actividad de onda en una banda aproximadamente zonalmente simétrica, indicando que la onda 1 contribuye con las anomalías zonales aproximadamente en todas las longitudes.
Las ondas 2 y 3, en cambio, contribuyen a las anomalías mensuales de altura geopotencial principalmente en el Pacífico sur.
Esto es consistente con lo observado en los casos particulares en la Figura \@ref(fig:zw3-top8) y sugiere que la onda 3 puede presentar variaciones longitudinales que no son capturadas por un modelo sinusoidal puro.

## Conclusiones del capítulo \@ref(onda3)

De este análisis se concluye que ni el modelo de @raphael2004 ni el modelo de Fourier son adecuados para describir las variaciones espacio-temporales de la onda 3 en el hemisferio sur.
Es necesario entonces una metodología que permita describir cambios en la fase, modulación zonal de la amplitud y propagación meridional.
En el próximo capítulo se presenta un índice basado en cEOF que apunta a resolver estos problemas.
