---
knit: purrr::partial(bookdown::render_book, output_format = 'all', preview = TRUE)
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  cache = TRUE,
  out.extra = ""
)
library(eliotesis)
library(metR)
library(data.table)
library(magrittr)
library(kableExtra)
library(ggplot2)
library(tagger)
library(ggperiodic)
library(ggnewscale)
library(gggrid)
library(tidyfast)

library(patchwork)

source(here::here("tesis/scripts/globals.R"))
```


# Modos de variabilidad de la circulación zonalmente asimétrica

Acá iría básicamente [el paper de cEOF](https://github.com/eliocamp/shceof).

## Datos y métodos

```{r read-indices}
enso <- ENSO() %>%
  fread() %>% 
  na.omit() %>%
  .[is.full_season(time)] %>% 
  .[, oni := oni*season_weights(time)] %>% 
  .[, .(oni = mean(oni)), by = .(time = seasonally(time))]

dmi <- DMI() %>%
  fread() %>% 
  na.omit() %>%
  .[is.full_season(time)] %>% 
  .[, dmi := dmi*season_weights(time)] %>% 
  .[, .(dmi = mean(dmi)), by = .(time = seasonally(time))]

sams <- SAM() %>% 
  fread() %>%
  .[is.full_season(time)] %>% 
  .[, estimate := estimate*season_weights(time)] %>% 
  .[, .(estimate = mean(estimate)),
    by = .(lev, term, time = seasonally(time))]

```

```{r read-data}
era5 <- ERA5_geopotential() %>% 
  ReadNetCDF(vars = c(hgt = "z"),
             subset = list(level = list(200, 50),
                           latitude = -90:10,
                           time = main_period)) %>% 
  normalise_coords() %>% 
  na.omit() %>%   # Tengo que omitirlo por la forrada del expver
  .[is.full_season(time)] %>% 
  .[, w := season_weights(time)] %>% 
  .[, .(hgt = mean(hgt*w)), by = .(lev, lon, lat, time = seasonally(time))]
```

```{r compute-psi}
# Scaling magical numbers. (come from psi-test.Rmd)
# Not really important, though.
scaling <- c(add = -2.364646e+06, mult = 3.954828e+13)
psi <- ERA5_vorticity() %>% 
  ReadNetCDF(vars = "vo", subset = list(time = main_period)) %>%
  normalise_coords() %>%
  na.omit() %>% 
  .[is.full_season(time)] %>% 
  .[, lev := 200] %>% 
  .[, w := season_weights(time)] %>% 
  .[, .(vo = mean(vo*w)), by = .(lon, lat, lev, time = seasonally(time))] %>%
  .[, psi := solve_poisson(vo, lon, lat), by = .(lev, time)] %>%
  .[, psi := psi*scaling[2] + scaling[1]] %>%
  .[, psi.z := Anomaly(psi), by = .(time, lev, lat)] 

```

```{r o3}
o3 <- ERA5_TOC() %>% 
  ReadNetCDF(vars = c(toc = "tco3"),
             subset = list(time = main_period)) %>% 
  normalise_coords() %>% 
  na.omit() %>% 
  .[is.full_season(time)] %>% 
  .[lat <= -20] %>% 
  .[, toc := toc/2.1415e-5] %>%    # transform to Dobson Units (https://sacs.aeronomie.be/info/dobson.php)
  .[, w := season_weights(time)] %>% 
  .[, .(toc = mean(toc*w)), by = .(lon, lat, time = seasonally(time))]

o3wave_lats <- c(-75, -45)
```

```{r psa}
psa <- PSA() %>% 
  readRDS()

psa_time <- psa$left[season(time) == "SON"]
```

### Funciones ortogonales complejas (cEOF)

```{r compute-eof-naive}
eof_naive <- era5[lev %in% c(50, 200) & lat %between% c(-90, -20)] %>% 
  .[season(time) == "SON"] %>% 
  # .[, hgt := Anomaly(hgt), by = .(season(time), lon, lat, lev)] %>%
  .[, hgt  := Anomaly(hgt)*sqrt(cos(lat*pi/180)), by = .(time, lev, lat)] %>% 
  .[, .(eof = list(EOF(hgt ~ time | lon + lat, n = 1:4, data = .SD, suffix = "EOF"))), 
    by = lev]

explained <- eof_naive[, eof[[1]]$sdev, by = lev] %>% 
  .[order(lev, EOF)] %>% 
  .[, scales::percent(r2, accuracy = .1)]

```

(ref:eof-naive-cap) Spatial patterns of the four leading EOFs of SON geopotential height zonal anomalies at 50 hPa south of 20º S for the 1979 -- 2019 period (arbitrary units).

```{r eof-naive, fig.width=width_column, fig.height=width_column*1.2}
eof_naive[, eof[[1]]$right, by = lev] %>%
  .[lev == 50] %>% 
  .[ , hgt := hgt/sd(hgt)] %>% 
  periodic(lon = c(0, 360)) %>%
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = hgt, fill = ..level..),
                    breaks = AnchorBreaksSym(0, 1, exclude = 0)) +
  geom_contour_tanaka(aes(z = hgt), breaks = AnchorBreaksSym(0, 1, exclude = 0), 
                      range = c(0.01, 0.2)) +
  
  geom_qmap(size = 0.1) +
  scale_fill_divergent_discretised(NULL, guide = guide_colorsteps_bottom(10))  +
  scale_y_latitude(labels = NULL,
                   minor_breaks = NULL, 
                   limits = c(NA, -20)) +
  scale_x_longitude() +
  annotate_grid() +
  coord_polar2() +
  theme(axis.text = element_blank(), 
        legend.box.spacing = grid::unit(-1, "lines")) +
  facet_wrap(.~EOF, ncol = 2)  +
  tagger::tag_facets("rc")
```

La Figura \@ref(fig:eof-naive) muestra los cuatro EOFs principales de las anomalías zonales de altura geopotencial SON en 50 hPa al sur de 20º S.
Está claro que los dos primeros EOFs representan un único patrón de una onda zonal 1 no estacionario (es decir, la localización de los máximos varía). 
Dado que los EOFs estándar sólo pueden representar patrones estacionarios [@horel1984], ésta onda aparece como un par de EOFs girados en 1/4 de longitud de onda (90º en el espacio de frecuencias).
La amplitud de esta onda 1 podría medirse como $\sqrt{\mathrm{PC1}^2 + \mathrm{PC2}^2}$ y su fase como $\tan^{-1} \left ( \frac{\mathrm{PC2}}{\mathrm{PC1}} \right )$ (donde $\mathrm{PC1}$ y $\mathrm{PC2}$ son las series temporales asociadas a cada EOF).
Lo mismo sucede con el siguiente par de EOFs, los cuales representan un patrón de menor escala. 
Pero esto se fundamenta en la inspección visual cualitativa de estos patrones espaciales y sólo funciona correctamente si ambas fases aparecen claramente divididas en estos dos EOFs, lo cual no está garantizado por construcción. 

Una mejor alternativa para representar ondas que varían en su fase es utilizando el análisis de Funciones Ortogonales Empíricas Complejas (cEOF, por sus siglas en inglés) [@horel1984].
Cada cEOF es un conjunto de patrones espaciales y series temporales con números complejos.
Las componentes real e imaginaria del patrón espacial complejo son la representación de dos patrones espaciales que están desplazados 1/4 de longitud de onda por construcción, de forma similar a EOF1 y EOF2 en la Figura \@ref(fig:eof-naive).
En este trabajo utilizamos los términos 0º cEOF y 90º cEOF para referirnos a cada parte del cEOF. 
El campo real reconstruido por cada cEOF es la combinación lineal de los dos campos espaciales ponderados por sus respectivas series temporales.
Esto es análogo a cómo cualquier onda sinusoidal de fase arbitraria puede construirse mediante la suma de un seno y un coseno de de diferente amplitud pero fase fija
Esto significa que los cEOF representan de forma natural patrones ondulatorios que cambian tanto su ubicación como su amplitud.

Por ejemplo, cuando las anomalías zonales de altura geopotencial se parecen mucho a la fase 0º del cEOF, entonces la serie temporal de esta fase es positiva y la serie temporal de la fase 90º es cercana a cero. 
Del mismo modo, cuando las anomalías zonales de altura geopotencial se parecen a la fase 90º, la serie temporal de ésta es positiva y la serie temporal de la fase de 0º es cercana a cero. 
Cuando las anomalías zonales de altura geopotancial son una onda 1 con los máximos en una localización intermedia, entonces ambas series temporales tienen valores distintos a cero. 

El signo de los EOF tradicionales no está determinado, por lo que se puede multiplicar cada EOF por -1 (tanto su serie temporal como su patrón espacial) y obtener una descripción igualmente válida. 
Este cambio de signo en los números reales corresponde a una rotación en el plano complejo de 0 o $\pi$.
De forma similar, los cEOF no tienen un argumento (entendiendo los números complejos como una magnitud y un argumento) definido, por lo que pueden rotarse en el plano complejo con cualquier ángulo entre 0 y $2\pi$ [@horel1984]; esto es una multiplicación por $\cos(\alpha) + i\sin(\alpha)$ con $\alpha$ cualquier número real entre 0 y $2\pi$.  

El procedimiento para calcular los cEOF es similar al de computar los EOF con la única diferencia de que los datos de entrada primero se convierten en su señal analítica. 
Ésta es un número complejo cuya parte real es la serie original y cuya parte imaginaria son los datos originales desplazados 90º en cada frecuencia espectral, es decir, su transformada de Hilbert.
La transformada de Hilbert suele entenderse en términos de señal variable en el tiempo, pero las ondas zonales son estructuras con forma de onda en el sentido zonal. 
Por esto calculamos la transformada de Hilbert de las anomalías zonales de altura geopotencial variable en cada longitud; es decir, calculada para cada nivel, tiempo y latitud. 
Dado que cada círculo de latitud es un dominio periódico, este procedimiento no sufre efectos de borde.


(ref:hilbert-ejemplo-cap) Ejemplo de cálculo de la función analítica de la señal de anomalías zonales de altura geopotencial. 
Los primeros cuatro paneles muestran las cuatro primeras ondas zonales y el último la señal completa. 
En verde se muestra la señal original y en naranja la transformada de Hilbert. 

```{r hilbert-ejemplo}
gdata <- era5[lev == 50] %>% 
  .[lat %~% -50] %>% 
  .[time == as.Date("1980-04-15")] %>% 
  .[, hgt := hgt - mean(hgt)] %>%
  .[, hgt := FilterWave(hgt, 1:4)]


gdata %>%  
  copy() %>% 
  .[, as.character(c(1:4)) := lapply(1:4, \(x) FilterWave(hgt, x))] %>%
  .[, hgt := NULL] %>% 
  dt_pivot_longer(cols = `1`:`4`, names_to = "onda") %>% 
  .[, value_c := spectral::analyticFunction(value), by = onda] %>% 
  sep_ReIm() %>% 
  ggplot(aes(lon, value_c)) + 
  geom_line(aes(color = part)) +
  
  facet_wrap(~onda, labeller = labeller(onda = AddPreffix("Onda "))) +
  
  gdata %>% 
  copy() %>% 
  .[, hgt := spectral::analyticFunction(hgt)] %>% 
  sep_ReIm() %>% 
  ggplot(aes(lon, hgt)) + 
  geom_line(aes(color = part))  +
  
  plot_layout(ncol = 1, guides = "collect") & 
  
  scale_y_continuous("Z*") &
  scale_x_longitude(ticks = 60) &
  scale_color_brewer(NULL, palette = "Dark2", 
                     labels = c(Real = "Original", 
                                Imaginario = "Transformada de Hilbert"))
```

La Figura \@ref(fig:hilbert-ejemplo) ilustra la señal analítica con las anomalías zonales de geopotencial de otoño de 1980 en 50hPa y 50ºS donde la línea verde es la señal original y la línea naranja es la transformada de Hilbert.
En los primeros paneles la señal está dividida en las ondas zonales 1 a 4 donde se ve con claridad como la transformada de Hilbert es la misma señal pero desplazada 1/4 de longitud de onda. 

```{r compute-ceof}
invisible(
  ERA5_geopotential() %>% 
    ReadNetCDF(vars = c(hgt = "z"),
               subset = list(latitude = -90:10,
                             level = list(200, 50),
                             time = main_period)) %>%
    normalise_coords() %>%
    na.omit() %>% 
    .[is.full_season(time)] %>% 
    .[, w := season_weights(time)] %>% 
    .[, .(hgt = mean(hgt*w)), by = .(lev, lon, lat, time = seasonally(time))] %>%
    .[, season := season(time)] %>%
    {
      ceof <<- .[, .(eof = list(compute_ceof(hgt, lon, lat, lev, time))), by = .(season)]
      ceof_splitted <<-  .[, levs := lev] %>%
        .[, .(eof = list(compute_ceof(hgt, lon, lat, lev, time, n = 1:3))), by = .(season, levs)]
      
    }
)
```

(ref:corr-ceof-splitted-cap) Coeficiente de determinación ($r^2$) entre la magnitud de las series temporales de los cEOF computados de forma separada en 50 y 200 hPa (p-valores menores a 0.01 en negrita).

```{r corr-ceof-splitted}
table <- ceof_splitted[season == "SON", eof[[1]]$left, by = .(lev = levs)] %>%
  copy() %>%
  .[, mag  := abs(hgt)] %>%
  .[, item := paste(lev, cEOF, sep = "_")]

n <- uniqueN(table$time)

table2 <- table %>%
  widyr::pairwise_cor(item, time, mag) %>% 
  setDT() %>%
  .[, p.value := correlation_statistics(correlation, n)$p.value] %>% 
  .[tstrsplit(item1, "_")[[1]] != tstrsplit(item2, "_")[[1]], ] %>%
  .[tstrsplit(item1, "_")[[1]] != 50] %>%
  .[, item1 := tstrsplit(item1, "_")[[2]]] %>%
  .[, item2 := tstrsplit(item2, "_")[[2]]] %>%
  .[, r2 := round(correlation^2, 2)] 

pval <- table2 %>% 
  dcast(item1 ~ item2, value.var = c("p.value"))

table2 <- table2 %>%
  dcast(item1 ~ item2, value.var = c("r2")) %>%
  setnames("item1", "200 hPa") 

if (is_word()) {
  table2 %>% 
    flextable::flextable() %>% 
    flextable::set_caption("(ref:corr-ceof-splitted-cap)")
} else {
  table2 %>%
    kbl2(booktabs = TRUE, caption = "(ref:corr-ceof-splitted-cap)") %>%
    column_spec2(2:4, bold = pval[[.col]] < 0.01) %>%
    add_header_above(c("", "50 hPa" = 3)) %>%
    kable_classic()
}

```

La Tabla \@ref(tab:corr-ceof-splitted) muestra el coeficiente de determinación de la magnitud de las series temporales de los cEOF entre 50 y 200 hPa. 
Existe un alto grado de correlación entre la magnitud de los respectivos cEOF1 y cEOF2 en cada nivel.
Los patrones espaciales de los cEOF de 50 hPa y 200 hPa también son similares (no se muestra).

Tanto la similitud del patrón espacial como la alta correlación temporal de los cEOF calculados a 50 hPa y 200 hPa sugieren que se trata, en gran medida, de modos de variabilidad conjunta.
Esto motiva la decisión de calcular los cEOF en ambos niveles conjuntamente. 
Dada las diferencias de magnitud entre la variabilidad de la altura geopotencial en 50 hPa y 200 hPa, estandarizamos las variables de cada nivel por su desvío estándard. 
El resultado es que cada cEOF tiene un componente espacial que depende de la longitud, la latitud y el nivel, y un componente temporal que sólo depende del tiempo.

Como mencionamos anteriormente, el argumento de los cEOF no está determinado y se le puede sumar una constante real arbitraria. 
Para facilitar la interpretación, definimos el argumento de cada cEOF de modo que o bien el cEOF de 0º o bien el cEOF de 90º esté alineado con variables significativas de nuestro análisis.
Este procedimiento no crea correlaciones espurias, sólo toma una relación existente y la alinea con una fase específica.

Un análisis preliminar mostró que el primer cEOF está estrechamente relacionado con la onda zonal 1 de la Columna Total de Ozono y el segundo cEOF está estrechamente relacionado con el ENSO.
Por lo tanto, elegimos el argumento del cEOF1 de forma que la serie temporal correspondiente al cEOF1 de 0º tenga la máxima correlación con la onda zonal 1 del CTO entre `r combine_words(LatLabel(o3wave_lats))`.
Del mismo modo, elegimos el argumento del cEOF2 de modo que el coeficiente de determinación entre el ONI y el cEOF2 de 0º sea mínimo, lo que también casi maximiza la correlación con el cEOF2 de 90º.


```{r rotate_eofs}
wave1_o3 <- o3 %>% 
  .[lat %between% o3wave_lats] %>% 
  .[, .(toc = weighted.mean(toc, w = cos(lat*pi/180), na.rm = TRUE)), by = .(time, lon)] %>% 
  .[, FitWave(toc, 1), by = .(time)] 

rotations_o3 <- ceof[, eof[[1]]$left, by = season] %>% 
  .[cEOF == "cEOF1"] %>% 
  .[wave1_o3, on = "time"] %>% 
  .[, correlate_complex(hgt, amplitude), by = .(season, cEOF)]


best_rotation_cEOF1 <- rotations_o3[part == "Real"][, .SD[which.max(correlation), .(angle)], by = .(cEOF, season)]

rotations_cEOF2 <-  ceof[, eof[[1]]$left, by = season] %>% 
  .[cEOF == "cEOF2"] %>% 
  enso[., on = "time"] %>% 
  na.omit() %>% 
  .[, correlate_complex(hgt, oni), by = .(season, cEOF)]

best_rotation_cEOF2 <- rotations_cEOF2 %>% 
  dt_pivot_wider(names_from = part, values_from = correlation) %>% 
  .[Imaginario > 0] %>% 
  .[, .SD[which.min(abs(Real)), .(angle)], by = .(cEOF, season)]


rotations <- rbind(best_rotation_cEOF1, best_rotation_cEOF2) %>% 
  dt_nest(season, .key = 'rotation')

rotate_ceof <- function(x, rot) {
  x$left <- x$left[rot, on = 'cEOF'][, hgt := rotate(hgt, angle)][, angle := NULL]
  x$right <- x$right[rot, on = 'cEOF'][, hgt := rotate(hgt, angle)][, angle := NULL]
  
  x
}

ceof <- rbindlist(list(unrotated = ceof,
                       rotated = copy(ceof)[rotations, on = 'season'] %>% 
                         .[,  .(ceof = list(rotate_ceof(eof[[1]], rotation[[1]]))), by = .(season)]),
                  idcol = "rotation")

rotated <- function(x) x[angle == "rotated"]
unrotated <- function(x) x[angle == "unrotated"]
```


```{r check-rotation}
# Check that rotated and unrotated eofs
# predict the same fields (up to floating point errors)
bad_cells <- ceof[, predict(eof[[1]]), by = rotation] %>%
  .[, hgt := as.numeric(Re(hgt))] %>%
  dcast(time + lon + lat + lev ~ rotation, value.var = "hgt") %>%
  .[, dif := rotated - unrotated] %>%
  .[abs(rotated - unrotated)  > 1e-10]

if (nrow(bad_cells) != 0) {
  stop("Rotated and unrotated eofs are not equivalent!")
}

ceof <- ceof[rotation == "rotated"][, rotation := NULL][]
```

```{r save-ceof}
saveRDS(ceof, cEOF())
```


En la sección \@ref(precipitación) mostramos regresiones de precipitación y temperatura asociadas a fases intermedias entre 0º y 90º.
Para esos gráficos, giramos los cEOF en 1/4 de longitud de onda multiplicando las series temporales complejas por $\cos(\pi/4) + i\sin(\pi/4)$ y calculando la regresión sobre esas series temporales rotadas.

Los cEOF con datos de 1979 a 2019. 
Extendimos las series temporales complejas hasta el periodo 1950--1978 proyectando las anomalías zonales mensuales de altura geopotencial normalizadas por nivel al sur de 20ºS sobre los patrones espaciales correspondientes.

Realizamos regresiones lineales para cuantificar la asociación entre los cEOF y otras variables (por ejemplo, altura geopotencial, temperatura, precipitaciones y otras).
Para cada cEOF, calculamos mapas de regresión ajustando un modelo lineal múltiple que incluye tanto la fase de 0º como la de 90º.
Para obtener los coeficientes lineales de una variable $X$ con la fase 0º y 90º de cada cEOF ajustamos la ecuación

\begin{equation}
X(\lambda, \phi, t) = \alpha(\lambda, \phi) \operatorname{cEOF_{0º}} + \beta(\lambda, \phi) \operatorname{cEOF_{90º}} + X_0(\lambda, \phi) + \epsilon(\lambda, \phi, t)
 (\#eq:multiple-regression)
\end{equation}

donde $\lambda$ y $\phi$ son la longitud y la latitud, $t$ es el tiempo, $\alpha$ y $\beta$ son los coeficientes de regresión lineal para las fases de 0º y 90º respectivamente, $X_0$ y $\epsilon$ son la constante y los términos de error respectivamente.

Evaluamos la significancia estadística mediante una prueba t a dos colas y, en el caso de los mapas de regresión, ajustamos los p-valores controlando la Tasa de Descubrimiento Falso [@benjamini1995; @wilks2016] para evitar resultados engañosos derivados del elevado número de regresiones [@walker1914; @katz1991].


## Primavera

Primero evaluamos la primavera en detalle porque es la más interesante y donde las señales son más claras. 


### Descripción de los modos

(ref:ceofs-1-cap) Patrones espaciales de los dos primeros cEOF de las anomalías zonales de altura geopotencial de SON en 50 y 200 hPa para el período 1979--2019. 
El sombreado corresponde a la fase 0º y los contornos, a la fase 90º.
La proporción de varianza explicada por cada modo con respecto a la media zonal está indicada entre paréntesis. 
Las unidades son arbitrarias. 

```{r ceofs-1, fig.width=width_column, fig.height=width_column*1.2}
gdata <- ceof[, eof[[1]]$right, by = .(season)] %>% 
  copy() %>% 
  .[, hgt := hgt/sd(abs(hgt))]

var <- ceof[, eof[[1]]$sdev, by = .(season)] %>%
  .[season == "SON"] %>% 
  .[, setNames(paste0(cEOF, " (", scales::percent(r2, accuracy = 0.1), ")"),
               cEOF)]

gdata %>%
  ggperiodic::periodic(lon = c(0, 360)) %>%
  .[, lev := as.numeric(lev)] %>%   
  .[season == 'SON'] %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = Re(hgt), fill = ..level..),
                    breaks = AnchorBreaksSym(0, 1, exclude = 0)) +
  geom_contour2(aes(z = Im(hgt),  linetype = factor(sign(..level..))),
                breaks = AnchorBreaksSym(0, 1, exclude = 0)) +
  
  scale_fill_divergent_discretised(guide = guide_colorsteps_bottom()) +
  geom_qmap() +
  scale_x_longitude(labels = NULL) +
  scale_y_latitude(labels = NULL,
                   minor_breaks = NULL) +
  scale_linetype_manual(values = c("1" = 1, "-1" = 2),
                        labels = c("1" = "+", "-1" = "-"),
                        guide = "none") +
  facet_grid(lev  ~  cEOF,
             labeller = labeller(lev = lab_lev,
                                 cEOF = var)) +
  theme(legend.title = element_blank()) +
  annotate_grid() +
  coord_polar2() +
  tag_facets(tag = "rc")
```

```{r era_more}
pattern <- ceof[, eof[[1]]$right, by = season] %>%
  sep_ReIm() %>%
  setnames("hgt", "EOF")

era_more <- ERA5_geopotential() %>% 
  ReadNetCDF(vars = c(hgt = "z"),
             subset = list(latitude = range(pattern$lat),
                           level = list(200, 50),
                           time = c(NA_character_, main_period[2]))) %>% 
  normalise_coords() %>%
  na.omit() %>% 
  .[is.full_season(time)] %>% 
  .[, w := season_weights(time)] %>% 
  .[, .(hgt = mean(hgt*w)), by = .(lev, lon, lat, time = seasonally(time))] %>%
  .[, hgt := hgt - mean(hgt), by= .(lev, lat, time)] %>% 
  .[, season := season(time)] %>%
  .[, hgt := hgt/sd(hgt), by = .(lev, season)] %>%
  .[pattern, on = .NATURAL, allow.cartesian = TRUE] %>%
  .[, .(hgt = weighted.mean(hgt*EOF, w = cos(lat*pi/180))),  by = .(part, cEOF, time, season)] 

```

(ref:extended-series-cap) Series temporales de los dos primeros cEOF de las anomalías zonales de altura geopotencial de SON en 50 y 200 hPa para el período 1979--2019. 
El cEOF1 (fila a) y cEOF2 (fila b) separados en la fase 0º (columna 1) y la fase 90º (columna 2). 
Las líneas oscuras muestran la tendencia lineal de todo el período.
Las líneas negras horizontales y verticales muestran el valor medio y el rango de cada serie, respectivamente.
La proporción de varianza explicada por cada modo con respecto a la media zonal está indicada entre paréntesis. 
Las unidades son arbitrarias. 

```{r extended-series, fig.height=3, fig.width = 5}
# Check that the extended index coincides with the
# original index.
cors <- era_more %>%
  .[sep_ReIm(ceof[, eof[[1]]$left, by = season]), on = c("time", "cEOF", "part")] %>%
  na.omit() %>%
  .[, cor(hgt, i.hgt), by = .(cEOF, part, season)]

if (any(cors$V1 < 0.90)) {
  stop("Extended indices didn't work!")
}

trends <- era_more %>%
  .[, FitLm(hgt, time, se = TRUE), by = .(part, cEOF, season(time))] %>%
  rm_intercept() %>%
  .[, p_val := Pvaluate(estimate, std.error, df)] %>%
  .[, p_report := report_p(p_val)]

# era_less <-   ceof %>%
#   .[, eof[[1]]$left, by = season] %>%
#   sep_ReIm(hgt) %>%
#   .[season == "SON"] %>% 
#   .[, hgt := as.numeric(scale(hgt)), by = .(part, cEOF)] 

era_more %>%
  copy() %>% 
  .[season(time) == 'SON'] %>% 
  .[, ref := year(time) > 1979] %>% 
  # .[, hgt := scale(hgt, center = FALSE, scale = sd(hgt[ref])), by = .(part, cEOF)] %>%
  ggplot(aes(time, hgt*1e3)) +
  # Zero line + rangeframe
  geom_hline(data = ~.x[, mean(hgt)*1e3, by  = .(cEOF, part)], 
             aes(yintercept = V1), linewidth = 0.2, color = "gray30") +
  geom_segment(data = ~.x[, .(min = min(hgt)*1e3,
                              max = max(hgt)*1e3), by  = .(cEOF, part)],
               aes(x = structure(Inf, class = "Date"),
                   xend = structure(Inf, class = "Date"),
                   y = min,
                   yend = max), linewidth = 0.2, color = "gray30") +
  geom_line(aes(color = part)) +
  # geom_line(data = ceof[, eof[[1]]$left] %>% 
  #             sep_ReIm()) + 
  geom_point(aes(color = part), size = 0.25) +
  # geom_line(data = era_less) +
  scale_alpha_manual(values = c(1, 0.2)) +
  geom_smooth(method = "lm", aes(color = stage(part, after_scale = scales::muted(color))),
              show.legend = FALSE, linewidth = 0.8) +
  scale_x_date(NULL, 
               breaks = seq(as.Date("1950-01-01"),
                            as.Date("2020-01-01"), by = "10 years"),
               labels = function(x) JumpBy(format(x, "%Y"), 2, fill = " "),
               minor_breaks = seq(as.Date("1950-01-01"),
                                  as.Date("2020-01-01"), by = "2 years")) +
  scale_y_continuous(NULL, minor_breaks = NULL, sec.axis = dup_axis()) +
  scale_color_brewer(NULL, palette = "Dark2", 
                     guide = guide_legend(override.aes = list(fill = NA))) +
  facet_grid(cEOF ~ part, labeller = labeller(part = lab_cplx, cEOF = var)) +
  theme(panel.spacing = grid::unit(1.5, "lines"),
        strip.placement = "outside", 
        panel.grid.minor.x = element_line(linetype = 2))  +
  tag_facets("rc") +
  panel_background() 
```

Las Figuras \@ref(fig:ceofs-1) y \@ref(fig:extended-series) muestran las partes espacial y temporal de los dos primeros modos cEOF de las anomalías zonales de la altura geopotencial en 50 hPa y 200 hPa, calculados conjuntamente en ambos niveles.
El primer modo (cEOF1) explica el `r scales::percent(ceof[season == "SON", eof[[1]]$sdev, by = .(season)][cEOF == "cEOF1"]$r2, 1)` de la varianza de las anomalías zonales, mientras que el segundo modo (cEOF2) explica una fracción menor (`r scales::percent(ceof[season == "SON", eof[[1]]$sdev, by = .(season)][cEOF == "cEOF2"]$r2, 1)`).
En los patrones espaciales (Fig. \@ref(fig:ceofs-1)), las fases de 0º y 90º están en cuadratura por construcción, de modo que cada cEOF describe un único patrón ondulatorio cuya amplitud y posición (es decir, fase) está controlada por la magnitud y fase de su serie temporal.

El cEOF1 (Fig. \@ref(fig:ceofs-1) columna 1) es un patrón de onda 1 con amplitud máxima en latitudes altas.
En 50 hPa el cEOF1 0º tiene el máximo de la onda 1 en 150ºE y en 200 hPa, el máximo se sitúa en torno a 175ºE indicando un desplazamiento hacia el oeste con la altura.
El cEOF2 (Fig. \@ref(fig:eof-naive) columna 2) muestra también una estructura de onda zonal con amplitud máxima en latitudes altas, pero con escalas espaciales más cortas.
En particular, la estructura dominante a ambos niveles es una onda 3 pero con mayor amplitud en el sector del océano Pacífico.
No hay cambio de fase aparente con la altura, pero la amplitud del patrón se reduce considerablemente en la estratosfera, lo que es coherente con el hecho de que el cEOF2 calculado por separado para 200 hPa explica un más de varianza que el cEOF2 calculado por separado para 50 hPa (`r scales::percent(ceof_splitted[season == "SON", eof[[1]]$sdev, by = levs][cEOF == "cEOF2", r2][1])` vs. `r scales::percent(ceof_splitted[season == "SON", eof[[1]]$sdev, by = levs][cEOF == "cEOF2", r2][2])`, respectivamente).
Esto sugiere que este modo barotrópico representa principalmente la variabilidad troposférica.

```{r ceof_mean_r2}
mean <- era5 %>% 
  copy() %>% 
  .[, hgt := metR::Anomaly(hgt),
    by  = .(lat, time, lev)] %>% 
  .[, hgt := hgt/sd(hgt), by = .(season(time), lev)] %>%
  # .[, hgt := hgt*sqrt(cos(lat*pi/180))] %>% 
  .[, .(hgt_m = mean(hgt)), by = .(lev, lon, lat, season(time))]

ceof_mean_r2 <- ceof[, eof[[1]]$right, by = season] %>% 
  sep_ReIm(format = "wider") %>%
  .[, hgt := NULL] %>% 
  .[] %>% 
  .[mean, on = .NATURAL] %>% 
  .[lat <= -20] %>% 
  .[, FitLm(hgt_m, Real, Imaginario, r2 = TRUE), by = .(season, cEOF)] %>% 
  .[, .SD[1], by = .(cEOF, season)]
```


```{r cross-correlations}
# ceof[, eof[[1]]$left, by = season] %>% 
#   sep_ReIm() %>% 
#   .[, item := interaction(cEOF, part, sep = "\n")] %>% 
#   .[, widyr::pairwise_cor(.SD, item, time, hgt), by = season] %>% 
#   as.data.table() %>% 
#   .[] %>% 
#   ggplot(aes(item1, item2)) +
#   geom_tile(aes(fill = correlation^2)) +
#   scale_fill_divergent() +
#   facet_wrap(~season, ncol = 2) 
```

No existe una correlación significativa entre las series temporales de los cEOFs.
Ambos cEOF muestran variabilidad interanual pero no muestran evidencia de variabilidad decadal (Fig. \@ref(fig:extended-series)).
Debido a que los campos que entran en el algoritmo de cEOF son anomalías con respecto a la media zonal en lugar de la media temporal, las series temporales de los cEOF tienen media temporal no nula.
Sin embargo, la media temporal de cEOF2 es casi cero, lo que indica que sólo cEOF1 incluye variabilidad que se proyecta significativamente sobre el campo anómalo zonal medio.
Esto es coherente con el hecho de que el campo medio zonalmente anómalo de la altura geopotencial es muy similar al cEOF1 ($r^2$ = `r scales::percent(ceof_mean_r2[season == 'SON'][["r.squared"]][1])`) y no similar al cEOF2 ($r^2$ = `r scales::percent(ceof_mean_r2[season == 'SON'][["r.squared"]][2])`).

Es evidente una tendencia positiva significativa en la fase 0º de cEOF1 (Fig. \@ref(fig:extended-series)a.1, valor p `r trends[part == "Real" & cEOF == "cEOF1" & season == "SON"]$p_report`), mientras que no hay tendencia significativa en ninguna de las fases de cEOF2.
La tendencia positiva del cEOF1 de 0º se traduce en una tendencia positiva en la magnitud del cEOF1, pero no en un cambio sistemático en la fase (no se muestra).
Este cambio a largo plazo indica un aumento de la magnitud de la onda zonal 1 de latitudes altas. 



### Relación con otras variables de la atmósfera

#### Geopotencial

En la sección anterior mostramos los patrones espaciales de los cEOF obtenidos a partir de las anomalías zonales de altura geopotencial.
En esta sección calculamos campos de regresión de las series temporales de los cEOF con las anomalías temporales de altura geopotencial para describir la influencia de los cEOF en las anomalías temporales.

```{r compute-regression}
era5 <- ERA5_temperature() %>% 
  ReadNetCDF(vars = c("t"), 
             subset = list(level = list(50, 200),
                           time = main_period)) %>% 
  normalise_coords() %>% 
  na.omit() %>% 
  .[is.full_season(time)] %>% 
  .[, w := season_weights(time)] %>% 
  .[, .(t = mean(t*w)), by = .(lev, lon, lat, time = seasonally(time))] %>% 
  .[era5, on = .NATURAL]

regr <- ceof[, eof[[1]]$left, by = .(season)] %>%
  .[season == "SON"] %>%
  sep_ReIm(format = "wide") %>%
  .[, hgt := NULL] %>%
  .[, `:=`(Real = as.numeric(scale(Real)), Imaginario = as.numeric(scale(Imaginario))),
    by = .(season, cEOF)] %>%
  .[melt(era5, id.vars = c("time", "lon", "lat", "lev")), on = "time", allow.cartesian = TRUE] %>%
  .[, FitLm(value, Imaginario, Real, se = TRUE),
    by = .(lev, lon, lat, variable, cEOF)] %>%
  rm_intercept() %>%
  .[, term := factor_ReIm(term)]
```

```{r plot_regr}
plot_regr <- function(data, which_cEOF, which_levs, which_var) {
  data <- data %>%
    .[ cEOF %in% which_cEOF] %>%
    .[variable == which_var]
  
  var_title <- switch(which_var,
                      hgt = "Geopotential height",
                      t = "Temperature")
  
  
  if (length(which_cEOF) > 1) {
    stop("More than one ceof")
  }
  
  if ("lev" %in% colnames(data)) {
    data <- data[lev %in% which_levs]
  } else {
    data[, lev := which_levs]
  }
  
  data[lat <= -20] %>%
    # .[term == "I" & lev == 50] %>%
    .[, p.value := Pvaluate(estimate, std.error, df, "fdr"), by = .(lev, cEOF, term)] %>%
    .[, lev := as.numeric(lev)] %>% 
    periodic(lon = c(0, 360)) %>%
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = estimate), breaks = AnchorBreaksSym(exclude = 0),
                      global.breaks = FALSE) +
    geom_contour_tanaka(aes(z = estimate), 
                        breaks = AnchorBreaksSym(exclude = 0), global.breaks = FALSE) +
    scale_fill_divergent(var_title, breaks = AnchorBreaksSym(0, exclude = 0),
                         guide = guide_colorsteps_bottom(15)) +
    geom_contour_pval(aes(z = p.value)) +
    
    geom_qmap() +
    
    scale_x_longitude(labels = NULL) +
    scale_y_latitude(labels = NULL,
                     minor_breaks = NULL) +
    theme(panel.grid.major.y = element_line(color = "gray60", size = 0.1)) +
    facet_grid(lev ~ term, 
               labeller = labeller(lev = lab_lev, term = lab_cplx)) +
    annotate_grid() +
    coord_polar2() +
    tag_facets("rc") +
    labs(title = which_cEOF) +
    theme(plot.title = element_text(hjust = 0.5, size = theme_get()$strip.text$size))
}

# From latex2exp::TeX('Geopotential height ($m^2s^{-1}$)')
mpg <- expression('Altura geopotencial ('*m^{2}*s^{phantom() - 1}*')')
```

(ref:eof1-regr-gh-cap) Regresión de anomalías de temperatura geopotencial en SON  ($m^2s^{-1}$) con la fase 0º (columna 1) y 90º (columna 2) para cEOF1 en 50 hPa (fila a) y 200 hPa (fila b) para el período 1979 -- 2019. 
Estos coeficientes fueron obtenidos a partir de una regresión múltiple incluyendo ambas fases. 
`r pval_contours()`.

```{r eof1-regr-gh, fig.height=1.2*width_column, fig.width=width_column, dependson="plot_regr"}
plot_regr(regr , "cEOF1", c(200, 50), "hgt") +
  scale_fill_divergent(mpg,
                       breaks = AnchorBreaksSym(0, exclude = 0),
                       guide = guide_colorsteps_bottom(15, even.steps = TRUE), 
                       limits = c(-2000, 2000)) 
```

La Figura \@ref(fig:eof1-regr-gh) muestra mapas de regresión de anomalías de altura geopotencial en SON sobre el cEOF1.
En 50 hPa (Fig. \@ref(fig:eof1-regr-gh) fila a), la fase 0º del cEOF1 está asociada a un centro de anomalías positivas sobre la Antártida con su centro sobre el Mar de Ross.
Por otro lado, el centro de anomalías positivas asociado a la fase 90º está corrido hacia Antártida Oriental y tiene un patrón de onda 1 más evidente. 

En 200 hPa (Fig. \@ref(fig:eof1-regr-gh) fila b) la fase 0º del cEOF1 muestra un único centro de anomalías positivas que abarca la Antártida Occidental rodeado de anomalías opuestas en latitudes más bajas, con su centro desplazado ligeramente hacia el este en comparación con las anomalías de niveles superiores.
La fase de 90º muestra un patrón mucho más simétrico zonalmente que se asemeja al patrón de anomalías características de la fase negativa del SAM [@fogt2020].
En ambas fases las anomalías negativas en latitudes bajas son débiles y no son estadísticamente significativas

Por lo tanto, la magnitud y la fase del cEOF1 están asociadas a la magnitud y la fase de una onda zonal principalmente en la estratosfera.

(ref:eof2-regr-gh-cap) Igual que la Figura \@ref(fig:eof1-regr-gh) pero para el cEOF2.

```{r eof2-regr-gh, fig.height=1.3*width_column, fig.width=width_column, dependson="plot_regr"}
plot_regr(regr, "cEOF2", c(200, 50), "hgt") +
  scale_fill_divergent(mpg, 
                       breaks = AnchorBreaksSym(0, 200, exclude = 0),
                       guide = guide_colorsteps_bottom(15, even.steps = TRUE), 
                       limits = c(-1000, 1000))
```

La Figura \@ref(fig:eof2-regr-gh) muestra los mapas de regresión de las anomalías de altura geopotencial con el cEOF2.
Tanto en 50 como en 200 hPa se observa un patrón de onda 3 similares a los de la Figura \@ref(fig:ceofs-1) columna 2. 
Las anomalías de regresión asociadas con la fase 0º del cEOF2 están desfasadas 1/4 de longitud de onda con respecto a las asociadas con la fase 90º.
Todos los campos tienen una onda zonal dominante 3 limitada al hemisferio occidental, sobre los océanos Pacífico y Atlántico.

En 50 hPa (Fig. \@ref(fig:eof2-regr-gh) fila a) también se ve un monopolo sobre el polo con signo negativo asociado a la fase 0º y signo positivo asociado a la fase 90º. 
Este monopolo podría indicar fortalecimiento del vórtice polar asociado a valores positivos del 0º cEOF2 y debilitamiento asociado a valores negativos del 0º cEOF2.
Sin embargo, estas anomalías no son estadísticamente significativas, indicando que su magnitud es baja en comparación a la variabilidad estratosférica y que esta característica no debe sobreinterpretarse.

En 200 hPa (Fig. \@ref(fig:eof2-regr-gh) fila b) el tren de ondas es robusto y los centros son estadísticamente significativos, con anomalías insignificantes por fuera de este patrón. 
La localización de las anomalías no varía en la vertical, lo cual indica que se trata de un modo barotrópico equivalente. 

El cEOF2 representa entonces un tren de ondas barotrópico equivalente muy similar al de los Patrones PSA [@mo2001].
Comparando la localización de la anomalía positiva cerca de 90ºW en la columna 2 de la Figura \@ref(fig:eof2-regr-gh) con las Figuras 1.a y b de @mo2001, el mapa de regresión de la fase 0º podría identificarse con el PSA2, mientras que la fase 90º se asemeja al PSA1. 
Estudiaremos la relación entre el cEOF2 y el PSA con más detalle en la Sección \@ref(psa).


#### Temperatura y Ozono

(ref:eof1-regr-t-cap) Igual que la Figura \@ref(fig:eof1-regr-gh) pero para la temperatura del aire (K).

```{r eof1-regr-t, dependson="plot_regr", fig.height=1.3*width_column, fig.width=width_column}
plot_regr(regr, "cEOF1", c(200, 50), "t") +
  scale_fill_divergent("Temperatura del aire (K)", breaks = AnchorBreaksSym(0, exclude = 0),
                       guide = guide_colorsteps_bottom(15, even.steps = TRUE), 
                       limits = c(-4.5, 4.5))
```

```{r t}
t <- ERA5_temperature() %>% 
  ReadNetCDF(vars = c("t"), 
             subset = list(latitude = o3wave_lats,
                           time = main_period)) %>% 
  normalise_coords() %>% 
  na.omit() %>% 
  .[is.full_season(time)] %>%  
  .[, time := as.Date(time)] %>% 
  .[, .(t = weighted.mean(t, cos(lat*pi/180))), by = .(lon, lev, time)]

o3_temp <- ERA5_ozone() %>% 
  ReadNetCDF(vars = c("o3"), 
             subset = list(latitude = o3wave_lats,
                           time = main_period)) %>% 
  normalise_coords() %>% 
  na.omit() %>% 
  .[is.full_season(time)] %>%  
  .[, time := as.Date(time)] %>% 
  .[, .(o3 = weighted.mean(o3, cos(lat*pi/180))), by = .(lon, lev, time)]

t <- t[o3_temp, on = .NATURAL]
rm(o3_temp)

t <- t %>% 
  .[, w := season_weights(time)] %>% 
  .[, .(t   = mean(t*w),
        o3  = mean(o3*w)), by = .(lev, lon, time = seasonally(time))]
```

(ref:t-vertical-cap) Regresión de anomalías zonales de temperatura (sombrado, Kelvin) y razón de mezcla de ozono (contornos, valores negeativos en línea punteada, etiquetas en partes por mil millón en masa) promediados entre `r combine_words(LatLabel(o3wave_lats))` en SON con la fase de 0º (a) y de 90º (b) del cEOF1 para el período 1979 -- 2019.

```{r t-vertical, fig.height=2.5, fig.width=width_column}
t %>% 
  melt(id.vars = c("lev", "time", "lon")) %>% 
  .[, value := Anomaly(value), by = .(time, lev, variable)] %>%
  .[ceof[, cut(eof[[1]], 1)$left, by = season], on = "time"] %>% 
  .[season(time) == "SON"] %>% 
  sep_ReIm(format = "wider") %>% 
  .[, ":="(Real = as.numeric(scale(Real)), Imaginario = as.numeric(scale(Imaginario))), by = .(cEOF)] %>% 
  .[, FitLm(value, Real, Imaginario, se = TRUE), by = .(lev, lon, variable)] %>% 
  rm_intercept() %>% 
  .[, term := factor_ReIm(term)] %>% 
  ggplot(aes(lon, lev)) +
  geom_contour_fill(data = ~.x[variable == "t"],
                    aes(z = estimate, fill = ..level..),
                    breaks = AnchorBreaksSym(0, binwidth = 0.25, exclude = 0, sym = TRUE)) +
  geom_contour_tanaka(data = ~.x[variable == "t"],
                      aes(z = estimate),
                      breaks = AnchorBreaksSym(0, binwidth = 0.25, exclude = 0, sym = TRUE)) +
  geom_contour2(data = ~.x[variable == "o3"],
                aes(z = estimate, linetype = factor(-sign(..level..))),
                breaks = AnchorBreaksSym(0, exclude = 0)) +
  geom_text_contour(data = ~.x[variable == "o3"],
                    aes(z = estimate*1e9, label = signif(..level.., 2)),
                    size = 2,
                    skip = 1, stroke = 0.15, stroke.colour = "white",
                    breaks = AnchorBreaksSym(0, exclude = 0)) +
  
  scale_fill_divergent_discretised("Temperatura del Aire (K)",
                                   # limits = c(-2.25, 2.25),
                                   labels = label_one_less,
                                   guide = guide_colorsteps_bottom(15, show.limits = TRUE)) +
  scale_y_level(minor_breaks= NULL,
                sec.axis = sa_height_axis(breaks = seq(0, 50, by = 10),
                                          labels = function(x) paste0("~", x, " km"))) +
  scale_linetype(guide = "none") +
  scale_x_longitude(ticks = 60) +
  facet_grid(~term, labeller = labeller(term = lab_cplx)) +
  axis_labs_smol() +
  coord_cartesian(clip = "off") +
  tag_facets(tag = "panel") 
```

También se evaluó la señal de la variabilidad de los cEOF en la temperatura del aire.
La Figura \@ref(fig:eof1-regr-t) muestra los mapas de regresión de las anomalías de la temperatura del aire en 50 hPa y 200 hPa con el cEOF1.
La distribución de los coeficientes de regresión de la temperatura en 50 hPa y en 200 hPa refleja los mapas de regresión de la altura geopotencial en 50 hPa (Fig. \@ref(fig:eof1-regr-gh)).
En ambos niveles, la fase de 0º está asociada a anomalías positivas sobre el Polo Sur con su centro desplazado ligeramente hacia 150ºE (Fig. \@ref(fig:eof1-regr-t) columna 1).
Por otro lado, los mapas de regresión con la fase de 90º muestran un patrón de onda 1 más claro con su máximo alrededor de los 60ºE.

La Figura \@ref(fig:t-vertical) muestra la distribución vertical de los coeficientes de regresión del cEOF1 con las anomalías zonales de la temperatura del aire y de la razón de mezcla de ozono promediadas entre `r combine_words(LatLabel(o3wave_lats))`.
Las anomalías zonales de temperatura asociadas al cEOF1 muestran un claro patrón de onda 1 tanto para la fase de 0º como para la de 90º en toda la atmósfera por encima de 250 hPa con una inversión de signo por encima de 10 hPa.
Como resultado del balance hidrostático, este es el nivel en el que la anomalía geopotencial tiene máxima amplitud (no mostrado).

Los valores máximos de la regresión con el ozono coinciden con los valores mínimos de temperatura por encima de 10 hPa y con los máximos por debajo de 10 hPa (Fig. \@ref(fig:t-vertical)).
Por tanto, la onda zonal 1 de ozono está correlacionada negativamente con la onda zonal 1 de temperatura en la estratosfera superior, y positivamente en la estratosfera baja.
Este cambio de fase es observado en las anomalías de ozono forzadas por ondas planetarias que alcanzan la estratosfera.
En la estratosfera superior, dominada por procesos fotoquímicos, las temperaturas frías inhiben la destrucción de ozono, explicando el comportamiento opuesto para ambas variables, tal y como se dilucidó con modelos químicos dinámicos [@hartmann1979; @wirth1993; @smith1995].
Por otro lado, en la estratosfera baja, dominada por la advección, las anomalías de ozono están desfasadas 1/4 de longitud de onda con el transporte horizontal y vertical, que a su vez están desfasados 1/4 de longitud de onda con las anomalías de temperatura, resultando anomalías del mismo signo para la respuesta de ambas variables [@hartmann1979; @wirth1993; @smith1995].

```{r o3_regr}
temp <- ceof[, eof[[1]]$left, by = season] %>% 
  .[cEOF == "cEOF1"] %>% 
  copy() %>% 
  sep_ReIm(format = "wider") %>% 
  .[, `:=`(Real = as.numeric(scale(Real)), 
           Imaginario = as.numeric(scale(Imaginario))),
    by = .(cEOF, season)]

o3_mean <- o3 %>% 
  .[, .(toc = mean(toc)), by = .(lon, lat, season(time))] %>% 
  .[, toc_z := Anomaly(toc), by = .(lat, season)]
o3_regr <- temp %>% 
  o3[., on = "time", allow.cartesian = TRUE] %>% 
  .[, FitLm(toc, Real, Imaginario, se = TRUE), by = .(lon, lat, cEOF, season)] %>% 
  rm_intercept() %>% 
  .[, term := factor_ReIm(term)]
```

(ref:o3-regr-cap) Regresión de las anomalías de Columna Total de Ozono (CTO, sombreado, unidades Dobson) con la fase 0º (a) y 90º (b) del cEOF1 para el período 1979 -- 2019. 
En contornos, la anomalía zonal media de de CTO (contornos negativos en líneas punteadas, unidades Dobson). 
`r pval_contours()`.

```{r o3-regr, fig.height=3, fig.width = width_column}
o3_regr %>% 
  .[season == "SON"] %>% 
  periodic(lon = c(0, 360)) %>% 
  .[, p.value := Pvaluate(estimate, std.error, df, "fdr"), by = .(cEOF, term)] %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = estimate, fill = ..level..),
                    breaks = AnchorBreaksSym(0, exclude = 0)) +
  geom_contour_tanaka(aes(z = estimate), breaks = AnchorBreaksSym(0, exclude = 0)) +
  geom_contour2(data = periodic(o3_mean[season == "SON"], lon = c(0, 360)),
                aes(z = toc_z, linetype = factor(-sign(..level..))), 
                breaks = AnchorBreaksSym(0, exclude = 0), 
                bins = 5) +
  
  geom_contour_pval(aes(z = p.value)) +
  annotate("segment", 
           y  = o3wave_lats,
           yend = o3wave_lats,
           x = 0,
           xend = 360,
           size = 0.3, alpha = 0.8
  ) +
  geom_qmap() +
  scale_fill_divergent_discretised("Columna Total de Ozono (DU)", 
                                   limits = c(-30, 30), 
                                   breaks = AnchorBreaksSym(exclude = 0, binwidth = 5)(c(-30, 30)),
                                   guide = guide_colorsteps_bottom(15)) + 
  scale_x_longitude(labels = NULL) +
  scale_y_latitude(labels = NULL,
                   minor_breaks = NULL) +
  scale_linetype(guide = "none") +
  annotate_grid() +
  coord_polar2() +
  facet_grid(cEOF~term, labeller = labeller(term = lab_cplx)) +
  tag_facets("panel")

```


(ref:wave1-o3-cap) Relación entre la amplitud y la fase de la onda zonal 1 de la Columna Total de Ozono promediada entre `r combine_words(LatLabel(o3wave_lats))` y la amplitud y la fase del cEOF1 para SON en el período 1979 -- 2019.

```{r wave1-o3, fig.width=width_column, fig.height=width_column*.7, include = FALSE}
wave1_o3 <- o3 %>% 
  .[lat %between% o3wave_lats] %>% 
  .[, .(toc = mean(toc, na.rm = TRUE)), by = .(time, lon)] %>% 
  .[, FitWave(toc, 1), by = .(time)] 

temp <- ceof[, eof[[1]]$left, by = season] %>% 
  .[cEOF == "cEOF1"] %>% 
  .[wave1_o3, on = "time"]

wave1_cor <- rbind(temp %>%
                     .[, correlate(amplitude, Mod(hgt)), by = season] %>% 
                     .[, with := "amplitude"],
                   
                   temp %>%
                     .[, correlate(phase, Arg(hgt)), by = season] %>% 
                     .[, with := "phase"])

wave_correlation <- temp %>% 
  na.omit() %>% 
  .[, .(cor = mean(cos(phase - Arg(hgt))),
        n = .N), by = season] %>% 
  .[, correlation_statistics(cor, n), by = season]

temp %>%
  # .[season == "SON"] %>% 
  ggplot(aes(Mod(hgt), amplitude)) +
  scale_x_continuous("EOF1 Amplitude") +
  scale_y_continuous("O3 Wave-1\nAmplitude") +
  
  temp %>%
  # .[season == "SON"] %>% 
  copy() %>%
  na.omit() %>%
  # qwrap(phase = c(0, 2*pi) ~ c(-pi, pi)) %>%
  ggplot(aes(Arg(hgt), phase)) +
  scale_x_continuous("EOF1 Phase",
                     breaks = seq(-pi, pi, by = 15*pi/180),
                     labels = function(x) paste0(round(x*180/pi, 5), "º")) +
  scale_y_continuous("O3 Wave-1\nPhase",
                     breaks = seq(-pi, pi, by = 30*pi/180),
                     labels = function(x) paste0(round(x*180/pi, 5), "º"))  +
  plot_layout(ncol  = 1) &
  geom_point()  &
  geom_smooth(method = "lm") & 
  facet_wrap(~season)
```

Los mapas de regresión de las anomalías de CTO con el cEOF1 (Fig. \@ref(fig:o3-regr)) muestran patrones de onda zonal 1 asociados a ambas fases del cEOF1.
La posición climatológica del mínimo de ozono durante la primavera (agujero de ozono) no está centrada sobre el Polo Sur, sino que está desplazada hacia el mar de Weddell [p.e., @grytsai2011]; este desplazamiento se traduce en una onda 1 de la CTO. 
Así, el campo de regresión de la fase 0º del cEOF1 (Fig. \@ref(fig:o3-regr)a) coincide con la posición climatológica de esta onda 1 del agujero de ozono, mientras que el campo para la fase 90º está defasado en 90º cEOF1.
La correlación temporal entre la amplitude de la onda 1 de CTO y la amplitud del cEOF1 es `r wave1_cor[with == "amplitude" & season == "SON"]$text`, mientras que la correlación entre sus fases es `r wave1_cor[with == "phase" & season == "SON"]$text`.
La correlación entre las dos ondas es `r wave_correlation[season == "SON"]$text`.
En consecuencia, el cEOF1 está fuertemente relacionado con la variabilidad del ozono SH.

### Fuentes de variabilidad tropicales

```{r sst}
sst <- ERSST() %>%
  fread() %>% 
  .[time %between% as.Date(main_period)] %>% 
  .[is.full_season(time)] %>% 
  normalise_coords() %>%
  .[, w := season_weights(time)] %>% 
  .[, .(t = mean(t*w)), by = .(lon, lat, time = seasonally(time))]
```

```{r cmap}
cmap <- CMAP() %>% 
  fread() %>% 
  .[lat %between% c(-60, 10) & time %between% as.Date(main_period)] %>% 
  normalise_coords() %>%
  na.omit() %>% 
  .[, w := season_weights(time)] %>% 
  .[, .(pp = mean(pp*w)), by = .(lon, lat, time = seasonally(time))]
```

```{r t2m}
t2m <- ERA5_T2M() %>% 
  ReadNetCDF(subset = list(time = main_period)) %>% 
  normalise_coords() %>%
  na.omit() %>% 
  .[, w := season_weights(time)] %>% 
  .[, .(t2m = mean(t2m*w)), by = .(lon, lat, time = seasonally(time))]
```


```{r rotated-regressions}
rotate_reim <- function(real, imaginary, angle = 0) {
  z <- complex(real = real, imaginary = imaginary)
  z <- rotate(z, angle)
  list(real = Re(z),
       imaginary = Im(z))
}

angles_regr <- -c(0, 45, 90, 45+90)*pi/180
angles_labs <- setNames(c("0º", "45º", "90º", "135º"), angles_regr*180/pi)

hgt850 <- ERA5_geopotential() %>% 
  ReadNetCDF(vars = c(hgt = "z"), 
             subset = list(level = 850,
                           time = main_period)) %>% 
  normalise_coords() %>%
  na.omit() %>% 
  .[is.full_season(time)] %>%  
  .[, w := season_weights(time)] %>% 
  .[, .(hgt = mean(hgt*w)), by = .(lon, lat, time = seasonally(time))]

hgt850 <- ceof[, eof[[1]]$left, by = .(season)] %>%
  .[season == "SON"] %>%
  sep_ReIm(format = "wide") %>%
  .[, hgt := NULL] %>%
  .[, `:=`(Real = as.numeric(scale(Real)), Imaginario = as.numeric(scale(Imaginario))),
    by = .(season, cEOF)] %>%
  .[hgt850, on = "time", allow.cartesian = TRUE]

hgt850_regr <- lapply(angles_regr, function(a) {
  hgt850 %>% 
    copy() %>% 
    .[, c("Real", "Imaginario") := rotate_reim(Real, Imaginario, a)] %>% 
    .[, `:=`(Real = Real/sd(Real), Imaginario = Imaginario/sd(Imaginario)), 
      by = .(season, cEOF)] %>%
    .[, FitLm(hgt, Imaginario, Real, se = TRUE), by = .(lon, lat, cEOF, season)] %>%
    rm_intercept() %>%
    .[term == "Real"] %>% 
    .[, term := factor_ReIm(term)] %>% 
    .[, angle := a*180/pi]
}) %>% 
  rbindlist()

sst_for_regression <- ceof[, eof[[1]]$left, by = .(season)] %>%
  # .[cEOF == "cEOF2"] %>% 
  copy() %>% 
  sep_ReIm(format = "wide") %>%
  .[, hgt := NULL] %>%
  .[sst, on = "time", allow.cartesian = TRUE] %>%
  na.omit() 

sst_regr <- lapply(angles_regr, function(a) {
  sst_for_regression %>% 
    copy() %>% 
    .[, c("Real", "Imaginario") := rotate_reim(Real, Imaginario, a)] %>% 
    .[, `:=`(Real = Real/sd(Real), Imaginario = Imaginario/sd(Imaginario)), 
      by = .(season, cEOF)] %>%
    .[, FitLm(t, Imaginario, Real, se = TRUE), by = .(lon, lat, cEOF, season)] %>%
    rm_intercept() %>%
    .[term == "Real"] %>% 
    .[, term := factor_ReIm(term)] %>% 
    .[, angle := a*180/pi]
}) %>% 
  rbindlist()

psi_for_regression <-  ceof[, eof[[1]]$left, by = .(season)] %>%
  # .[cEOF == "cEOF2"] %>% 
  copy() %>% 
  sep_ReIm(format = "wide") %>%
  .[, hgt := NULL] %>%
  .[psi, on = "time", allow.cartesian = TRUE] %>%
  .[lev == 200]

psi_regr <- lapply(angles_regr, function(a) {
  psi_for_regression %>% 
    copy() %>% 
    .[, c("Real", "Imaginario") := rotate_reim(Real, Imaginario, a)] %>% 
    .[, `:=`(Real = Real/sd(Real), Imaginario = Imaginario/sd(Imaginario)), 
      by = .(season, cEOF)] %>%
    .[, FitLm(psi.z, Real, Imaginario, se = TRUE),by = .(lon, lat, lev, cEOF, season)] %>%
    rm_intercept() %>%
    .[term == "Real"] %>% 
    .[, psi.z := Anomaly(estimate), by = .(cEOF, season, lev, lat)] %>%
    .[, c("fx", "fy") := WaveFlux2(psi.z, lon, lat, p = 200), 
      by = .(lev, cEOF, season, term)] %>%
    .[, term := factor_ReIm(term)] %>% 
    .[, angle := a*180/pi]
}) %>% 
  rbindlist()

pp_for_regression <- ceof[, eof[[1]]$left, by = season] %>%
  # .[cEOF == "cEOF2"] %>% 
  copy() %>% 
  sep_ReIm(format = "wide") %>%
  .[, hgt := NULL] %>%
  .[cmap, on = "time", allow.cartesian = TRUE] %>%
  na.omit() %>% 
  .[, pp := pp/sd(pp), by = .(lon, lat)]

pp_regr <- lapply(angles_regr, function(a) {
  pp_for_regression %>% 
    copy() %>% 
    .[, c("Real", "Imaginario") := rotate_reim(Real, Imaginario, a)] %>% 
    .[, `:=`(Real = Real/sd(Real), Imaginario = Imaginario/sd(Imaginario)), 
      by = .(season, cEOF)] %>%
    .[, FitLm(pp, Imaginario, Real, se = TRUE),
      by = .(lon, lat, cEOF, season)] %>%
    .[term == "Real"] %>% 
    rm_intercept() %>% 
    .[, term := factor_ReIm(term)] %>% 
    .[, angle := a*180/pi]
  
}) %>%
  rbindlist()

t2m_for_regression <-  ceof[, eof[[1]]$left, by = season] %>%
  # .[cEOF == "cEOF2"] %>% 
  copy() %>% 
  sep_ReIm(format = "wide") %>%
  .[, hgt := NULL] %>%
  .[t2m, on = "time", allow.cartesian = TRUE] %>%
  na.omit()

t2m_regr <- lapply(angles_regr, function(a) {
  t2m_for_regression %>% 
    copy() %>% 
    .[, c("Real", "Imaginario") := rotate_reim(Real, Imaginario, a)] %>% 
    .[, `:=`(Real = Real/sd(Real), Imaginario = Imaginario/sd(Imaginario)), 
      by = .(season, cEOF)] %>%
    .[, FitLm(t2m, Imaginario, Real, se = TRUE),
      by = .(lon, lat, cEOF, season)] %>%
    .[term == "Real"] %>% 
    rm_intercept() %>% 
    .[, term := factor_ReIm(term)] %>% 
    .[, angle := a*180/pi]
  
}) %>%
  rbindlist()
```

```{r enso_cor}
enso_cor <- ceof[, eof[[1]]$left, by = .(season)] %>%
  sep_ReIm() %>%
  .[, hgt := scale(hgt), by = .(cEOF, part, season)] %>%
  enso[., on = "time"] %>%
  na.omit() %>%
  .[, correlate(hgt, oni), by = .(cEOF, part, season)]
```

```{r dmi_cor}
dmi_cor <-  ceof[, eof[[1]]$left, by = .(season)] %>%
  sep_ReIm() %>%
  .[, hgt := scale(hgt), by = .(cEOF, part, season)] %>%
  dmi[., on = "time"] %>%
  na.omit() %>%
  .[, correlate(hgt, dmi), by = .(cEOF, part, season)]
```

```{r parciales}
gdata <- ceof[, eof[[1]]$left, by = .(season)] %>%
  sep_ReIm() %>%
  enso[., on = "time"] %>%
  dmi[., on = "time"] %>%
  .[, `:=`(hgt = as.numeric(scale(hgt)),
           dmi = as.numeric(scale(dmi)),
           oni = as.numeric(scale(oni))), by = .(cEOF, part, season)] %>%
    na.omit()

oni_dmi_parciales <- gdata %>%
  .[season == "SON" & cEOF == "cEOF2"] %>%
  .[, partial_cor(hgt, dmi, oni), by = .(cEOF, part, season)] %>% 
  .[, text := paste0(scales::number(partial_correlation, accuracy = 0.01), " (p-valor ", 
                     report_p(p.value), ")")]
```


(ref:psi-sst-explained-variance-cap) Varianza de la SST (fila a) las anomalías zonales de función corriente (fila b) explicada por el cEOF1 (columna 1) el cEOF2 (columna 2).

```{r psi-sst-explained-variance, fig.width = width_column, fig.height = .7*width_column}
breaks <- seq(.1, 1, by = .1)
rbind(sst = sst_regr,
      psi = psi_regr[, -c("psi.z", "fx", "fy", "lev")], idcol = "variable") %>% 
  .[angle == 0] %>%
  .[is.finite(r.squared)] %>% 
  .[, variable := factor(variable,
                         levels = c("sst", "psi"), 
                         labels = c("SST", "Función corriente"))] %>% 
  periodic(lon = c(0, 360)) %>%
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = r.squared, fill = ..level..), breaks = breaks) +
  geom_contour_tanaka(aes(z = r.squared), breaks = breaks) +
  # geom_text_contour(aes(z = r.squared,
  #                       label = ..level..),
  #                   breaks = seq(0.4, 1, by = 0.2), size = 2,
  #                   skip = 0, stroke = 0.15, stroke.colour = "white") +
  geom_qmap() +
  scale_fill_divergent_discretised(name = "Varianza explicada", midpoint = 0,
                                   labels = scales::percent_format(),
                                   guide = guide_colorsteps_bottom(15, show.limits = TRUE)) +
  
  scale_x_continuous(NULL, expand = c(0, 0),
                     breaks = seq(0, 360, by = 60),
                     labels = LonLabel) +
  scale_y_continuous(NULL, breaks  = seq(-90, 0, by = 30), expand = c(0, 0)) +
  
  facet_grid(variable ~ cEOF) +
  # coord_quickmap(ylim = c(NA, 10)) +
  coord_sf(ylim = c(NA, 10),
           default_crs = "+proj=longlat +lon_wrap=180 +over") + 
  theme(legend.box = "horizontal",
        legend.text = element_text(size = rel(0.7)), 
        legend.box.spacing = grid::unit(0, "lines") ) +
  tag_facets("rc") 
```


Para evaluar si la variabilidad de los cEOF analizados está relacionada con fuentes de variabilidad tropicales calculamos la regresión de distintas fases de los cEOFs con las anomalías de SST y con las anomalías zonales de función corriente a 200 hPa. 
La Figura \@ref(fig:psi-sst-explained-variance) muestra la varianza de cada variable explicada por cada cEOF. 

El cEOF1 sólo explica una proporción importante de la varianza de la función corriente al sur de 60º, sugiriendo que no está asociado con la variabilidad tropical. 

El cEOF2, en cambio, explica una gran proporción de la variabilidad tropical tanto de la SST como de la función corriente. 
Este modo comparte más de un 50% de la varianza con las SST en el Pacífico central (sugiriendo el impacto del ENSO). 
En cuanto a la función corriente, en el Pacífico explica más del 50% de la varianza en la región del cambio de fecha y sobre Indonesia. 
También explica gran parte de la varianza en al oeste y al este de la Península Antártica, llegando a más del 80% sobre el mar de Amundsen. 

```{r plot_sst_psi}
plot_sst_psi <- function(sst_regr, psi_regr, min.mag = 0.002) {
  angles_labs <- sst_regr$angle %>% 
    unique() %>% 
    abs() %>% 
    setNames(paste0(., "º"), .)
    
  variables <- c("SST", "Streamfunction")
  
  sst_gdata <- sst_regr %>%
    # .[cEOF == "cEOF2"] %>% 
    .[lat %between% c(-90, 10)] %>%
    .[, p_val := Pvaluate(estimate, std.error, df, "fdr"), 
      by = .(cEOF, term, angle)] %>%
    .[, angle := as.numeric(angle)] %>% 
    .[, var := factor("SST", levels = variables)] %>% 
    periodic(lon = c(0, 360))
  
  # browser()
  rsst <- max(range(abs(sst_gdata[!is.na(cEOF), ]$estimate), na.rm = TRUE))
  breaks_sst <- AnchorBreaks(0, bins = 20, exclude = 0)(c(-rsst, rsst))
  
  
  stream_gdata <- psi_regr %>%
    # .[cEOF == "cEOF2"] %>% 
    # .[abs(estimate) > 1, estimate := NA] %>%
    .[lat %between% c(-90, 10)] %>%
    .[, p_val := Pvaluate(estimate, std.error, df, "fdr"), by = .(cEOF, angle, term)] %>%
    .[, angle := as.numeric(angle)] %>% 
    .[, var := factor("Streamfunction", levels = variables)] %>% 
    periodic(lon = c(0, 360)) 
  
  rstream <- max(range(abs(psi_regr$estimate), 
                       na.rm = TRUE))*1e-7
  breaks_stream <- AnchorBreaksSym(0, bins = 20, exclude = 0)(c(-rstream, rstream))
  
  #from latex2exp::TeX("Streamfunction ($m^2s^{-1}\\times 1e^{-7}$)")
  psi_expr <- expression('Streamfunction ('*m^{2}*s^{phantom() - 1} %*% 1*e^{phantom() - 7}*')')
  # browser()
  stream_gdata %>% 
    ggplot(aes(lon, lat)) +
    
    geom_contour_fill(data = sst_gdata,
                      aes(z = estimate, fill = ..level..),
                      breaks = breaks_sst) +
    geom_contour_pval(data = sst_gdata, aes(z = p_val)) +
    
    scale_fill_divergent_discretised("SST (K)",
                                     labels = label_one_less,
                                     guide = guide_colorsteps_bottom(width = 15,
                                                                     show.limits = FALSE, ticks = TRUE,
                                                                     order = 1)) +
    new_scale_fill() +
    geom_contour_fill(aes(z = estimate*1e-7, fill = ..level..),
                      breaks = breaks_stream) +
    geom_contour_pval(aes(z = p_val)) +
    # geom_streamline(aes(dx = fx, dy = fy), min.L = 3, L = 10,
    #                 size = 0.1, res = 2, nx = 22, ny = 12, 
    #                 arrow.angle = 14, arrow.length = 0.2) +
    geom_vector(aes(dx = fx, dy = fy), skip = 3, min.mag = min.mag, 
                size = 0.1) +
    scale_mag(max_size = .5, guide = "none") +
    geom_qmap() +
    scale_fill_divergent_discretised(psi_expr, 
                                     labels = label_one_less,
                                     low = scales::muted("red"),
                                     high = scales::muted("blue"),
                                     guide = guide_colorsteps_bottom(15, show.limits = FALSE,
                                                                     order = 99)) +
    grid_panel(grob_spoke, aes(angle = -angle, var = "SST"), inherit.aes = FALSE) +
    scale_x_continuous(NULL, expand = c(0, 0), 
                       breaks = seq(0, 360, by = 60),
                       labels = LonLabel) +
    
    scale_y_continuous(NULL, breaks  = seq(-90, 0, by = 30), expand = c(0, 0)) +
    
    facet_grid(angle ~ var, labeller = labeller(angle = angles_labs)) +
    # coord_quickmap(ylim = c(NA, 10)) +
    coord_sf(ylim = c(-89, 10), expand = FALSE,
             # crs = "+proj=longlat +pm=180 +over",
             default_crs = "+proj=longlat +lon_wrap=180 +over") + 
    theme(legend.box = "vertical",
          legend.text = element_text(size = rel(0.7)), 
          legend.spacing = grid::unit(0, "lines"),
          legend.box.spacing = grid::unit(0, "lines") ) +
    tag_facets("rc") 
}
```



(ref:sst-psi-2-cap) Regresión de (columan 1) SST (K) y (columna 2) anomalías zonales de función corriente ($m^2/s\times10^-7$) y sus vectores de acción de onda con diferentes fases del cEOF2 (indicado con la flecha) en el período 1979 -- 2019. 
`r pval_contours()`.

```{r sst-psi-2, fig.width = 5, fig.height=6, dependson="plot_sst_psi"}
plot_sst_psi(sst_regr[cEOF == "cEOF2" & season == "SON"], psi_regr[cEOF == "cEOF2" & season == "SON"]) 
```

La Figura \@ref(fig:sst-psi-2) muestra los mapas de regresión de las anomalías de la temperatura de la superficie del mar (SST) y de la función de corriente a 200 hPa sobre los cEOF2 normalizados.
Además de los mapas de regresión para las fases de 0º y 90º, incluimos las regresiones correspondientes para dos direcciones intermedias (correspondientes a 45º y 135º).

La fase de 90º (fila b) está asociada a fuertes anomalías positivas de la SST en el Pacífico central y oriental y a anomalías negativas en una zona que atraviesa el norte de Australia, Nueva Zelanda y la Zona de Convergencia del Pacífico Sur (SPCZ) (Fig. \@ref(fig:sst-psi-2).b1).
Este patrón es muy similar al patrón del ENSO positivo canónico [@bamston1997].
De hecho, existe una correlación significativa y muy alta entre el ONI y la serie temporal de la fase de 90º del cEOF2 (`r enso_cor[cEOF == "cEOF2" & part == "Imaginario" & season == "SON"]$text`).
Además del patrón similar al ENSO del Pacífico, también hay anomalías positivas en el océano Índico occidental y valores negativos en el océano Índico oriental, lo que se asemeja a un dipolo del índico en su fase positiva [@saji1999].
Consistentemente, la correlación entre la fase de 90º del cEOF2 y el DMI es `r dmi_cor[cEOF == "cEOF2" & part == "Imaginario" & season == "SON"]$text`.
Sin embargo, la correlación parcial es de `r oni_dmi_parciales[cEOF == "cEOF2" & part == "Imaginario" & season == "SON" & term == "dmi"]$text`, indicando que el DMI explica poca varianza de la fase de 90º del cEOF2 por sí mismo. 
Esto puede observarse en la Figura \@ref(fig:euler), donde se ilustra la partición de la varianza de la fase de 90º del cEOF2, el DMI y el ONI. 
El DMI aporta, independientemente, sólo un 4.3% de la varianza mientras que el ONI aporta un 23.8% por sí mismo. 

(ref:euler-cap) Diagrama de Euler con las proporción de la varianza de cada serie explicada por cada solapamiento (p.e. la región común entre DMI y 90º cEOF2 es la varianza en común entre esas variables). 

```{r euler, fig.width=width_column, fig.height=width_column}
with(gdata[season == "SON" & cEOF == "cEOF2" & part == "Imaginario"],
     euler_correlation(hgt, oni, dmi, c("90º cEOF2", "ONI", "DMI")))
```

La fase de 90º del cEOF2 está asociado a fuertes anomalías de la función corriente que emanan de los trópicos (Fig. \@ref(fig:sst-psi-2).b2), tanto del sector del Pacífico Central como del Océano Índico.
Esta respuesta atmosférica es consistente con el efecto combinado del ENSO y el DMI sobre los extratropicos: con anomalías de la SST que inducen convección tropical anómala que a su vez excita ondas de Rossby que se propagan meridionalmente hacia latitudes más altas [@mo2000; @cai2011; @nuncio2015].

Sin embargo, el cEOF2 no está asociado a los mismos patrones de anomalía de las SST tropicales en todas sus fases. 
Los paneles d1 y d2 de la Figura \@ref(fig:sst-psi-2) muestran que la fase de 0º del cEOF2 no está asociada a ninguna anomalía significativa de las SST ni de la función corriente en los trópicos.
Tampoco la correlación entre el 0º cEOF2 y ENSO es significativa (`r enso_cor[cEOF == "cEOF2" & part == "Real" & season == "SON"]$text`).
Las filas a y c de la Fig.\@ref(fig:sst-psi-2) muestran que las fases intermedias siguen asociadas con anomalías significativas de la SST sobre el Océano Pacífico, pero en lugares ligeramente diferentes.
La fase de 135º está asociada a anomalías de la SST en el Pacífico central (Fig.\@ref(fig:sst-psi-2)a.1), mientras que la fase de 45º está asociada a anomalías de la SST que corresponden aproximadamente a los "sabores" de ENSO del Pacífico central y del Pacífico oriental, respectivamente (Fig.\@ref(fig:sst-psi-2)c.1) [@kao2009].
Ambas fases también están asociadas a trenes de onda que se generan cerca de Australia y se propagan hacia los extratrópicos, aunque menos intensos que los asociados a la fase de 90º.

(ref:enso-phase-cap) Valores del ONI en SON y la fase del cEOF2 en el período 1979 -- 2019. 
Los años en los cuales la magnitud del cEOF2 es mayor o menor que la mediana se muestran como diamantes naranja o círculos verdes respectivamente. 
La línea negra representa el ajuste ONI \~ sen(fase) computado por cuadrados mínimos pesados por la magnitud del cEOF2. 

```{r enso-phase, fig.width = width_column, fig.height=3}
gdata <- ceof[, eof[[1]]$left, by = .(season)] %>%
  .[cEOF == "cEOF2"] %>% 
  # .[, hgt := Anomaly(hgt)] %>% 
  .[, arg := Arg(hgt)] %>%
  .[, mag := Mod(hgt)] %>%
  .[enso, on = "time"] %>%
  na.omit() %>%
  .[, q := ifelse(mag >= quantile(mag, 0.5), "|cEOF2| > 50%", "|cEOF2| < 50%"), by = season]

cor_enso_mag <- gdata[, correlate(mag, abs(oni)), by = season]

cor_enso_spearman <- gdata[, cor.test(mag, abs(oni), method = "spearman")[c("estimate", "p.value")], by = season]

cor_enso_mag_outlier <- gdata[oni < 1.5][, correlate(mag, abs(oni)), by = season]

cor_enso_mag_quantile <- gdata[mag >= quantile(mag, 0.5)] %>% 
  .[oni < 1.5] %>% 
  .[, correlate(mag, abs(oni)), by = season]

cos_model <- gdata %>% 
  .[, .(model = list(lm(oni ~ I(sin(arg)) - 1, weights = mag))), by = season]

equation <- bquote(ONI  * {phantom() == phantom()} * .(signif(cos_model[season == 'SON', coef(model[[1]])[1]], 2)) * sin(Phase) )


gdata %>% 
  .[season == "SON"] %>% 
  ggplot(aes(arg, oni)) +
  geom_hline(yintercept = c(-0.5, 0, 0.5), size = 0.2, color = "gray50") +
  geom_vline(xintercept = 0, size = 0.2, color = "gray50") +
  # annotate(shadowtext:::GeomShadowText,
  #          label = c("- Real", "- Imaginario", "+ Real", "+ Imaginario", "- Real"),
  #          color = "gray60", bg.colour = "white", bg.r = 0.2,
  #          size = 3,
  #          y = -Inf, x = c(-pi, -pi/2, 0, pi/2, pi), angle = 90, hjust = 0) +
  
  geom_smooth(data = ~qwrap(.x, arg = c(-pi, pi) ~ c(-2*pi, 2*pi)),
              method = "lm", aes(weight = mag),
              formula = y ~ I(sin(x)) -1,
              se = FALSE, color = "black", size = 0.5) +
  geom_point(aes(color = q,
                 shape  = q),
             size = 3) +
  ggrepel::geom_text_repel(data = ~.x[order(-oni)][1:3],
                           aes(label = year(time)), size = 2) +
  
  scale_color_brewer("", palette = "Dark2") +
  scale_shape_manual("", values = c(20, 18)) +
  scale_y_continuous("ONI") +
  scale_x_continuous("Phase",
                     breaks = seq(-pi, pi, by = 45*pi/180),
                     labels = function(x) paste0(round(x*180/pi, 5), "º")) +
  coord_cartesian(xlim = c(-pi, pi)) +
  labs(subtitle = equation) +
  panel_background()
```

Para explorar la relación entre el forzante tropical y las fases del cEOF2 con más profundidad, la Figura \@ref(fig:enso-phase) muestra la relación entre el ONI y la fase del cEOF2 para cada SON entre 1979 y 2019, destacando los años en los que la magnitud del cEOF2 está por encima de la mediana.
En los años con ONI positivo, la fase cEOF2 se sitúa mayoritariamente en torno a la fase de 90º; en los años con ONI negativo, en torno a la fase de -90º.
En las estaciones con ENSO neutro, la fase del cEOF2 es mucho más variable.
La línea negra de la Figura \@ref(fig:enso-phase) es un ajuste sinusoidal de la relación entre el ONI y la fase del cEOF2.
El $r^2$ correspondiente al ajuste es `r signif(summary(cos_model[season == "SON", model[[1]]])$r.squared, 2)`, estadísticamente significativo con p-valor `r report_p(coef(summary(cos_model[season == "SON", model[[1]]]))[4])`, lo que indica una relación casi sinusoidal entre estas dos variables.

La correlación entre la magnitud absoluta del ONI y la amplitud del cEOF2 es `r cor_enso_mag[season == "SON"]$text`.
Sin embargo, esta relación está determinada principalmente por los tres años con los eventos ENSO más intensos del periodo (`r combine_words(year(gdata[season == "SON"][order(-oni)][1:3]$time))`), los cuales coinciden con los tres años con la magnitud CEOF2 más intensa (no se muestra).
Si se eliminan esos años, la correlación deja de ser significativa (`r cor_enso_mag_outlier[season == "SON"]$text`).
Además, incluso cuando utilizando todos los años, la correlación de Spearman -que es robusta frente a los valores atípicos- tampoco es significativa (`r signif(cor_enso_spearman[season == "SON"]$estimate, 2)`, p-valor `r report_p(cor_enso_spearman[season == "SON"]$p.value)`).
Por lo tanto, aunque la localización de las anomalías tropicales de la SST parece tener un efecto en la definición de la fase del cEOF2, la relación entre la magnitud del cEOF2 y el ONI sigue siendo incierta y podría ser sólo evidente en eventos ENSO muy fuertes, que son escasos en el registro observacional histórico.

Concluimos que el tren de ondas representado por el cEOF2 es tanto parte de la variabilidad interna de la atmósfera extratropical como forzado por las SST tropicales.
En el primer caso, el tren de ondas tiene poca preferencia de fase.
Sin embargo, cuando el cEOF2 es excitado por la variabilidad de la SST tropical, tiende a permanecer fijo en la fase de 90º.

(ref:sst-psi-1-cap) Iugal que la Figura \@ref(fig:sst-psi-2) pero para el cEOF1. 

```{r sst-psi-1, fig.width = 5, fig.height=6, dependson="plot_sst_psi"}
plot_sst_psi(sst_regr[cEOF == "cEOF1"], psi_regr[cEOF == "cEOF1"], min.mag = 0.0005)
```

La Figura \@ref(fig:sst-psi-1) muestra las mismas regresiones que la Figura  \@ref(fig:sst-psi-2) pero para el cEOF1. 
Como anticipó la Figura \@ref(fig:psi-sst-explained-variance), el cEOF1 no está asociado a anomalías significativas de SST ni de función corriente en los trópicos. 
En vez de eso, las fases de 0º y 90º están asociadas a flujos de actividad de onda que se propagan zonalmente en los extratrópicos cerca de de 60ºS, excepto por un flujo hacia el ecuador desde la costa de la Antártida alrededor de 150ºE en la fase de 0º.
Esto sugiere que la variabilidad de cEOF1 está impulsada principalmente por la variabilidad interna de los extratrópicos.

### Impactos en superficie

```{r pp-t2m-r2, fig.width=5, fig.height=3}
breaks <- seq(.1, 1, by = .1)

rbind(`Precipitación` = pp_regr,
      `Temperatura a 2 metros` = t2m_regr, idcol = "var") %>% 
  .[angle == 0] %>% 
  .[is.finite(r.squared)] %>% 
  .[, var := factor(var)] %>% 
  .[season == "SON"] %>% 
  # .[cEOF == "cEOF2"] %>% 
  periodic(lon = c(0, 360)) %>%
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = r.squared, fill = ..level..), breaks = breaks) +
  geom_contour_tanaka(aes(z = r.squared), breaks = breaks) +
  # geom_text_contour(aes(z = r.squared, 
  #                       label = ifelse(..level.. > 0.2, scales::percent(..level..), NA)), 
  #                   breaks = breaks, size = 2,
  #                   skip = 1, stroke = 0.15, stroke.colour = "white") +
  geom_qmap() +
  scale_fill_divergent_discretised(name = "Varianza explicada", midpoint = 0,
                                   labels = scales::percent_format(),
                                   guide = guide_colorsteps_bottom(15, show.limits = TRUE)) +
  
  scale_x_continuous(NULL, expand = c(0, 0),
                     breaks = seq(0, 360, by = 60),
                     labels = LonLabel) +
  scale_y_continuous(NULL, breaks  = seq(-90, 0, by = 30), expand = c(0, 0)) +
  
  facet_grid(var ~ cEOF) +
  # coord_quickmap(ylim = c(NA, 10)) +
  coord_sf(ylim = c(NA, 10),
           default_crs = "+proj=longlat +lon_wrap=180 +over") + 
  theme(legend.box = "horizontal",
        legend.text = element_text(size = rel(0.7)), 
        legend.box.spacing = grid::unit(0, "lines") ) +
  tag_facets("rc") 
```

(ref:pp-t2m-r2-cap) Igual que la Figura \@ref(fig:psi-sst-explained-variance) pero para Temperatura a 2 metros y precipitación. 

La Figura \@ref(fig:pp-t2m-r2) muestra la varianza de la temperatura a 2 metros y de la precipitación explicada por cada cEOF.
  
La varianza explicada por el cEOF1 para ambas variables es muy baja en la mayoría de las regiones, excepto para el extremo norte de la Península Antártica, el norte del Mar de Weddell y la costa del Mar de Ross (Fig.\@ref(fig:pp-t2m-r2)a.1).

Por otro lado, la varianza explicada cEOF2 es superior al 50% en algunas regiones para ambas variables (Fig. \@ref(fig:pp-t2m-r2) columna 2).
Para la temperatura de 2 metros, hay valores altos en el Pacífico tropical y en la región que forma un arco entre Nueva Zelanda y el Atlántico Sur. 
Sobre los continentes, hay valores moderados de alrededor del 30% de varianza explicada en el sur de Australia, el sur de Sudamérica y la Península Antártica.
En cuanto a las precipitaciones, los valores son elevados en los trópicos.
En latitudes más altas, se observan valores moderados sobre el este de Australia y algunas regiones del sur de Sudamérica.

```{r add_continents}
continents <- list(africa  = list(lon = c(0, 60),
                                  lat = c(-40, 0)),
                   oceania = list(lon = c(100, 180),
                                  lat = c(-50, -13)),
                   america = list(lon = c(265, 325),
                                  lat = c(-60, -10)))

add_continent <- function(dt) {
  dt[, continent := fcase(lon %between% continents$africa$lon &
                            lat %between% continents$africa$lat, "africa",
                          lon %between% continents$oceania$lon &
                            lat %between% continents$oceania$lat, "oceania",
                          lon %between% continents$america$lon &
                            lat %between% continents$america$lat, "america")] %>%
    .[, continent := factor(continent, levels = c("africa", "oceania", "america"), ordered = TRUE)] %>%
    .[]
}

crop_continent <- function(continent) {
  bbox <- c(xmin = min(continents[[continent]]$lon), 
            xmax = max(continents[[continent]]$lon),
            ymin = min(continents[[continent]]$lat),
            ymax = max(continents[[continent]]$lat))
  
  function(data) {
    s2 <- sf::sf_use_s2(FALSE)
    on.exit(sf::sf_use_s2(s2))
    data <- sf::st_crop(data, bbox)
    data$continent <- continent
    data
  }
}
```

```{r plot_pp}
plot_pp <- function(pp_regr, t2m_regr, hgt850_regr) {
  lats <- c(-55, 10)
  breaks_pp <- AnchorBreaksSym(exclude = 0)(c(-.9, .9))
  
  variables <- c("Precipitación", "Temperatura a 2 metros")
  pp_regr <- pp_regr %>% 
    copy() %>% 
    .[, var := factor(variables[1], levels = variables)] %>% 
    .[, p.value := Pvaluate(estimate, std.error, df, "none"), 
      by = .(cEOF, angle)] %>% 
    .[, angle := as.numeric(angle)] %>% 
    periodic(lon = c(0, 360)) 
  
  t2m_regr <- t2m_regr %>% 
    copy() %>% 
    .[, var := factor(variables[2], levels = variables)] %>% 
    .[, p.value := Pvaluate(estimate, std.error, df, "none"), by = .(cEOF, angle)] %>% 
    .[, angle := as.numeric(angle)] %>% 
    periodic(lon = c(0, 360))
  
  hgt850_regr <- copy(hgt850_regr) %>% 
    .[, angle := as.numeric(angle)] %>% 
    periodic(lon = c(0, 360))
  
  pp_regr %>%
    # .[lat %between% lats] %>% 
    
    
    ggplot(aes(lon, lat)) +
    
    geom_contour_fill(aes(z = estimate, fill = ..level..),
                      breaks = breaks_pp) +
    geom_contour_tanaka(aes(z = estimate), breaks = breaks_pp) +
    
    
    scale_fill_divergent_discretised("Precipitación (correlación)", 
                                     # limits = c(-1, 1),
                                     low = "#8E521C",
                                     high = "#00665E",
                                     guide = guide_colorsteps_bottom(15, order = 99)) +
    geom_contour_pval(aes(z = p.value)) +
    
    new_scale_fill() +
    
    
    geom_contour_fill(data = t2m_regr, 
                      aes(z = estimate, fill = ..level..), 
                      breaks = AnchorBreaksSym(exclude = 0)) +
    geom_contour_tanaka(data = t2m_regr, 
                        aes(z = estimate),
                        breaks = AnchorBreaksSym(exclude = 0)) +
    
    scale_fill_divergent_discretised("Temperatura",
                                     # limits = c(-1, 1),
                                     guide = guide_colorsteps_bottom(15, order = 1)) +
    geom_contour_pval(data = t2m_regr, aes(z = p.value)) +
    
    geom_contour2(data = copy(hgt850_regr)[, var := factor(variables[2], levels = variables)], 
                  aes(z = estimate, linetype = factor(-sign(..level..))), 
                  size = 0.2, breaks = AnchorBreaksSym(0, exclude = 0)) +
    
    geom_qmap() +
    
    grid_panel(grob_spoke, aes(angle = -angle, var = factor("SST", levels = variables)), inherit.aes = FALSE) +
    
    scale_x_continuous("", expand = c(0, 0), breaks = seq(0, 360, by = 30), 
                       labels = LonLabel) +
    scale_y_continuous("", expand = c(0, 0), breaks = seq(-90, 0, by = 15), 
                       labels = LatLabel) +
    # scale_y_latitude(ticks = 15, labels = LatLabel) +
    scale_linetype_discrete(guide = "none") +
    facet_grid(angle ~ var, labeller = labeller(angle = angles_labs)) +
    theme(axis.text = element_text(size = 6)) +
    tag_facets("rc") +
    coord_sf(ylim = c(NA, 10),
             default_crs = "+proj=longlat +over") +
    theme(panel.spacing = grid::unit(1, "lines")) +
    theme(legend.box = "vertical",
          legend.spacing = grid::unit(0, "lines"),
          legend.text = element_text(size = rel(0.7)), 
          legend.box.spacing = grid::unit(0, "lines") ) 
  
}
```

```{r boxes}
sesa <- list(lon = c(300, 315),
             lat = c(-35, -22))
box_australia <- data.frame(cEOF = "cEOF2", 
                            lon = c(130, 155),
                            lat = c(-40, -15))
```

Dado que el cEOF1 tiene una señal relativamente débil en las variables de superficie exploradas, sólo nos centraremos en la influencia del cEOF2.
En la Figura \@ref(fig:pp-temp-2) se muestran mapas de regresión de las anomalías de temperatura a 2 metros (columna 1) y precipitación (columna 2) sobre diferentes fases del cEOF2 normalizado.

(ref:pp-temp-2-cap) Regresión de la temperatura de 2 metros (K, sombreado) y la altura geopotencial de 850 hPa (m, contornos) (columna 1), y la precipitación (correlación, columna 2) sobre diferentes fases de cEOF2. 
Para el trimestre SON del periodo 1979 -- 2019. 
`r pval_contours()`.

```{r pp-temp-2, fig.width=5, fig.height=6}
plot_pp(pp_regr[cEOF == "cEOF2" & season == "SON"], 
        t2m_regr[cEOF == "cEOF2" & season == "SON"],
        hgt850_regr[cEOF == "cEOF2"& season == "SON"])
```

Las anomalías de temperatura asociadas a la fase de 90º del cEOF2 (Fig. \@ref(fig:pp-temp-2).b1) muestran valores positivos en el Pacífico tropical, coherentes con las anomalías de SST asociadas a esta misma fase (Fig. \@ref(fig:sst-psi-2).b1).
En latitudes más altas existe un patrón ondulatorio de valores positivos y negativos que coincide con los nodos de los patrones de regresión de la altura geopotencial de 850 hPa.
Esto es coherente con las anomalías de temperatura producidas por la advección meridional de temperatura por los vientos meridionales derivados del equilibrio geostrófico.
Sobre los continentes, las fase de 90º (Fig.\@ref(fig:pp-temp-2)b.1) está asociada a anomalías de temperatura positiva en el sur de Australia y anomalías de regresión negativa en el sur de Sudamérica y la Península Antártica, que son resultado del tren de ondas descrito anteriormente.

Las anomalías de temperatura asociadas a la fase de 0º (Fig.\@ref(fig:pp-temp-2)d.1) son menos extensas y se limitan a latitudes medias y altas.
Sobre los continentes, las regresiones de las anomalías de temperatura no son significativas, excepto las anomalías positivas cerca de la Península Antártica.

Las anomalías de precipitación tropicales asociadas con el 90º cEOF2 son fuertes, con anomalías positivas en el Pacífico central y el Índico occidental, y anomalías negativas en el Pacífico oriental (Fig.\@ref(fig:pp-temp-2)b.2).
Este campo es consistente con el mapa de regresión de la SST (Fig.\@ref(fig:pp-temp-2)b.1) ya que las anomalías positivas de la SST potencian la convección tropical y las anomalías negativas de la SST la inhiben.

En los extratrópicos, la fase de 90º del cEOF2 se asocia a condiciones más secas sobre el este de Australia y el océano circundante, que es una señal similar a la asociada al ENSO [@cai2011].
Sin embargo, esta es la fase más fuertemente correlacionada con la precipitación en esa zona.
La fase de 135º (una intermedia 90º y 180º) está correlacionada más intensa y extensamente con la precipitación sobre Australia y Nueva Zelanda.
La influencia del cEOF2 en la precipitación australiana podría estar relacionada más con los impactos directos de las anomalías de la SST en los océanos circundantes que en el patrón de teleconexión representado por el cEOF2.

Sobre Sudamérica, la fase de 90º del cEOF2 está correlacionado positivamente con la precipitación en el sudeste de Sudamérica (SESA) y el centro de Chile, y negativamente negativas en el este de Brasil.
Este campo de correlación coincide con la señal de ENSO la precipitación de primavera [e.g. @cai2020a].

Los coeficientes de correlación entre las anomalías de precipitación y la fase de 0º del cEOF2 (Fig. \@ref(fig:pp-temp-2)d.2) son más débiles que para la fase de 90º. 
Hay una correlación positiva residual en el Pacífico oriental ecuatorial y pequeñas correlaciones positivas, no estadísticamente significativas, sobre el este de Australia y negativas sobre Nueva Zelanda.

## Otras estaciones ??

Definitivamente extender al resto del año.
(índice mensual).
Esto faltaría.
Hay código para hacerlo, pero falta la interpretación, que es lo importante.

Sería un análisis más modesto.

