---
knit: purrr::partial(bookdown::render_book, output_format = 'all', preview = TRUE)
---

```{r setup, include=FALSE}
source(here::here("tesis/scripts/globals.R"))

library(knitr)

library(eliotesis)

library(metR)
library(data.table)
library(magrittr)

library(kableExtra)

library(ggplot2)
library(tagger)
library(ggperiodic)
library(ggnewscale)
library(gggrid)
library(patchwork)
library(latex2exp)


main_levs <- c(700, 300, 30, 50)
```

# Estructura simétrica y asimétrica del SAM {#asymsam}

## Introducción

Como se explicó en la introducción, el patrón espacial del SAM suele describirse a través del primer EOF de las anomalías de altura geopotencial en la troposfera del hemisferio sur.
En otros casos se utilizan índices construidos asumiendo que el patrón describe eminentemente variaciones de la circulación zonalmente simétrica.
Sin embargo, este patrón tiene asimetrías zonales significativas.

Muchos índices presentados en la literatura para describir el SAM se basan en medias zonales de la presión a nivel del mar o de la altura geopotencial [@ho2012].
Tanto @gong1999 como @marshall2003 definen el índice SAM como la diferencia de la media zonal de la presión a nivel del mar entre 40ºS y 65ºS.
Asimismo, @baldwin2009 propusieron definir modos anulares del norte y el sur como el primer EOF de la altura geopotencial promediada zonalmente en cada nivel en cada hemisferio.
Sin embargo, como se verá a continuación, las asimetrías zonales del SAM pueden ser significativas y han sido poco estudiadas.

En la literatura se asocia generalmente a la fase positiva del SAM a aquella asociada con anomalías negativas de altura geopotencial sobre la Antártida y positivas en latitudes medias [@jones2019].
En esta fase las temperaturas son más frías de lo normal sobre la Antártida y más cálidas de lo normal en latitudes más bajas.
Lo opuesto se encuentra para la fase negativa.
Pero hay desviaciones significativas de esta respuesta media zonal, especialmente en la Península Antártica y el Atlántico sur [@fogt2012].
La señal relacionada con el SAM en las anomalías de precipitación también es positiva en latitudes altas y negativa en latitudes medias, aunque con aún mayores desviaciones respecto de la simetría zonal [@lim2016].
En particular, la relación entre el SAM y la precipitación en el SESA en escalas interanuales depende fuertemente de las anomalías de circulación zonalmente asimétrica asociadas al SAM y presenta importantes variaciones decadales [@silvestri2009; @rosso2018].

Si bien la variabilidad del SAM se debe principalmente a la variabilidad interna, en escalas intraestacionales e interanuales, puede estar asociada con la variabilidad tropical [@fan2007; @fogt2011a; @clem2013].
Como se discutió en las secciones anteriores, el ENSO o la variabilidad tropical en general afecta a los extratrópicos del hemisferio sur a través de trenes de ondas de Rossby [@mo1987; @kidson1988; @karoly1989] que pueden proyectarse fuertemente sobre las anomalías zonales asociadas al SAM en el sector del Pacífico [p.ej. @silvestri2009; @vera2018].
@fan2007 calculó los índices de SAM de los hemisferios occidental y oriental por separado y encontró que la correlación entre ellos aumentaba si se elimina la señal (lineal) del ENSO, sugiriendo que la influencia del ENSO en el SAM no es zonalmente homogénea.

En escalas más largas, investigaciones previas han documentado a lo largo del siglo XX y lo que va del XXI, tendencias positivas en el SAM utilizando diferentes índices, sobre todo para el verano y otoño australes [p.ej., @fogt2020 y sus referencias].
Se encontró que estas tendencias están impulsadas principalmente por la reducción del ozono estratosférico y el aumento de los gases de efecto invernadero, aunque han sido analizadas en el contexto de las variables medias zonales [@marshall2004; @gillett2005; @arblaster2006; @gillett2013].
Por lo tanto, no está claro si la componente asimétrica del SAM responde a estos forzantes de la misma forma o si su variabilidad, por el contrario, altera las tendencias observadas.

Uno de los pocos trabajos que estudiaron la variabilidad temporal de la componente asimétrica del SAM es @fogt2012.
Este trabajo definió los patrones de SAM asimétrico positivo y negativo como las anomalías zonales de composiciones de presión al nivel del mar para eventos SAM positivos y negativos.
Sin embargo, estas composiciones se basan en un número reducido de casos y distribuidos inhomogéneamente entre años con y sin información satelital.
Esto es especialmente relevante debido a las inhomogeneidades en los productos de reanálisis anteriores a la era satelital y al posible cambio en la estructura asimétrica del SAM [@silvestri2009].
Además, @fogt2012 estudió la componente asimétrica zonal del SAM solamente en la presión a nivel del mar.
Si bien las asimetrías zonales en el patrón espacial del SAM son barotrópicas equivalentes en toda la troposfera, su estructura cambia drásticamente en la estratosfera [@baldwin2009].

Es decir, las investigaciones previas sugieren fuertemente que la componente zonalmente asimétrica del SAM puede tener un comportamiento potencialmente muy distinto al de la componente zonalmente simétrica, por lo que su estudio merece particular atención.
En este sentido, en el capítulo anterior se encontró que algunas fases de los cEOFs están asociadas con patrones tipo SAM en distintos niveles.
El objetivo de este capítulo es, por tanto, describir las componentes zonalmente asimétricas y simétricas de la variabilidad del SAM y su relación con los cEOFs.
En primer lugar, se propone una metodología que proporciona, para cada nivel, dos índices que pretenden captar de forma independiente la variabilidad de la componente del SAM simétrica y asimétrica, respectivamente.
Luego se los utilizó para describir su estructura vertical y su coherencia, así como su variabilidad temporal y sus tendencias.
A continuación se estudiaron los patrones espaciales asociados a la variabilidad exclusiva de cada índice centrándose en 50 hPa como nivel estratosférico y 700 hPa como nivel troposférico.
Por último, se investigaron las relaciones del SAM a 700 hPa con las anomalías de temperatura y precipitación.

```{r read-hgt}
hgt <- ERA5_geopotential() %>% 
  ReadNetCDF(subset = list(time = main_period,
                           latitude = c(-90, 10),
                           level = as.list(main_levs)),
             vars = c(hgt = "z")) %>% 
  .[, hgt := hgt/9.8] %>% 
  normalise_coords() %>% 
  na.omit() %>% 
  .[, hgt := hgt/9.8] %>% 
  .[, hgt_a := hgt - mean(hgt), by = .(lon, lat, lev, month(time))] %>% 
  .[, time := as.Date(time)] 
```

```{r compute-SAM}
set.seed(42)
SAM <- hgt[lat <= -20] %>% 
  .[lev == 700] %>%
  .[year(time) %between% year(main_period)] %>% 
  .[, hgt := hgt_a*sqrt(cos(lat*pi/180))] %>% 
  .[, .(eof = list(EOF(hgt ~ time | lon + lat, n = 1, data = .SD))), 
    by = .(lev)]

# I need to change the sign
SAM$eof[[1]]$left[, hgt := -hgt]
SAM$eof[[1]]$right[, hgt := -hgt]


dims <- hgt[lat <= -20] %>% 
  .[, .(x = uniqueN(lon), y = uniqueN(lat), t = uniqueN(time))]

```

```{r test-aao1}
# test that my SAM have the correct sign.
aao <- rsoi::download_aao(TRUE, data_path("raw", "aao.csv")) %>% 
  as.data.table() %>% 
  .[, .(time = as.Date(Date), aao = AAO)] %>% 
  .[year(time) >= 1979]

cor_aao <- SAM$eof[[1]]$left %>% 
  .[aao, on = .NATURAL] %>% 
  na.omit() %>% 
  .[, cor(hgt, aao)] 

if (sign(cor_aao) != 1) {
  stop("AAO and full index are not positively correlated!")
}
```

## Datos y métodos

### Datos

Se utilizan las mismas fuentes de datos que en capítulos anteriores.
En este capítulo se usaron en particular datos de altura geopotencial, temperatura del aire a 2 metros del conjunto de datos ERA5 y precipitación del conjunto de datos CMAP para el período `r periodo`.

### Regresión segmentada

Se utilizó la metodología de regresión lineal segmentada para calcular los campos asociados a las fases positivas y negativas del SAM.
Ésta consiste en ajustar un modelo lineal a tramos con continuidad en cada segmento como se ilustra en la Figura \@ref(fig:segmentada-ejemplo) con datos sintéticos.


```{r segmentada-ejemplo, fig.width=4, fig.height=3}
withr::with_seed(42, 
                 {
                   N <- 100
                   x <- runif(N, -3, 3)
                   y <- ifelse(x < 0, 2*x, .5*x) + rnorm(N, sd = 0.5)
                   
                   data.frame(x = x,
                              y = y) %>% 
                     ggplot(aes(x, y)) +
                     geom_point() +
                     geom_smooth(method = "lm", formula = y ~ x + x:sign(x), se = FALSE) +
                     scale_x_continuous("X") +
                     scale_y_continuous("Y")   
                   
                 })

```

(ref:segmentada-ejemplo-cap) Ejemplo de regresión segmentada. X es una variable aleatoria con distribución uniforme e Y es $2X$ cuando $X<0$ y $1/2X$ cuando $X\ge0$ más errores aleatorios. La línea azul es la regresión segmentada de X e Y.

Para obtener las pendientes asociadas a la relación lineal para cada signo, se ajustó la ecuación

$$
Y_i = \alpha X_i + \beta X_iI_{X\le 0} + X_0 + \epsilon_i
$$

donde $Y$ e $X$ son las variables dependiente e independiente respectivamente, $\alpha$ es la pendiente asociada a los valores positivos de $X$, $\beta$ es la diferencia entre la pendiente asociada a valores positivos y negativos de $X$, $I_{X\le 0}$ es la función indicador que es 1 cuando $X\le0$ y 0 cuando $X>0$, y $X_0$ y $\epsilon_i$ son la constante y los términos de error.
El coeficiente asociado a valores negativos de X es $\beta - \alpha$.

Comparado con el uso de composiciones para eventos que superan umbrales positivos y negativos, este método tiene la ventaja de utilizar todos los datos eficientemente (en vez de descartar los eventos "neutrales") y de que la magnitud de los patrones obtenidos no depende de la intensidad media de los eventos positivos y negativos. 
Además, dado que $\beta$ es la diferencia en la pendiente entre valores positivos y negativos, es posible calcular la significancia estadística de la misma.

### Descomposición de las componentes del SAM {#definition-of-indices}

El SAM suele en muchos casos definirse como el EOF de las anomalías de la presión al nivel del mar o de la altura geopotencial en un determinado nivel vertical, generalmente bajo de la troposfera [ej @silvestri2009; @ho2012].
Siguiendo a @baldwin2001, se amplió esa definición verticalmente y se utiliza el término SAM para referirse al primer EOF de las anomalías mensuales de altura geopotencial al sur de 20º S en cada nivel vertical considerado y que de ahora en adelante el SAM se refiere al SAM "completo" que incluye tanto la componente simétrica como la asimétrica.

Para separar la componente zonalmente simétrica y la asimétrica del SAM, se calculó la media zonal y las anomalías del patrón espacial del SAM completo, como se muestra en la Figura \@ref(fig:method) en 700 hPa.
La señal espacial completa ($\mathrm{EOF_1}(\lambda, \phi)$) es la suma de la componente zonalmente asimétrica ($\mathrm{EOF_1^*}(\lambda, \phi)$) y la simétrica ($[\mathrm{EOF_1}](\lambda, \phi)$).
A continuación, se calculó el índice SAM, el índice SAM asimétrico (A-SAM) y el índice SAM simétrico (S-SAM) como los coeficientes de la regresión de cada campo de altura geopotencial mensual sobre los respectivos patrones (ponderando por el coseno de la latitud).
Finalmente, se normalizaron los tres índices dividiéndolos por la desviación estándar del índice SAM en cada nivel.
Como resultado, las magnitudes entre los índices son comparables.
Sin embargo, sólo el índice SAM tiene desviación estándar unitaria por definición.
La varianza explicada por cada patrón se utiliza como indicador del grado de simetría o asimetría zonal de cada campo mensual.
Para cuantificar la coherencia entre las series temporales correspondientes a distintos índices o al mismo índice en distintos niveles, se calculó la correlación temporal entre ellas.

(ref:method-cap) Patrones espaciales del primer EOF de la altura geopotencial en 700 hPa para el período `r periodo`. (a) Campo completo, (b) componente zonalmente asimétrica y (c) componente zonalmente simétrica. Unidades arbitrarias con valores negativos en azul y positivos en rojo.

```{r method, fig.width=6, fig.height=2.5}
sam_sep <- SAM[, eof[[1]]$right, by = .(lev)] %>% 
  setnames("hgt", "full") %>% 
  .[, c("sym", "asym") := list(mean(full), Anomaly(full)), by = .(lat, lev)] 


lab_eof <- c(full = TeX("$EOF_1(\\lambda, \\phi)$"),
             asym = TeX("$EOF_1^*(\\lambda, \\phi)$"), 
             sym  = TeX("$\\[EOF_1\\](\\lambda, \\phi)$"))

sam_plot <- sam_sep %>% 
  .[lev %in% c(700)] %>%
  rm_singleton() %>%
  melt(id.vars = c("lon", "lat")) %>% 
  .[, value := value + rnorm(.N, sd = 1e-6)] %>% 
  .[, variable := factor_sam(variable)] 

levels(sam_plot$variable) <- lab_eof

sam_plot %>% 
  copy() %>% 
  .[lat > -90] %>%
  .[, value := value/sqrt(cos(lat*pi/180))] %>%
  # .[, hgt := ifelse(lat == -90, mean(value[lat == -87.5]), hgt)] %>% 
  periodic(lon = c(0, 360)) %>%
  ggplot(aes(lon, lat)) +
  # geom_contour(aes(z = value, linetype = factor(-sign(..level..))), global.breaks = FALSE) +
  geom_contour_fill(aes(z = value), global.breaks = FALSE, breaks = ZeroBreaks) +
  geom_contour_tanaka(aes(z = value), global.breaks = FALSE, breaks = ZeroBreaks) +
  geom_qmap() +
  annotate_grid() +
  scale_x_longitude(labels = NULL) +
  scale_y_latitude(limits = c(NA, -20), labels = NULL) +
  scale_fill_divergent(guide = "none") +
  coord_polar2() +
  facet_grid(.~variable, labeller = labeller(variable = label_parsed, lev = lab_lev)) +
  axis_labs_smol() +
  theme(panel.grid = element_blank())  +
  tag_facets() +
  theme(panel.spacing = grid::unit(1, "lines"))
```

```{r compute-asymsam}
indices <- SAM() %>% 
  fread() %>% 
  .[, time := as.Date(time)] %>% 
  .[time %between% main_period]
indices_wide <- dcast(indices, lev + time ~ term, value.var = "estimate_norm")
```

```{r test-aao2}
# test that my indices have the correct sign. The Full index needs to be **positively** correlated
# with the AAO index.
cor_aao <- indices[term == "full" & lev == 700] %>% 
  .[aao, on = .NATURAL] %>% 
  na.omit() %>% 
  .[, cor(estimate, aao)] 

if (sign(cor_aao) != 1) {
  stop("AAO and full index are not positively correlated!")
}
```

```{r sign-regression}
sign_regression <- hgt[lev %in% c(50, 700)] %>%
  indices_wide[., on = .NATURAL] %>% 
  # .[, ":="(samplus = fifelse(full > 0, full, 0),
  #          samminus = fifelse(full <= 0, full, 0)),
  #   by = .(lev, month(time))] %>% 
  .[, hgt_a := Anomaly(hgt_a), by = .(lat, lev, time)] %>%
  .[, FitLm(hgt_a, samplus = full, difference = full*(sign(full) <= 0), intercept = FALSE, se = TRUE), 
    by = .(lon, lat, lev, season(time, lang = "es"))] %>% 
  .[, pval := Pvaluate(estimate, std.error, df, adjustment = "fdr")]

plot_sign_regression <- function(sign_regression) {
  sign_regression <- copy(sign_regression)
  
  diff <- sign_regression[term == "difference"] %>% 
    .[, .(lon, lat, lev, season, pval)]
  
  sign_regression[, estimate := c(estimate[term == "samplus"], sum(estimate)), by = .(lon, lat, lev, season)]
  sign_regression[term == "difference", term := "samminus"]
  sign_regression[, pval := NULL]
  
  composites_cors <- sign_regression %>% 
    dcast(season + lat + lon + lev  ~ term, value.var = "estimate") %>% 
    .[, FitLm(samplus, samminus, se = TRUE), by = .(lev, season)] %>% 
    .[term != "(Intercept)"] %>% 
    .[, .(lev, season, beta = estimate, r.squared)]
  
  sign_regression %>% 
    composites_cors[., on = c("season", "lev")] %>% 
    diff[., on = c("lon", "lat", "lev", "season")] %>% 
    .[order(season)] %>% 
    .[, season_text := paste0(season, 
                              "\nr2: ", 
                              scales::number(r.squared, accuracy = 0.01))] %>% 
    .[, season_text := factor(season_text, levels = unique(season_text), 
                              ordered = TRUE)] %>% 
    .[, term := factor(term, c("samplus", "samminus"))] %>% 
    periodic(lon = c(0, 360)) %>% 
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = estimate, fill = after_stat(level)), 
                      breaks = AnchorBreaks(0, exclude = 0), 
                      global.breaks = TRUE) +
    geom_contour_tanaka(aes(z = estimate), 
                        breaks = AnchorBreaks(0, exclude = 0), 
                        global.breaks = TRUE) +
    
    geom_contour_pval(aes(z = pval)) +
    geom_qmap(~.x[lat <= 0]) +
    annotate_grid() +
    scale_x_longitude(labels = NULL) +
    scale_y_latitude(limits = c(NA, -20), labels = NULL) +
    scale_fill_divergent_discretised(name = NULL, 
                                     guide = guide_colorsteps_bottom()) +
    coord_polar2() +
    axis_labs_smol() +
    facet_grid(term ~ season_text, labeller = labeller(term = c("samplus" = "SAM+", 
                                                                "samminus" = "SAM-"))) +
    tag_facets()
}

```

Cabe mencionar que una limitación de este método es que supone linealidad en entre las componentes del SAM.
Es decir, supone que los patrones de anomalías asociadas a valores positivos de cada componente del SAM son similares pero de signo opuesto a las asociadas a la fase valores negativos y de magnitud proporcional a la magnitud del índice.
Las composiciones de @fogt2012 (su Figura 4) sugieren que esto podría no ser del todo válido, aunque gran parte de esa aparente no linealidad podría deberse a la naturaleza heterogénea de los años seleccionados para construir las composiciones y a la incertidumbre muestral.

Para poner esta suposición a prueba, se calculó la regresión segmentada de las anomalías zonales de altura geopotencial con el índice SAM para cada signo del SAM.
Las Figuras \@ref(fig:sign-regression-50) y \@ref(fig:sign-regression-700) muestran los campos de regresión en 50 y 700 hPa divididos por trimestres.
Se puede observar que en casi todas las estaciones y en ambos niveles, los campos de regresión de SAM positivo y negativo son similares entre ellos.
Este análisis cualitativo se confirma por el análisis cuantitativo al observar que el $r^2$ (representando la correlación espacial al cuadrado) tienen valores entre 0,7 y 0,9, indicando alta similaridad.
A su vez, también es similar la intensidad de los coeficientes de correlación, indicando un buen cumplimiento de la hipótesis de linealidad.

(ref:sign-regression-50-cap) Regresión segmentada de la anomalía zonal de altura geopotencial en 50 hPa con el índice SAM para cada signo para el período `r periodo` (m). La correlación espacial al cuadrado entre cada campo en cada estación se detalla debajo de la estación. `r pval_contours(de = " de la diferencia entre el signo positivo y el negativo ")` (no hay áreas).

```{r sign-regression-50, fig.width=6, fig.height=3.7}
plot_sign_regression(sign_regression[lev == 50])
```

(ref:sign-regression-700-cap) Igual que la Figura \@ref(fig:sign-regression-50) pero para 700 hPa.

```{r sign-regression-700, fig.width=6, fig.height=3.7}
plot_sign_regression(sign_regression[lev == 700])
```

Al realizar el análisis EOF utilizando los datos de todos los meses también se asume que la estructura del SAM es la misma en todas las estaciones.
La Figura \@ref(fig:season-regression) muestra la regresión de las anomalías de altura geopotencial en 50 y 700 hPa contra el índice SAM para cada trimestre del año y la significancia estadística de la diferencia entre cada estación y SON.

En 50 hPa (Fig. \@ref(fig:season-regression) fila a), los patrones del SAM para MAM y JJA son muy similares a SON, con correlación espacial cuadrada mayor a 0,75.
En estas tres estaciones, el SAM en 50 hPa se asocia a una onda planetaria 1 con su centro negativo en 60ºO.
El patrón de JJA tiene algunas diferencias significativas con respecto a SON, principalmente un corrimiento e intensificación de la anomalía negativa de la onda.
El patrón de DEF, en cambio, es muy distinto; la onda 1 tiene su mínimo cerca de 180ºO y está más retraída a latitudes altas.
Además, su correlación espacial es esencialmente nula.

En 700 hPa (Fig. \@ref(fig:season-regression) fila b), las cuatro estaciones tienen patrones bastante similares, prácticamente sin diferencias estadísticamente significativas con respecto a SON y con correlaciones cuadradas mayores a 0,6.
El patrón de DEF es el más distinto, siendo similar a SON pero menos intenso.
Esto es consistente con los resultados de @fogt2020.

Estos resultados sugieren entonces que la suposición de estabilidad estacional se cumple excepto para DEF en la estratósfera.
Esto indica que hay que tener cuidado en la interpretación del SAM asimétrico en DEF en la estratosfera ya que el patrón de SAM asimétrico impuesto por la metodología no coincide con el patrón de SAM asimétrico que se obtendría considerando únicamente este trimestre.

(ref:season-regression-cap) Regresión múltiple de las anomalías zonales de altura geopotencial en 50 hPa y en 700 hPa con el índice SAM para cada estación (m). El sombreado muestra la regresión de cada estación y los contornos grises, la diferencia de cada estación con respecto a SON (valores negativos en línea punteada y positivos en línea sólida). La correlación espacial al cuadrado entre cada campo y el campo de SON se detalla debajo de la estación. `r pval_contours()`, donde para estaciones distintas a SON, marca el p-valor de la diferencia respecto a SON.

```{r season-regression, fig.height=5.5, fig.width=6, warning=FALSE}
season_regression <- hgt[lev %in% c(50, 700)] %>%
  indices_wide[., on = .NATURAL] %>% 
  .[, hgt_a := Anomaly(hgt_a), by = .(lat, lev, time)] %>%
  .[, ":="(DEF = as.numeric(season(time, "es") == "DEF"), 
           MAM = as.numeric(season(time, "es") == "MAM"), 
           JJA = as.numeric(season(time, "es") == "JJA"))] %>%    # Feo, pero bueno. 
  .[, FitLm(hgt_a, 
            SON = full, 
            DEF = full*DEF, 
            MAM = full*MAM, 
            JJA = full*JJA, se = TRUE), 
    by = .(lon, lat, lev)] %>% 
  .[term != "(Intercept)"] %>% 
  .[, pval := Pvaluate(estimate, std.error, df, adjustment = "fdr"), 
    by = .(term, lev)] %>%
  .[, baseline := estimate[term == "SON"], by = .(lon, lat, lev)] %>%
  .[term != "SON", dif := estimate] %>% 
  .[term != "SON", estimate := estimate + baseline] %>%
  .[, term := factor(term, levels = c("SON", "DEF", "MAM", "JJA"))]


season_cors <- season_regression %>% 
  .[, .(r2 = cor(estimate, baseline)^2), by = .(term, lev)]

season_regression <- season_regression %>% 
  season_cors[., on = c("term", "lev")] %>% 
  .[, season_text := paste0(term, 
                            "\nr2: ", 
                            scales::number(r2, accuracy = 0.01, decimal.mark = ","))] %>% 
  .[, season_text := factor(season_text, levels = unique(season_text), 
                            ordered = TRUE)] %>% 
  periodic(lon = c(0, 360))


ggplot(season_regression[lev == 50], aes(lon, lat)) +
  scale_fill_divergent_discretised(name = "50 hPa",
                                   guide = guide_colorsteps_bottom()) +
  tag_facets("panel", tag_levels = "1", tag_prefix = "a.") +
  
  ggplot(season_regression[lev == 700], aes(lon, lat)) +
  scale_fill_divergent_discretised(name = "700 hPa",
                                   guide = guide_colorsteps_bottom()) +
  tag_facets("panel", tag_levels = "1", tag_prefix = "b.") &
  # 
  geom_contour_fill(aes(z = estimate, fill = after_stat(level)),
                    breaks = AnchorBreaks(0, exclude = 0),
                    global.breaks = TRUE) &
  geom_contour_tanaka(aes(z = estimate),
                      breaks = AnchorBreaks(0, exclude = 0),
                      global.breaks = TRUE) &
  geom_contour2(aes(z = dif, label = after_stat(level),
                    linetype = after_stat(factor(sign(-level)))),
                breaks = AnchorBreaks(0, exclude = 0), linewidth = 0.5,
                color = "gray40", label_colour = "gray20", label_size = 3) &
  geom_contour_pval(aes(z = pval), pattern_spacing = 0.05) &
  geom_qmap(~.x[lat <= 0]) &
  annotate_grid() &
  scale_x_longitude(labels = NULL) &
  scale_y_latitude(limits = c(NA, -20), labels = NULL) &
  scale_linetype(guide = "none") &
  coord_polar2() &
  axis_labs_smol() &
  facet_grid(lev ~ season_text, labeller = labeller(lev = AddSuffix(" hPa"))) &
  plot_layout(ncol = 1) 
```


(ref:sam-period-cap) Patrón espacial del primer EOF computado para el período 1979 -- 1998 (columna 1) y 1999 -- 2020 (columna 2) para 50 hPa (fila a) y 700 hPa (fila b). Unidades arbitrarias con valores negativos en azul y negativos en azul.

```{r sam-period, warning = FALSE, fig.width=4, fig.height=4}
SAM_period <- hgt[lat <= -20] %>% 
  .[lev %in% c(50, 700)] %>% 
  .[year(time) %between% year(main_period)] %>% 
  .[, hgt := hgt_a*sqrt(cos(lat*pi/180))] %>%
  .[, period := factor(fifelse(year(time) < 1999, "old", "new"), levels = c("old", "new"))] %>% 
  .[, list(eof = list(EOF(hgt ~ time | lon + lat, n = 1, data = .SD))), 
    by = .(lev, period)] 

sam_period_cor <- SAM_period %>% 
  .[, eof[[1]]$right, by = .(lev, period)] %>% 
  copy() %>% 
  .[, hgt := Anomaly(hgt), by = .(lat, lev)] %>% 
  .[] %>% 
  dcast(lev + lon + lat ~ period, value.var = "hgt") %>% 
  .[, correlate(new, old), by = .(lev)]

SAM_period %>% 
  .[, eof[[1]]$right, by = .(lev, period)] %>% 
  copy() %>% 
  .[, hgt := Anomaly(hgt), by = .(lat, lev)] %>% 
  periodic(lon = c(0, 360)) %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = hgt, fill = after_stat(level)), 
                    breaks = AnchorBreaks(0, exclude = 0)) +
  geom_contour_tanaka(aes(z = hgt), 
                      breaks = AnchorBreaks(0, exclude = 0)) +
  # geom_contour_pval(aes(z = pval)) +
  geom_qmap(~.x[lat <= 0]) +
  annotate_grid() +
  scale_x_longitude(labels = NULL) +
  scale_y_latitude(limits = c(NA, -20), labels = NULL) +
  scale_fill_divergent_discretised(name = NULL,
                                   guide = "none") +
  scale_linetype(guide = "none") +
  coord_polar2() +
  axis_labs_smol() +
  facet_grid(lev ~ period, labeller = labeller(lev = AddSuffix(" hPa"),
                                               period = c(new = "1999 -- 2020",
                                                          old = "1979 -- 1998"))) +
  tag_facets("rc")
```

El método también asume que el patrón zonalmente asimétrico del SAM permanece estacionario a lo largo del periodo considerado.
@silvestri2009 sugieren que este podría no ser el caso entre 1958 y 2004.
Para probar esta suposición, se calculó el SAM para las dos mitades del periodo (1979 a 1998 y 1999 a 2020), que se muestran en la Figura \@ref(fig:sam-period).
Las diferencias entre los dos períodos parecen ser relativamente pequeñas, tanto en la troposfera como en la estratosfera.
La correlación espacial entre los campos es de `r sam_period_cor[lev == 50]$text` en 50 hPa y  `r sam_period_cor[lev == 700]$text` en 700 hPa. 


## Resultados

### Evolución temporal {#temporal}

Primero se evalúa la evolución temporal del A-SAM y S-SAM.
La Figura \@ref(fig:asymsam-timeseries) muestra las series temporales en 700 hPa y 50 hPa y sus correspondientes estimaciones de densidad.
Se seleccionaron estos dos niveles como representativos de la variabilidad troposférica y estratosférica respectivamente.
Como se muestra a continuación, las variabilidades de ambos índices son muy coherentes dentro de cada región de la atmósfera, por lo que es razonable tomar un nivel como representativo de cada capa.

(ref:asymsam-timeseries-cap) Serie temporal de A-SAM y S-SAM en 50 hPa (panel a) y 700 hPa (panel b). A la derecha, la densidad de probabilidad de cada índice. Las series están estandarizadas por el desvío estándar del SAM en cada nivel. Sin unidades.

```{r asymsam-timeseries, fig.width=6, fig.height=3}
indices %>% 
  .[lev %in% c(50, 700) & term != "full"] %>%
  # .[, estimate_norm := estimate_norm/sd(estimate_norm), by = .(lev, term)] %>% 
  ggplot(aes(time, estimate_norm)) +
  geom_line(aes(color = term)) +
  # ggridges::geom_vridgeline(stat="ydensity", scale = -4e8, fill = NA,
  #                           aes(color = term, width = ..density.., x = min(time - 1e7))) +
  # geom_smooth(aes(color = term), method = "loess", n = 481, span = 10*12/481, method.args = list(degree = 1)) +
  # geom_point(data = ~.x[lev == 50][time == as.Date("1987-11-01") & term == "sym" | 
  #                         time == as.Date("1987-08-01") & term == "asym"]) +
  scale_color_brewer(NULL, palette = "Dark2", labels = lab_sam) +
  scale_y_continuous(NULL, position = "right") +
  scale_x_date(NULL, expand = c(0, 0), 
               date_labels = "%Y", date_minor_breaks = "1 year",
               breaks = lubridate::as_date(seq(as.Date("1950-01-01"), as.Date("2040-01-01"), 
                                               by = "5 year"))) +
  facet_grid(lev~., labeller = labeller(lev = lab_lev), switch = "y") +
  tag_facets() +
  
  indices %>% 
  .[lev %in% c(50, 700) & term != "full"] %>% 
  ggplot(aes(estimate_norm)) +
  geom_density(aes(color = term), bw = "SJ") +
  facet_grid(lev~., labeller = labeller(lev = lab_lev)) +
  scale_color_brewer(NULL, palette = "Dark2", labels = lab_sam, guide = "none") +
  scale_y_continuous(NULL, labels = NULL, breaks = NULL) +
  scale_x_continuous(NULL, labels = NULL, breaks = 0) +
  coord_flip()  +
  theme(strip.text = element_blank()) +
  plot_layout(widths = c(4, 1))  +
  panel_background()
```

```{r compute-spectrums}
spec <- indices %>% 
  .[year(time) >= 1979] %>% 
  .[lev %in% c(50, 700)] %>% 
  .[order(time)] %>% 
  # .[, estimate_norm := estimate_norm/sd(estimate_norm), by = .(lev, term)] %>% 
  .[, fftspectrum(estimate, c(5, 9), B = 5000, probs = c(0, 0.95)), by = .(term, lev)]
```

```{r spectrum-max}
max_period <- spec[lev == 50 & term == "sym"] %>% 
  .[which.max(spec - `95%`)] %>% 
  .[, 1/freq]
```

(ref:spectrum-cap) Espectro de cada serie temporal suavizada. El sombreado indica el intervalo de confianza del 95% del espectro nulo calculado usando bootstrap tomando 5000 simulaciones de un modelo autoregresivo ajustado a los datos. La línea gris indica la amplitud promedio teórica del modelo autoregresivo. Para el período `r periodo`.

```{r spectrum, fig.height=4, fig.width=6}
spec %>%
  .[, term := factor_sam(term)] %>% 
  # .[term != "full"] %>% 
  ggplot(aes(1/freq/12, spec)) +
  geom_ribbon(aes(ymin = 0, ymax = `95%`), position = "dodge", alpha = 0.1) +
  geom_line(aes(y = ar_spectrum), alpha = 0.15) +
  geom_line() +
  annotation_logticks(sides = "b") +
  scale_color_brewer(NULL, palette = "Dark2", aesthetics = c("color", "fill")) +
  scale_x_log10("Período (años)", sec.axis = sec_axis(~.*12, name = "Período (meses)")) +
  scale_y_continuous("Espectro") +
  facet_grid(lev ~ term, 
             labeller = labeller(lev = lab_lev, term = lab_sam),
             scales = "free") +
  tag_facets("rc") 
```

Los espectros de estas series temporales se muestran en la Figura \@ref(fig:spectrum).
El S-SAM estratosférico varía fuertemente con un periodo entre 10 y 30 meses (Fig. \@ref(fig:spectrum) a.3).
En el periodograma del S-SAM troposférico (Fig.\@ref(fig:spectrum) b.3) se aprecia un pico local en un rango de frecuencias similar, aunque no es estadísticamente significativo.
Esta banda de periodicidad que exhibe la estratosfera está alrededor del rango de periodicidad de la Oscilación Cuasi-Bienal (QBO, por su siglas en inglés, @baldwin2001b) y es consistente con  los resultados de @vasconcellos2022, quienes encontraron que el SAM y la QBO comparten una alta potencia común significativa alrededor de la banda de 2 años.
El hecho de que esta periodicidad no sea evidente en el índice A-SAM, también es consistente con los resultados de estos autores, que muestran un monopolo bastante simétrico sobre la Antártida en sus composiciones de anomalías de altura geopotencial durante la QBO oriental y occidental
En la troposfera, el pico de variabilidad más significativo se encuentra en A-SAM en torno a 36 meses.

```{r compute-cors}
ccf_dt <- function(..., plot = FALSE) {
  stat <- ccf(..., plot = plot)
  list(lag = stat$lag[, 1, 1], 
       acf = stat$acf[, 1, 1])
}

cors <- indices_wide %>% 
  .[year(time) >= 1979] %>% 
  .[, ccf_dt(asym, sym, lag.max = 5), by = .(lev)]
```

La Figura \@ref(fig:cor-lev) muestra la correlación entre A-SAM y S-SAM en cada nivel para los desfasajes cero (simultáneo) y -1 (A-SAM adelantada a S-SAM en 1 mes).
Los valores de las correlaciones instantáneas entre A-SAM y S-SAM son relativamente constantes en toda la troposfera, fluctuando entre `r signif(cors[lag == 0 & lev >= 100, min(acf)], 2)` y `r signif(cors[lag == 0 & lev >= 100, max(acf)], 2)`.
Las correlaciones con defasaje de un mes son igualmente constantes pero muy reducidas.
En la estratosfera, las correlaciones instantáneas caen a un mínimo de `r signif(cors[lag == 0 & lev < 100][which.min(acf)]$acf, 2)` en `r cors[lag == 0 & lev < 100][which.min(acf)]$lev` hPa y luego aumentan nuevamente monótonamente con la altura hasta el nivel más alto considerado  (aunque los resultados cerca del tope superior representado en los modelos deben interpretarse con cuidado).
Al mismo tiempo, las correlaciones con un mes de defasaje aumentan con la altura.
Por lo tanto, el índice A-SAM estratosférico tiende a preceder al índice S-SAM.

(ref:cor-lev-cap) Correlación instantánea (línea verde) y con un defasaje de 1 mes (línea naranja) entre S-SAM y A-SAM para el período `r periodo`.

```{r cor-lev, fig.width=3, fig.height=3}
cors %>% 
  .[lag %in% c(0, -1)] %>% 
  ggplot(aes(lev, acf)) +
  geom_line(aes(color = factor(lag, levels = c(0, -1), ordered = TRUE),
                linetype = factor(lag, levels = c(0, -1), ordered = TRUE))) +
  scale_x_level() +
  scale_y_continuous("Correlación", limits = c(0, 1)) + 
  scale_linetype_manual(name = NULL, values = c(1, 5), 
                        labels = c("0" = "Instantánea", 
                                   "-1" = "A-SAM adelanda a\nS-SAM en 1 mes")) +
  scale_color_brewer(NULL, palette = "Dark2", 
                     labels = c("0" = "Instantánea",
                                "-1" = "A-SAM adelanda a\nS-SAM en 1 mes")) +
  coord_flip() +
  panel_background()
```

(ref:cross-correlation-cap) Correlación cruzada entre niveles para el índice SAM (a), A-SAM (b) y S-SAM (c) para el período `r periodo`.

```{r cross-correlation, fig.width = 6, fig.height=3}
tri <- matrix(c(1000, 1000, 1000, 1, 1, 1, 1000, 1000), ncol = 2, byrow = TRUE) %>% 
  as.data.table() %>% 
  setnames(., colnames(.), c("item1", "item2"))

logbreaks <- function(range) {
  ticks <- ggplot2:::calc_logticks(minpow = log10(min(range)), maxpow = log10(max(range)))
  ticks$value[ticks$end == 0.2]
}

N <- indices %>% 
  .[, .N, by = .(lev, term)] %>% 
  .[, unique(N)]

crosscor <- indices %>% 
  .[year(time) >= 1979] %>% 
  copy() %>% 
  .[, widyr::pairwise_cor(.SD, lev, time, estimate, diag = TRUE), by = .(term)] 

crosscor %>% 
  .[, p.value := 2*pnorm(atanh(correlation), 0, sd = 1/sqrt(N), lower.tail = FALSE)] %>% 
  .[, p.value := p.adjust(p.value, method = "bonferroni")]

crosscor %>% 
  .[, term := factor_sam(term)] %>% 
  ggplot(aes(item2, item1)) +
  geom_contour_fill(aes(z = correlation, fill = ..level..),
                    breaks = MakeBreaks(binwidth = 0.1)) +
  geom_contour_tanaka(aes(z = correlation), size = 0.1, na.fill = .99, 
                      breaks = MakeBreaks(binwidth = 0.1)) +
  geom_text_contour(aes(z = correlation), breaks = MakeBreaks(binwidth = 0.1),
                    color = "black", 
                    rotate = FALSE, 
                    stroke.color = "white", stroke = 0.25, 
                    skip = 1, size = 2.2, 
                    data = ~.x[item2 > item1]) +
  geom_polygon(data = tri, fill = "#fbfbfb") +
  scale_fill_divergent_discretised("Correlación cruzada",
                                   guide = guide_colorsteps_bottom()) +
  scale_x_level(minor_breaks = logbreaks, position = "top") +
  scale_y_level(minor_breaks = logbreaks) +
  coord_equal() +
  facet_grid(. ~ term, labeller = labeller(term = lab_sam)) +
  theme(panel.spacing.x = unit(2, "lines"), strip.placement = "outside") +
  tag_facets(position = "br")
```

La Figura \@ref(fig:cross-correlation) muestra la correlación cruzada simultánea (sin desfasaje) entre niveles para los índices SAM, A-SAM y S-SAM.
Para el SAM (Fig. \@ref(fig:cross-correlation)a), los valores altos por debajo de 100 hPa reflejan coherencia vertical en toda la troposfera.
Por encima de 100 hPa, la correlación entre niveles disminuye más rápidamente, lo que indica una variabilidad menos coherente.
Sin embargo, las correlaciones entre los niveles troposféricos y los niveles estratosféricos bajos y medios siguen siendo relativamente altas (por ejemplo, más de 0,4 entre los niveles troposféricos y los niveles por debajo de 30 hPa).
A-SAM y S-SAM (Fig. \@ref(fig:cross-correlation)b y c, respectivamente) comparten un alto nivel de coherencia similar en la troposfera, pero difieren en su comportamiento estratosférico.
La coherencia estratosférica es mayor para el A-SAM que para el S-SAM.
El S-SAM estratosférico tiene una conexión con el S-SAM troposférico algo más intensa que el A-SAM estratosférico con el A-SAM troposférico.

(ref:trends-cap) Tendencias lineales (en desvío estándar por década) del SAM (columna a), A-SAM (columna b) y S-SAM (columna c) para cada nivel usando datos del todo el año (fila 1) y promedios estacionales (filas 2 a 5) para el período `r periodo`. El sombreado indica el intervalo de confianza de 95%.

```{r trends, fig.width = 6, fig.height=4}
indices %>% 
  .[, lapply(.SD, mean), by = .(lev, PC, term, time = seasonally(time))] %>% 
  .[, season := season(time, "es")] %>% 
  rbind(., copy(indices)[, season := "Anual"]) %>% 
  .[year(time) >= c(1979)] %>% 
  .[, estimate_norm := estimate_norm/sd(estimate_norm), by = .(lev, term)] %>%
  .[, FitLm(estimate_norm, time = time, se = TRUE), by = .(type = term, lev, season)] %>% 
  rm_intercept() %>% 
  .[, term := NULL] %>%  
  .[, estimate := estimate*365*10] %>% 
  .[, std.error := std.error*365*10] %>% 
  .[, pval := Pvaluate(estimate, std.error, df, "fdr")] %>% 
  setnames("type", "term") %>% 
  .[, season := forcats::fct_relevel(season, "Anual")] %>% 
  .[, t := qt(.975, df)] %>% 
  .[, term := factor_sam(term)] %>% 
  ggplot(aes(lev, estimate)) +
  geom_hline(yintercept = 0) +
  geom_ribbon(aes(ymax = estimate + std.error*t, ymin = estimate - std.error*t), 
              fill = "#95a3ab", color = "black", 
              alpha = .6, size = 0.1) +
  geom_line() +
  # stat_subset(aes(subset = pval <= 0.05), shape = 4, size = 2) +
  scale_fill_brewer(palette = "Dark2", aesthetics = c("color", "fill")) +
  scale_x_level() +
  scale_y_continuous("Desvío estándard por década") +
  coord_flip() +
  facet_grid(season ~ term,labeller = labeller(term = lab_sam)) +
  tag_facets("rc") +
  panel_background()
```

A continuación, se evalúan las tendencias lineales para cada uno de los índices para el periodo `r periodo` en cada nivel para el año completo y separado por trimestres (Fig. \@ref(fig:trends)).
El índice SAM presenta una tendencia positiva estadísticamente significativa (Fig. \@ref(fig:trends)a.1) en todos los niveles entre 1000 hPa y aproximadamente 50 hPa, con un máximo en 100 hPa.
Las tendencias estacionales (Fig. \@ref(fig:trends) columna 1) indican que las tendencias son significativas sólo en verano y marginalmente en otoño.
Esto es consistente con los resultados de estudios previos, los cuales documentaron tendencias positivas en verano, menores en otoño y ninguna tendencia en las demás estaciones (por ejemplo, @fogt2020 y sus referencias) utilizando índices del SAM basados en la circulación cerca de la superficie.

Al separar el SAM en sus partes asimétrica y simétrica, no sólo se puede ver que estas tendencias se deben casi por completo a la componente simétrica (comparar columnas 2 y 3 en Figura \@ref(fig:trends)), sino que en algunos casos las tendencias se vuelven más claras.
En verano, el índice A-SAM tiene una tendencia negativa estadísticamente no significativa en la troposfera media que oculta la tendencia en el índice SAM; como resultado, las tendencias calculadas utilizando sólo la componente simétrica son más intensas (comparar la región sombreada en la Figura \@ref(fig:trends)b.1 y b.3).
En otoño, el índice S-SAM revela una tendencia positiva estadísticamente significativa en la estratosfera que no es significativa utilizando el índice SAM.

```{r all-trends, eval=FALSE, warning=FALSE, include=FALSE}
data <- indices %>% 
  .[, lapply(.SD, mean), by = .(lev, PC, term, time = seasonally(time))] %>% 
  .[, estimate_norm := estimate_norm/sd(estimate_norm), by = .(lev, term)] %>%
  .[, season := season(time, "es")] %>% 
  .[, year := year(time)] %>% 
  .[lev %in% c(1000, 700, 300, 50, 10)]

roll_lm_dt <- function(x, y, width, ...) {
  model <- roll::roll_lm(x = as.numeric(x), y = y, width = width, ...)
  
  n <- roll::roll_sum(x = !is.na(x + y), width = width, ...)
  df <- n - 2
  x_name <- deparse(substitute(x))
  
  n <- length(y)
  
  ret <- list(x = rep(x, 2), 
              term = rep(c("(Intercept)", x_name), 
                         each =  length(model$coefficients[, 1])),
              estimate = c(model$coefficients[, 1], 
                           model$coefficients[, 2]),
              std.error = c(model$std.error[, 1], 
                            model$std.error[, 2]),
              df = rep(df, 2)
  )
  
  names(ret)[1] <- x_name
  ret
}

years <- unique(year(data$time))
n <- length(years)
min_obs <- 30
lapply(years, function(y) {
  data %>% 
    .[year >= y] %>% 
    .[, roll_lm_dt(time, estimate, width = n, min_obs = min_obs), 
      by = .(season, lev, sam = term)] %>% 
    .[, year_start := y]
}) %>% 
  rbindlist() %>% 
  .[term != "(Intercept)"] %>% 
  .[, term := NULL] %>% 
  .[, year_end := year(time)] %>% 
  .[, pval := Pvaluate(estimate, std.error, df, adjustment = "none"),
    by = .(season, lev, sam)] %>% 
  .[sam == "asym"] %>%
  na.omit() %>% 
  # .[lev == 700] %>% 
  ggplot(aes(year_end, year_start)) + 
  geom_contour_fill(aes(z = estimate), bins = 20) +
  geom_contour_pval(aes(z = pval)) +
  scale_fill_divergent() +
  facet_grid(lev ~ season) +
  coord_equal()
```

(ref:r-squared-trend-cap) Tendencias lineales (en porcentaje por década) de la varianza explicada por el A-SAM y el S-SAM en cada nivel para cada trimestre en el período `r periodo`. El sombreado indica el intervalo de confianza del 95%.

```{r r-squared-trend, fig.height=4, fig.width=4, warning = FALSE}
indices %>% 
  .[term != "full"] %>% 
  .[year(time) >= 1979] %>% 
  .[, FitLm(r.squared, time, se = TRUE), by = .(lev, type = term, season(time, "es"))] %>%
  rm_intercept() %>%
  .[, estimate := estimate*365*10] %>% 
  .[, std.error := std.error*365*10] %>% 
  ggplot(aes(lev, estimate)) +
  geom_hline(yintercept = 0) +
  geom_ribbon(aes(fill = type, color = type, 
                  ymin = estimate - 1.96*std.error, ymax = estimate + 1.96*std.error), 
              size = 0.2, alpha = 0.2) +
  geom_line(aes(color = type)) +
  scale_x_level() +
  scale_y_continuous("Cambio en varianza explicada por década", 
                     label = scales::percent_format(1)) +
  scale_fill_brewer(NULL, palette = "Dark2", aesthetics = c("color", "fill"), labels = lab_sam) +
  coord_flip() +
  facet_wrap(~season) +
  tag_facets(tag = "panel") +
  panel_background()
```

Para estudiar la cuestión de si el SAM se está volviendo más o menos asimétrico, se muestran las tendencias de la varianza explicada de cada índice para cada trimestre en la Figura \@ref(fig:r-squared-trend).
En la troposfera, la única tendencia significativa es la de DEF, en la que el A-SAM tiene una tendencia positiva de alrededor del 2% por década (Fig. \@ref(fig:r-squared-trend) a), lo que sugiere que el SAM en DEF se ha vuelto más asimétrico en el período de `r min(year(main_period))` a `r max(year(main_period))`.
@fogt2012 observó un cambio de una SAM más asimétrica antes de 1980 a una SAM más simétrica después de 1980, pero nuestro periodo de estudio (`r periodo`) nos impide detectar ese cambio.
Sin embargo, debido a la naturaleza atípica de la componente asimétrica del SAM durante la DEF (Sección \@ref(definition-of-indices)), esto debe tomarse sólo como una evidencia preliminar.
La otra tendencia significativa se da en la estratosfera durante SON (Fig. \@ref(fig:r-squared-trend) d), donde hay una tendencia positiva en la varianza explicada por la S-SAM de aproximadamente un 4% por década.
Este cambio podría ser el resultado del forzamiento provocado por el agotamiento del ozono.

```{r r-squared-timeseries2, eval = FALSE}
logistic_trans <- scales::trans_new("logistic", 
                                    transform = scales::logit_trans()$inverse, 
                                    inverse = scales::logit_trans()$trans
)
n_years <- uniqueN(year(indices$time))
indices %>%
  .[lev %in%c(700, 50)] %>%
  .[term != "full"] %>%
  # .[year(time) >= 1979] %>%
  .[, .(r.squared = mean(r.squared)), by = .(time = seasonally(time), lev, term)] %>%
  .[year(time) >= 1979, pred := predict(betareg::betareg(r.squared ~ time)), 
    by = .(lev, term, season(time, "es"))] %>% 
  ggplot(aes(time, r.squared)) +
  geom_line(aes(color = term)) +
  geom_line(aes(y = pred, color = term)) +
  geom_smooth(aes(color = term), span = 30/n_years) +  # 30 años
  # geom_smooth(aes(color = term), data = ~.x[year(time) > 1979],
  #             method = "lm") +
  facet_grid(lev~season(time, "es"), scales = "free") +
  scale_y_continuous(trans = scales::logit_trans()) +
  coord_trans(y = logistic_trans) +
  scale_color_brewer(NULL, palette = "Dark2",
                     aesthetics = c("color", "fill"),
                     labels = lab_sam)
```

### Patrones espaciales {#spatial}

Para describir y entender la influencia de las diferentes componentes del SAM en las anomalías temporales de la circulación del hemisferio sur, se calculó la regresión lineal de las anomalías de altura geopotencial sobre los índices SAM, A-SAM y S-SAM en los niveles de 50 hPa y 700 hPa (Fig. \@ref(fig:2d-regr)).
Los coeficientes de regresión de la columna 1 de la Figura \@ref(fig:2d-regr) se calcularon utilizando el índice del SAM.
Los coeficientes de regresión de las columnas 2 y 3 se calcularon mediante regresión múltiple utilizando los índices A-SAM y S-SAM al mismo tiempo, de manera que deben interpretarse como los patrones asociados a cada índice, eliminando la variabilidad (linealmente) explicada por el otro.


```{r compute-regr-pattern}
indices_2d_yearly <- hgt[lev %in% c(main_levs)] %>% 
  .[, time := as.Date(time)] %>% 
  indices_wide[., on = .NATURAL, allow.cartesian = TRUE] %>% 
  .[year(time) >= 1979] %>% 
  .[, rbind(as.data.table(FitLm(hgt_a, sym, asym, se = TRUE)),
            as.data.table(FitLm(hgt_a, full, se = TRUE))),
    by = .(lon, lat, lev)] %>% 
  rm_intercept() %>% 
  .[, p.val := Pvaluate(estimate, std.error, df, "fdr"), by = .(term, lev)] %>% 
  periodic(lon = c(0, 360)) %>% 
  .[, term := factor_sam(term)] %>% 
  .[, season := "Anual"]
```

(ref:2d-regr-cap) Regresión de altura geopotencial (metros) en 50 hPa (fila a) y 700 hPa (fila b) con el SAM (columna 1), A-SAM (columna 2) y S-SAM (columna 3) para el período `r periodo`. Los puntos en panel b.2 indican la posición de los puntos de referencia usados por @raphael2004 para calcular su índice de la onda zonal 3.

```{r 2d-regr, fig.width=6, fig.height=6, warning=FALSE}
gdata <- indices_2d_yearly %>% 
  .[lat <= -20] %>% 
  .[lev %in% c(50, 700)] %>%
  .[, lev := as.numeric(lev)] %>% 
  .[, term := factor_sam(term)] 

ggplot(gdata[lev == 50], aes(lon, lat)) +
  scale_fill_divergent_discretised(name = "50 hPa",
                                   guide = guide_colorsteps_bottom()) +
  geom_contour_fill(aes(z = estimate, fill = after_stat(level)),
                    breaks = AnchorBreaks(0, exclude =  0)) +
  geom_contour_tanaka(aes(z = estimate),
                      breaks = AnchorBreaks(0, exclude =  0),
                      size = 0.3) +
  tag_facets("panel", tag_levels = "1", tag_prefix = "a.") +
  
  ggplot(gdata[lev == 700], aes(lon, lat)) +
  scale_fill_divergent_discretised(name = "700 hPa",
                                   guide = guide_colorsteps_bottom()) +
  geom_contour_fill(aes(z = estimate, fill = after_stat(level)),
                    breaks = AnchorBreaks(0, exclude =  0)) +
  geom_contour_tanaka(aes(z = estimate),
                      breaks = AnchorBreaks(0, exclude =  0),
                      size = 0.3) +
  geom_point(data = data.frame(lon = ConvertLongitude(c(50, 166, -76)),
                               lat = -49,
                               term = factor_sam("asym"),
                               lev = as.numeric(700)) %>%
               periodic(lon = c(0, 360)),
             shape = 21, size = 2.5, color = "black", fill = "#de3e80") +
  tag_facets("panel", tag_levels = "1", tag_prefix = "b.") &
  geom_qmap(~.x[lat <= -20]) &
  annotate_grid() &
  scale_x_longitude(labels = NULL) &
  scale_y_latitude(limits = c(NA, -20), labels = NULL) &
  scale_linetype(guide = "none") &
  coord_polar2() &
  facet_grid(lev ~ term, labeller = labeller(lev = lab_lev, term = lab_sam)) &
  # tag_facets("cr", position = list(x = 0.15, y = 0.85)) &
  theme(panel.grid = element_blank())  &
  plot_layout(ncol = 1)
```

En la estratosfera, el patrón espacial descrito por la regresión asociada al SAM está claramente dominado por un monopolo que no está centrado en el Polo Sur (Fig. \@ref(fig:2d-regr)a.1).
En cambio, el patrón asociado a la parte asimétrica del SAM se caracteriza por una estructura de onda-1 con centros sobre el Pasaje de Drake en el Hemisferio Occidental y el Mar de Davis en el Hemisferio Oriental.
Este eje se alinea con el defasaje del monopolo encontrado para el SAM (Fig. \@ref(fig:2d-regr).a.1).
Por otra parte, el patrón asociado al S-SAM, es un monopolo más simétrico que el encontrado para el SAM aunque tampoco perfectamente centrado en el Polo Sur.

```{r compute-raphael}
raphael <- ReadNetCDF(ERA5_geopotential(), 
                      subset = list(time = range(indices_wide$time),
                                    latitude = -49,
                                    level = 500),
                      vars = c(hgt = "z")) %>% 
  .[, hgt := hgt/9.8] %>% 
  normalise_coords() %>% 
  na.omit() %>% 
  .[, hgt := hgt/9.8] %>% 
  .[, time := as.Date(time)] %>% 
  .[, hgt := Anomaly(hgt), by = .(lat, time)] %>% 
  .[lon %~% ConvertLongitude(c(50, 166, -76))] %>%   # 50°E, 166°E and 76°W. 
  .[, hgt_s := frollmean(hgt, 3, NA, align = "center"), by = .(lon, lat)] %>% 
  na.omit() %>% 
  .[, hgt_s := scale(hgt_s), by = .(lon, lat, month(time))] %>% 
  .[, .(raphael = mean(hgt_s)), by = time] 

cor_raphael <- raphael[indices_wide[lev == 500], on = "time"] %>% 
  na.omit() %>% 
  .[, correlate(asym, raphael)]

```

En la troposfera, el patrón espacial descrito por la regresión asociada al SAM (Fig. \@ref(fig:2d-regr)b.1) muestra la ya conocida combinación de una estructura anular zonalmente simétrica en la zona polar con asimetrías zonales en forma de onda-3 en las latitudes medias [@fogt2012].
Los patrones asociados a los índices A-SAM y S-SAM separan ambas estructuras claramente.
El A-SAM se ve asociado a un patrón de onda zonal 3 y de amplitud modulada por la longitud; con mayor amplitud en hemisferio occidental y casi nula amplitud en el oriental.
El S-SAM, por su parte, se asocia a una estructura anular mucho más zonalmente simétrica que el SAM.
Se encontró que el patrón de onda-3 asociado con el A-SAM (Figura \@ref(fig:2d-regr)b.2) está girado media longitud de onda respecto a la posición media del patrón de onda-3 medio descrito por @raphael2004, cuyas posiciones de referencia están marcadas con puntos en la figura.
De hecho, no existe correlación entre el índice de @raphael2004 y el A-SAM (cor = `r cor_raphael$text`).
Así, el índice A-SAM troposférico representa un desplazamiento zonal en la posición de la onda 3 climatológica.

(ref:wave-amplitude-cap) Amplitud (metros) de las ondas zonales de los patrones de regresión de altura geopotencial de la Figura \@ref(fig:2d-regr) para ondas zonales con número de onda 0, 1, 2 y 3, donde el número de onda 0 representa la amplitud de la media zonal.

```{r wave-amplitude, fig.width=4, fig.height=3}
indices_2d_yearly %>% 
  .[lat < -20] %>%
  .[lev %in% c(50, 700)] %>% 
  .[, FitWave(estimate, 0:3), by = .(lat, lev, term)] %>% 
  ggplot(aes(lat, amplitude)) +
  geom_line(aes(color = factor(k)), size = 1) +
  scale_color_brewer("Número de onda", palette = "Set1") +
  scale_y_continuous("Amplitud") +
  scale_x_latitude(ticks = 20) +
  coord_flip() +
  facet_grid(lev~term, labeller = labeller(term = lab_sam, lev = lab_lev)) +
  tag_facets("rc", position = "tr") +
  panel_background() +
  theme(panel.spacing = grid::unit(0.5, "lines"))
```

La amplitud de las ondas zonales con números de onda 0 a 3 en cada latitud a 50 hPa y 700 hPa se muestran en la Figura \@ref(fig:wave-amplitude), donde el número de onda cero representa la amplitud de la media zonal.
Las amplitudes de las ondas zonales del patrón espacial asociado al SAM (Fig. \@ref(fig:wave-amplitude) columna 1) están dominadas por la media zonal (número de onda 0) en ambos niveles.
Sin embargo, las ondas zonales son importantes, sobre todo al sur de 50ºS, con un número de onda 1 claramente dominante en 50 hPa (Fig. \@ref(fig:wave-amplitude)a.1) y una mezcla de ondas de amplitud similar en 700 hPa (Fig. \@ref(fig:wave-amplitude)b.1).
La Figura \@ref(fig:wave-amplitude) columna 2 muestra que el A-SAM está dominado principalmente por la onda 1 en la estratosfera (Fig. \@ref(fig:wave-amplitude)a.2), mientras que en la troposfera se explica por una combinación de ondas zonales 3 a 1 en nivel decreciente de importancia (Fig. \@ref(fig:wave-amplitude)b.2) con una amplitud despreciable de la media zonal.
Por otra parte, el S-SAM se explica casi en su totalidad por la media zonal en ambos niveles (Fig. \@ref(fig:wave-amplitude) columna 3), con poca o ninguna contribución de las ondas zonales con números de onda de 1 a 3.

```{r compute-vertical-regression}
indices_wide %>% 
  copy() %>% 
  setnames("lev", "index_level") -> indices_for_regr

vertical_regr <- ReadNetCDF(ERA5_geopotential(), 
                            subset = list(time = range(indices_wide[year(time) >= 1979]$time),
                                          latitude = c(-65, -40)),
                            vars = c(hgt = "z")) %>% 
  .[, hgt := hgt/9.8] %>% 
  normalise_coords() %>% 
  .[, time := as.Date(time)] %>% 
  na.omit() %>% 
  .[, .(hgt = weighted.mean(hgt, w = cos(lat*pi/180))), by = .(lon, lev, time)] %>% 
  .[, hgt := hgt/9.8] %>% 
  .[, hgt_a := Anomaly(hgt), by = .(lon, lev, month(time))] %>% 
  indices_for_regr[., on = .NATURAL, allow.cartesian = TRUE] %>% 
  .[, FitLm(hgt_a, asym, se = TRUE),
    by = .(lon, lev, index_level)] %>% 
  rm_intercept() %>% 
  .[, p.val := Pvaluate(estimate, std.error, df, "fdr"), by = .(term, index_level, lev)] %>% 
  .[, term := factor_sam(term)] 
```

(ref:vertical-regression-cap) Regresión de las anomalías mensuales de altura geopotencial promediada entre 65ºS y 45ºS (metros) y el índice A-SAM de 50 hPa (a) y 700 hPa (b) (niveles indicados en línea punteada) para el período `r periodo`.

```{r vertical-regression, fig.width = 4, fig.height=3}
vertical_regr %>% 
  .[index_level %in% c(50, 700)] %>% 
  .[term == "asym"] %>%
  .[, index_level := as.integer(index_level)] %>% 
  # wrap() %>% 
  ggplot(aes(lon, lev)) +
  geom_contour_fill(aes(z = estimate, fill = ..level..), breaks = AnchorBreaks(0, 1, 0)) +
  geom_contour_tanaka(aes(z = estimate),
                      breaks = AnchorBreaks(0, 1, 0),
                      size = 0.3) +
  geom_hline(data = data.frame(lev = c(50, 700),
                               index_level = c(50, 700)), 
             aes(yintercept = lev), linetype = 2, color = "gray50") +
  # geom_contour2(aes(z = p.val), breaks = 0.01) +
  scale_fill_divergent_discretised(NULL, 
                                   guide = guide_colorsteps_bottom(13)) +
  # oob = scales::squish,
  scale_y_level() +
  scale_x_longitude(ticks = 60)  +
  facet_grid(index_level~., labeller = labeller(index_level = lab_lev)) +
  tag_facets(position = "bl") +
  theme(panel.spacing = grid::unit(1, "lines"))
```

La estructura vertical de las anomalías de altura geopotencial asociadas al índice A-SAM se analizaron con mayor profundidad a través de una sección transversal vertical de regresiones de anomalías de altura geopotencial promediadas entre 65ºS y 40ºS con el índice A-SAM de 50 hPa (Fig. \@ref(fig:vertical-regression)a) y con el índice A-SAM de 700 hPa (Fig. \@ref(fig:vertical-regression)b).
Las anomalías de altura geopotencial asociadas al A-SAM estratosférico (Fig. \@ref(fig:vertical-regression)a) están claramente limitadas a la estratosfera, lo que subraya el desacoplamiento entre el A-SAM estratosférico y el troposférico.
La estructura vertical de esta señal se inclina unos 60 grados hacia el oeste entre 100 hPa y 1 hPa, lo que sugiere procesos baroclínicos.
La señal en la estratosfera maximiza cerca de 10 hPa a pesar de utilizar el índice de 50 hPa para la regresión.

El A-SAM troposférico (Fig. \@ref(fig:vertical-regression)b) presenta señales significativas que se extienden hacia arriba hasta los niveles más altos del reanálisis.
En la troposfera, la estructura de la onda 3 es barotrópica equivalente, con una amplitud máxima en torno a los 250 hPa.
Las anomalías son mayores en el hemisferio occidental, donde se extienden hasta la estratosfera.
En el hemisferio oriental, la señal de la onda 3 es menor y se limita a la troposfera, mientras que las anomalías negativas dominan en la estratosfera.
Aunque el índice A-SAM troposférico está asociado a anomalías geopotenciales estratosféricas, éstas no se proyectan fuertemente sobre el A-SAM estratosférico.
Las estructuras mostradas en la Figura \@ref(fig:vertical-regression) son robustas a la elección del nivel del índice.
Para cualquier índice estratosférico (por encima de 100 hPa), las anomalías resultantes son muy similares a la estructura de onda-1 con máximo cerca de 10 hPa en la Figura \@ref(fig:vertical-regression)a.
Por el contrario, para cualquier índice troposférico (por debajo de 100 hPa), el resultado es muy similar al de la Figura \@ref(fig:vertical-regression)b.
Los patrones cambian principalmente en amplitud (no se muestra).

```{r enso-cor}
enso <- ENSO() %>% 
  fread() %>% 
  .[, time := as.Date(time)]

enso_sam_cor <- enso %>% 
  .[indices, on = "time", allow.cartesian = TRUE] %>% 
  .[lev == 700] %>% 
  .[, with(cor.test(estimate, oni), 
           list(cor = estimate, 
                p.value = p.value)), by = .(lev, term)] %>% 
  .[, type := "Correlation"] %>% 
  .[, season := "Año"] %>% 
  .[, lev := NULL]

enso_sam_cor_season <- enso %>% 
  .[indices, on = "time", allow.cartesian = TRUE] %>% 
  .[lev == 700] %>% 
  .[, with(cor.test(estimate, oni), 
           list(cor = estimate, 
                p.value = p.value)), by = .(lev, term, season(time, "es"))] %>% 
  .[, type := "Correlation"] %>% 
  .[, lev := NULL]


enso_sam_partial <- enso %>% 
  .[indices_wide[lev == 700], on = "time"] %>% 
  .[, partial_cor(oni, asym, sym)] %>% 
  setnames("partial_correlation", "cor") %>% 
  .[, type := "Partial Correlation"] %>% 
  .[, season := "Año"] 


enso_sam_partial_season <- enso %>% 
  .[indices_wide[lev == 700], on = "time"] %>% 
  .[, partial_cor(oni, asym, sym), by = .(season(time, "es"))] %>% 
  setnames("partial_correlation", "cor") %>% 
  .[, type := "Partial Correlation"] 


enso_cors <- rbind(enso_sam_cor, 
                   enso_sam_cor_season, 
                   enso_sam_partial,
                   enso_sam_partial_season, use.names = TRUE) %>% 
  .[type == "Partial Correlation" | term == "full"]

cor_texts <- enso_cors %>% 
  copy() %>% 
  .[, p.value := p.adjust(p.value, "fdr")] %>% 
  .[, cor := round(cor, 2)] %>% 
  .[, p.value := report_p(p.value)] 
```

(ref:enso-cor-table-cap) Correlación entre los índices del SAM y el ONI considerando todos los meses y para cada estación por separado. Entre parentéresis se indican los p-valores ajustado por FDR).  En negrita, se indican las correlaciones con p-valores menores a 0,01.

```{r enso-cor-table}
table <- enso_cors %>% 
  copy() %>% 
  .[, p.value := p.adjust(p.value, "fdr")] %>% 
  .[, p.value := paste0("(", scales::pvalue(p.value, decimal.mark = ","), ")")] %>% 
  .[, cor_text := scales::number(cor, 0.01, decimal.mark = ",")] %>% 
  .[, term := lab_sam[term]] %>% 
  .[] %>% 
  melt(id.vars = c("term", "season" ), measure.vars = c("cor_text", "p.value")) %>% 
  dcast(season + variable ~ term, value.var = "value") %>% 
  .[, variable := NULL] %>% 
  setcolorder(c("season", lab_sam))


table2 <- enso_cors %>% 
  copy() %>% 
  .[, p.value := p.adjust(p.value, "fdr")] %>% 
  
  .[, term := lab_sam[term]] %>% 
  dcast(season ~ term, value.var = "p.value") %>% 
  setcolorder(c("season",lab_sam))

if (is_word()) {
  table %>% 
    flextable::flextable() %>% 
    flextable::set_caption("(ref:enso-cor-table-cap)")
} else {
  table %>% 
    kbl(align = "c", 
        caption = "(ref:enso-cor-table-cap)", 
        col.names = c("", lab_sam), booktabs = TRUE) %>%
    kable_classic_2(full_width = F) %>%
    column_spec(2, bold = rep(table2[, 2] < 0.01, each = 2)) %>%
    column_spec(3, bold = rep(table2[, 3] < 0.01, each = 2)) %>%
    column_spec(4, bold = rep(table2[, 4] < 0.01, each = 2)) %>%
    collapse_rows(columns = 1:2, valign = "top") %>% 
    add_header_above(c(" " = 1, "Correlación" = 1, 
                       "Correlación parcial" = 2)) 
}
```

El patrón de la onda 3 de la Figura \@ref(fig:2d-regr)b.2 es muy similar al PSA [@mo1987; @kidson1988], que es un patrón de teleconexión asociado al ENSO [@karoly1989].
Como se mencionó en la introducción de este capítulo, existen evidencias previas de que la actividad del ENSO y el SAM pueden estar relacionadas [@silvestri2009; @fogt2011a].
Se analizó entonces la relación entre el SAM y sus componentes y el ENSO (medido por el Índice del Niño Oceánico [ONI, @bamston1997]) y se muestra en la Tabla \@ref(tab:enso-cor-table) para cada índice SAM y para cada trimestre y para todo el año.
Mientras que la correlación es significativa entre el SAM completo y ENSO considerando todo el año, solamente es significativa para los trimestres  DEF y SON.
Se encontró que esta relación es captada principalmente por el A-SAM, ya que este índice presenta correlaciones parciales significativas con el ENSO, mientras que las correlaciones con el S-SAM son todas menores y no significativas.
Incluso en los trimestres donde la correlación entre SAM y ENSO es esencialmente nula (MAM y JJA), la correlación parcial entre el A-SAM y el ONI es mucho más alta; en efecto, en MAM  es significativa al nivel del 95%.
El mismo análisis se realizó utilizando el Índice ENSO Multivariado [@wolter2011] y el Índice de Oscilación del Sur [@ropelewski1987], obteniendo resultados similares.
Esto último indica que estos resultados no dependen del índice ENSO utilizado.

### Impactos {#impacts}

Para evaluar las diferencias en los impactos asociados a los índices SAM, A-SAM y S-SAM, se realió una regresión de la temperatura del aire a 2 metros y la precipitación sobre cada uno de los tres índices del SAM de 700 hPa.
Como se mostró en secciones anteriores, los tres índices son muy coherentes en la troposfera, por lo que se seleccionó este nivel para representar la circulación troposférica por compatibilidad con la literatura previa.
Las regresiones se realizaron sin quitarle la tendencia ni a las variables ni a los índices, pero el cálculo de las regresiones con valores sin tendencias no muestran diferencias importantes (no se muestra).

#### Temperatura del aire a 2 metros

La Figura \@ref(fig:regr-air-season) muestra las regresiones con la temperatura del aire a 2 metros.
En verano, los valores positivos del índice SAM (Fig. \@ref(fig:regr-air-season)a.1) se asocian con anomalías negativas de temperatura cerca de la Antártida rodeadas por un anillo de anomalías positivas en las latitudes medias.
El anillo no es zonalmente simétrico, ya que hay cuatro máximos locales distintivos en torno a 30ºO, 120ºO, 150ºE y 90ºE respectivamente.
En los trópicos, las anomalías son negativas en el Pacífico ecuatorial, lo que concuerda con la correlación negativa entre SAM y ENSO observada en la Tabla \@ref(tab:enso-cor-table).
Los paneles a.2 y a.3 de la Figura \@ref(fig:regr-air-season) muestran que tanto las anomalías negativas en los trópicos como las anomalías entre 45ºS y 60ºS están asociadas principalmente con el A-SAM y que el S-SAM está asociado a anomalías de temperatura extendidas más zonalmente simétricas en latitudes altas.
Sobre la Antártida, los valores positivos del índice SAM están asociados a anomalías negativas de temperatura, en particular sobre la costa oriental.
Estas anomalías están explicadas únicamente con el S-SAM.
Por otro lado, las anomalías de temperatura en el océano Índico, el sur de África y Australia están fuertemente relacionadas con A-SAM y no están presentes en el patrón asociado con el SAM.

```{r compute-air-regr}
time_subset <- list(time = range(indices[year(time) >= 1979]$time))

air <- ERA5_T2M() %>% 
  ReadNetCDF(vars = c("air" = "t2m"), 
             subset = c(time_subset, list(latitude = c(-90, 20)))) %>% 
  normalise_coords() %>% 
  .[, time := as.Date(time)]

air_regr <- air %>% 
  # .[, air := Anomaly(air), by = .(lon, lat)] %>%
  .[indices_wide[lev == 700], on = .NATURAL] %>% 
  # mei[., on = .NATURAL] %>% 
  rm_singleton() %>% 
  .[year(time) >= 1979] %>% 
  .[, lapply(.SD, mean, na.rm = TRUE), by = .(lon, lat, time = seasonally(time))] %>%
  .[, rbind(as.data.table(FitLm(air, asym, sym, se = TRUE)),
            as.data.table(FitLm(air, full, se = TRUE))),
    by = .(lon, lat, season(time, "es"))] %>% 
  rm_intercept() %>% 
  .[, term := factor_sam(term)]
```

(ref:regr-air-season-cap) Regresión de las anomalías de temperatura a dos metros (K) con el índice SAM (columna a), A-SAM (columna b) y S-SAM (columna c) en cada trimestre para el período `r periodo`. `r pval_contours()`. La escala de colores se corta en $\pm0,6 \mathrm{K}$ para resaltar valores de regresión en los trópicos y latitudes medias a expensas de los valores en las regiones polares.

```{r regr-air-season, fig.width = 6, fig.height = 8}
anchor_limits <- function(anchor = 0, binwidth = NULL, exclude = NULL,  bins = 10,
                          range = c(NA, NA), sym = TRUE) {
  force(range)
  force(anchor)
  force(binwidth)
  force(exclude)
  force(bins)
  function(x, binwidth2 = NULL) {
    if (sym) {
      D <- max(abs(x[1] - anchor), abs(x[2] - anchor))
      x <- c(anchor - D, anchor + D)
    }
    
    
    if (!is.null(binwidth)) binwidth2 <- binwidth
    if (is.null(binwidth2)) {
      binwidth2 <- diff(pretty(x, bins))[1]
    }
    
    mult <- ceiling((x[1] - anchor)/binwidth2) - 1L
    start <- anchor + mult*binwidth2
    b <- seq(start, x[2] + binwidth2, binwidth2)
    b <- b[!(b %in% exclude)]
    
    if (!is.na(range[1])) {
      m <- min(b)
      b <- c(b[b >= (range[1] + 1e-9)], -Inf)  # DAMN YOU FLOATING POINT ERRORS!!! 
    }
    
    if (!is.na(range[2])) {
      m <- max(b)
      b <- c(b[b <= (range[2] - 1e-9)], Inf)
    }
    sort(b)
    
  }
}

air_regr %>% 
  copy() %>% 
  .[, p.value := Pvaluate(estimate, std.error, df, "fdr"), by = .(term, season)] %>% 
  periodic(lon = c(0, 360)) %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = estimate, fill = ..level..), 
                    breaks = anchor_limits(0, 0.1, 0, range = c(-.6, 0.6))) +
  geom_contour_pval(aes(z = p.value)) +
  geom_qmap(~.x[lat <= 0]) +
  annotate_grid() +
  scale_x_longitude(labels = NULL) +
  scale_y_latitude(labels = NULL, limits = c(NA, 0)) +
  scale_fill_divergent_discretised("Temperatura del aire a 2 metros", 
                                   guide = guide_colorsteps_bottom(even.steps = FALSE)) +
  coord_polar2(ymax = 0) +
  facet_grid(season ~ term, labeller = labeller(term = lab_sam, lev = lab_lev)) +
  tag_facets("rc") +
  theme(panel.grid = element_blank()) 

```

En otoño, invierno y primavera (filas b, c y d en la Figura \@ref(fig:regr-air-season)) el SAM está asociado a anomalías de temperatura con estructura zonalmente asimétrica en latitudes altas, con valores negativos sobre la Antártida y el Mar de Amundsen y positivas al sur de Nueva Zelanda y centradas en el pasaje de Drake que se extienden hasta la Patagonia.
Esto refleja la naturaleza más asimétrica del SAM durante estas estaciones en comparación al verano.
En acuerdo, @jones2019 observó características similares en las mediciones de estaciones, aunque utilizando datos de 1957 a 2016.
De todas maneras, en general se observa que la señal sobre la Antártida está asociada al S-SAM (aunque estadísticamente significativa sólo en invierno), mientras que las anomalías sobre el Océano Antártico y latitudes más bajas se asocian al A-SAM.
En primavera, la señal tropical de A-SAM es similar a la del verano, revelando de nuevo la importancia del vínculo ENSO\--A-SAM.

El patrón de anomalías de temperatura negativas en el polo rodeadas de anomalías positivas, evidente aproximadamente en todas las estaciones -aunque con intensidad variable y detalles a pequeña escala-, se traduce en un gradiente de temperatura meridional aumentado que maximiza en la línea cero, lo que es coherente con la intensificación y migración hacia el polo de los vientos del oeste comúnmente vinculados al SAM a través del balance de viento térmico.
Por tanto, no es sorprendente verlo más claramente asociado al S-SAM.
Asimismo, las temperaturas sobre la Antártida Oriental se ven más afectadas por el S-SAM, mientras que en la Antártida Occidental son más sensibles al A-SAM.
Dado que el índice S-SAM está negativamente correlacionado con la temperatura sobre la Antártida Oriental (Figura \@ref(fig:regr-air-season) columna 3), es posible que la tendencia positiva en el índice S-SAM pueda ayudar a explicar la falta de tendencia positiva de la temperatura en la Antártida Oriental en comparación con la Antártida Occidental en el contexto del calentamiento global [@nicolas2014].

#### Precipitación

La Figura \@ref(fig:global-pp) muestra la regresión de los índices SAM con la precipitación para el hemisferio sur considerando todos los meses del año.
La señal de precipitación asociada al SAM completo (Fig. \@ref(fig:global-pp)a) muestra en general una disminución de la precipitación en torno a los 45ºS, un ligero aumento de la precipitación en torno a los 30ºS y un aumento de la precipitación sobre la Antártida, un patrón que concuerda con los obtenidos en otros estudios [p.ej. @hendon2014].
Este patrón se mantiene prácticamente sin cambios entre estaciones, aunque varía en intensidad (no se muestra).
Los paneles b y c de la Figura \@ref(fig:global-pp) muestran que la influencia del A-SAM sólo se da en los trópicos y latitudes medias, mientras que la señal S-SAM es fuerte en las latitudes altas.
En particular, los valores positivos del S-SAM se asocian con el aumento de las precipitaciones sobre la Antártida y la disminución de las precipitaciones alrededor del Océano Austral.

```{r calc-indices2d-seasonal}
indices_2d_seasonal <- hgt[lev %in% 700] %>% 
  indices_wide[., on = .NATURAL, allow.cartesian = TRUE] %>% 
  .[, lapply(.SD, mean, na.rm = TRUE), by = .(lon, lat, time = seasonally(time))] %>% 
  .[, rbind(as.data.table(FitLm(hgt_a, sym, asym, se = TRUE)),
            as.data.table(FitLm(hgt_a, full, se = TRUE))),
    by = .(lon, lat, season(time, "es"))] %>% 
  rm_intercept() %>% 
  .[, p.val := Pvaluate(estimate, std.error, df, "fdr"), by = .(term, season)] %>% 
  periodic(lon = c(0, 360)) %>% 
  .[, term := factor_sam(term)]

indices_2d <- rbind(indices_2d_yearly[lev == 700] %>% .[, lev := NULL], indices_2d_seasonal) %>% 
  .[, season := forcats::fct_relevel(season, "Anual")] 
```

```{r compute-pp-regr}
# pp <- CMAP() %>% 
#   ReadNetCDF(subset = list(lat = c(-90, -20))) %>% 
#   normalise_coords() %>% 
#   .[, precip := Anomaly(precip), by = .(lon, lat)]


continents <- list(africa  = list(lon = c(0, 60),
                                  lat = c(-40, 0)),
                   oceania = list(lon = c(100, 180),
                                  lat = c(-50, -5)),
                   america = list(lon = c(265, 325),
                                  lat = c(-60, -10)))


add_continent <- function(dt) {
  dt[, continent := fcase(lon %between% continents$africa$lon & 
                            lat %between% continents$africa$lat, "africa",
                          lon %between% continents$oceania$lon & 
                            lat %between% continents$oceania$lat, "oceania",
                          lon %between% continents$america$lon &
                            lat %between% continents$america$lat, "america")] %>% 
    .[, continent := factor(continent, levels = c("africa", "oceania", "america"), ordered = TRUE)] %>% 
    .[]
}

cmap <- CMAP() %>% 
  fread() %>% 
  .[, time := as.Date(time)] %>% 
  .[lat %between% c(-90, 0)] %>% 
  .[time %between% range(indices$time)] %>% 
  .[, days := lubridate::days_in_month(time[1]), by = time] 

nas_cmap <- cmap[, .(n_na = sum(is.na(pp))), by = .(lon, lat)]

pp_regr_season <- cmap %>% 
  .[indices_wide[lev == 700], on = .NATURAL] %>% 
  .[time %between% range(cmap$time)] %>% 
  nas_cmap[., on = c("lon", "lat")] %>% 
  .[n_na == 0] %>% 
  .[, lapply(.SD, mean, na.rm = TRUE), by = .(lon, lat, time = seasonally(time))] %>%
  .[, pp_a := Anomaly(pp), by = .(lon, lat, season(time, "es"))] %>%
  # .[, nas := mean(is.na(pp_a)), by = .(lon, lat, season(time, "es"))] %>% 
  # .[nas >= 0.15, precip := NA] %>% 
  # .[is.finite(precip_a)] %>%
  .[, rbind(as.data.table(FitLm(pp_a, asym, sym, se = TRUE)),
            as.data.table(FitLm(pp_a, full, se = TRUE))),
    by = .(lon, lat, season(time, "es"))] %>% 
  rm_intercept() %>% 
  .[, term := factor_sam(term)]

pp_regr_annual <- cmap %>% 
  .[indices_wide[lev == 700], on = .NATURAL] %>% 
  .[time %between% range(cmap$time)] %>% 
  nas_cmap[., on = c("lon", "lat")] %>% 
  .[n_na == 0] %>% 
  .[, pp_a := Anomaly(pp, na.rm = TRUE), by = .(lon, lat, month(time))] %>%
  # .[, nas := mean(is.na(pp_a)), by = .(lon,  lat)] %>%
  # .[nas >= 0.15, precip := NA] %>% 
  # .[is.finite(precip_a)] %>%
  .[, rbind(as.data.table(FitLm(pp_a, asym, sym, se = TRUE)),
            as.data.table(FitLm(pp_a, full, se = TRUE))),
    by = .(lon, lat)] %>% 
  rm_intercept() %>% 
  .[, term := factor_sam(term)] %>% 
  .[, season := "Anual"]


pp_regr <- rbind(pp_regr_season, pp_regr_annual) %>% 
  .[, season := forcats::fct_relevel(season, "Anual")] 
```

```{r pp-enso-patterns, eval=FALSE, include=FALSE}
# This computation is not part of the paper, but was used as an answer to a reviewr. 
pp_patterns <- enso  %>% 
  .[cmap, on = "time"] %>% 
  .[, lapply(.SD, mean, na.rm = TRUE), by = .(lon, lat, time = seasonally(time))] %>% 
  na.omit() %>% 
  .[, FitLm(pp_a, oni), by = .(lon, lat, season(time, "es"))] %>% 
  rm_intercept() %>% 
  add_continent() %>% 
  .[continent %in% names(continents)[-1]] 

# pp_patterns %>%
#   .[continent == "america"] %>%
#   ggplot(aes(lon,lat)) +
#   geom_contour_fill(aes(z = estimate)) +
#   facet_wrap(season~continent, scales = "free") +
#   scale_fill_divergent()


pp_enso_index <- cmap %>% 
  .[, lapply(.SD, mean, na.rm = TRUE), by = .(lon, lat, time = seasonally(time))] %>%
  add_continent() %>% 
  .[continent %in% names(continents)[-1]] %>% 
  na.omit() %>% 
  .[, continent := NULL] %>% 
  .[, season := season(time, "es")] %>% 
  .[pp_patterns, on = c("lon", "lat", "season")] %>% 
  .[, mean(estimate*pp_a), by = .(time, continent)]


cors_enso_pp <- pp_enso_index %>%
  dcast(time ~ continent, value.var = "V1") %>%
  .[, cor(oceania, america), by = season(time, "es")] %>% 
  .[, label := paste0(season, " (cor=", signif(V1, 2), ")")]

pp_enso_index %>%
  dcast(time ~ continent) %>%
  .[, season := season(time, "es")] %>%
  ggplot(aes(oceania, america)) +
  geom_point() +
  geom_smooth(method = "lm") +
  scale_x_continuous("Oceania index") +
  scale_y_continuous("America Index") +
  facet_wrap(~season, scales = "free", labeller = labeller(season= setNames(cors_enso_pp$label,
                                                                            cors_enso_pp$season)))


```

(ref:global-pp-cap) Regresión de anomalías de precipitación (mm por día) con el SAM (a), A-SAM (b) y S-SAM (c) para el período `r periodo`. En gris, las zonas con valores faltantes. `r pval_contours()`. La escala de colores se corta en $\pm0,25 \mathrm{K}$ para resaltar valores de regresión en los trópicos y latitudes medias a expensas de los valores en las regiones polares.

```{r global-pp, fig.width=6, fig.height=3.3}
discrete_div_pp <- colorRampPalette(c("#8E521C", "white", "#00665E"))

breaks_pp <- sort(c(seq(-0.25, 0.25, by = 0.05), -0.7, 0.75))
breaks_pp <- breaks_pp[breaks_pp != 0]

lons <- c(0, unique(pp_regr$lon), 360)
pp_regr %>%
  .[season == "Anual"] %>%
  .[, p.value := Pvaluate(estimate, std.error, df, "fdr"), by = .(season, term)] %>% 
  periodic(lon = c(1.25, 360 + 1.25)) %>%
  wrap() %>%
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = estimate, fill = ..level..), 
                    breaks = anchor_limits(0, 0.05, 0, range = c(-0.25, 0.25))) +
  # stat_subset(aes(subset = is.na(estimate)), geom = "tile", color = "gray50") +
  geom_contour_pval(aes(z = p.value), p.value = 0.05, pattern_spacing = 0.05) +
  geom_contour_filled(aes(z = n_na, fill = NA), 
                      data = nas_cmap %>% 
                        periodic(lon = c(1.25, 360 + 1.25)) %>%
                        wrap(),
                      breaks = c(0.5, 600), 
                      fill = "gray50") +
  geom_contour2(aes(z = n_na), 
                data = nas_cmap %>% 
                  periodic(lon = c(1.25, 360 + 1.25)) %>%
                  wrap(),
                breaks = c(0.5), fill = "black", size = 0.1) +
  geom_qmap(~.x[lat <= 0], keep = 0.015, weighting = 0.9) +
  scale_x_longitude(breaks = NULL) +
  scale_y_latitude(breaks = NULL, limits = c(-90, NA)) +
  # discrete_scale("fill", "name", name = "Precipitación",
  #                palette = discrete_div_pp,
  #                guide = guide_colorsteps_bottom(show.limits = TRUE, even.steps = FALSE)) +
  scale_fill_divergent_discretised("Precipitación",
                                   low = "#8E521C", high = "#00665E",
                                   guide = guide_colorsteps_bottom(even.steps = FALSE)) +
  scale_linetype(guide = "none") +
  coord_polar2(ymax = 0) +
  annotate_grid() +
  # coord_quickmap(ylim = c(NA, 0)) +
  facet_grid(.~term, labeller = labeller(term = lab_sam)) +
  # tag_facets("panel", position = "tl")  +
  tag_facets("panel") +
  theme(panel.grid = element_blank()) 
```

Para estudiar con más detalle los impactos locales en distintas regiones continentales del hemisferio sur, las Figuras \@ref(fig:pp-regr-oceania) y \@ref(fig:pp-regr-america) muestran la regresión de los índices SAM con la precipitación media estacional y la altura geopotencial de 700 hPa para la región de Oceanía, y Sudamérica respectivamente.
No se muestran los resultados para la región de Sudáfrica porque allí no se detectó ninguna señal significativa.

```{r plot_pp}
plot_pp <- function(this_continent, data = pp_regr) {
  gh <- indices_2d %>% 
    copy() %>%
    .[, c("u", "v") := GeostrophicWind(estimate, lon, lat, cyclical = TRUE), by = .(term, season)] %>%
    add_continent() %>% 
    .[continent == this_continent] 
  
  gdata <- data %>%
    .[term != "mei"] %>% 
    add_continent() %>% 
    # .[lat <= -10] %>% 
    .[continent == this_continent] %>%
    .[, p.value := Pvaluate(estimate, std.error, df, "fdr"), by = .(season, continent, term)]
  
  
  gdata %>%   
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = estimate, fill = ..level..), na.fill = 0, 
                      breaks = anchor_limits(0, 0.1, 0, range = c(-.8, 0.8))) +
    stat_subset(aes(subset = is.na(estimate)), geom = "tile", color = "gray50") +
    # geom_raster(aes(fill = estimate/30)) +
    geom_contour_pval(aes(z = p.value), pattern_spacing = 0.05) +
    # geom_contour_fill(aes(z = as.numeric(is.na(estimate))), breaks = 1) +
    # stat_subset(aes(subset = p.value <= 0.05 & is.cross(lon, lat, 2)), size = 0.4, alpha = 0.8) +
    geom_contour2(data = gh, breaks = MakeBreaks(bins = 15, exclude = 0),
                  color = "gray50", size = 0.2, global.breaks = FALSE, 
                  aes(z = estimate, linetype = factor(-sign(..level..)))) +
    geom_text_contour(data = gh, breaks = MakeBreaks(bins = 15, exclude = 0),
                      global.breaks = FALSE,
                      size = 2.5, 
                      stroke = 0.15, stroke.color = "white",
                      aes(z = estimate), rotate = FALSE, skip = 1) +
    geom_qmap(~.x[lat <= 10]) +
    scale_x_longitude(ticks = 15, minor_breaks = NULL) +
    scale_y_latitude(ticks = 10,  minor_breaks = NULL) +
    # discrete_scale("fill", "name", name = "Precipitación",
    #             palette = discrete_div_pp,
    #             guide = guide_colorsteps_bottom(show.limits = TRUE, even.steps = FALSE)) +
    scale_fill_divergent_discretised("Precipitación",
                                     # limits = c(-.8, .8),
                                     # oob = scales::squish,
                                     low = "#8E521C",
                                     high = "#00665E",
                                     # label = scales::percent_format(),
                                     guide = guide_colorsteps_bottom(even.steps = FALSE)) +
    
    scale_linetype(guide = "none") +
    coord_sf(xlim = continents[[this_continent]]$lon,
             ylim = continents[[this_continent]]$lat) +
    facet_grid(season ~ term, labeller = labeller(term = lab_sam, lev = lab_lev)) +
    tag_facets("rc", position = "bl")  +
    axis_labs_smol() 
}
```

(ref:pp-regr-oceania-cap) Regresión de anomalías de precipitación (mm por día, sombrado) y anomalías de altura geopotencial (líneas finas, valores positivos en líneas llenas y negativos en líneas punteadas) para todo el año (fila a) y medias estacionales (filas b a e) con el SAM (columna 1), A-SAM (columna 2) y S-SAM (columna 3) para el período `r periodo`. Nueva Zelanda e islas aledañas. `r pval_contours()`.

```{r pp-regr-oceania, fig.width = 6, fig.height = 6.5, dependson="plot_pp"}
plot_pp("oceania") 

```

En Oceanía, la regresión anual muestra que el índice SAM está asociado con anomalías positivas de precipitación en la región sudeste de Australia (Fig. \@ref(fig:pp-regr-oceania)a.1), en acuerdo con @gillett2006.
La separación entre A-SAM y S-SAM sugiere que esta anomalía positiva se explica por el S-SAM sólo en la costa este (Fig. \@ref(fig:pp-regr-oceania)a.3).
Las anomalías de altura geopotencial asociadas a este índice (contornos negros) son indicativas de un flujo hacia el oeste procedente del mar de Tasmania, lo que podría explicar las anomalías positivas en las precipitaciones, en acuerdo con @hendon2007.
El A-SAM parece estar relacionado con anomalías positivas de precipitación en la costa sureste de Australia (Fig. \@ref(fig:pp-regr-oceania)a.2), que podrían explicarse de forma similar por la circulación anómala del oeste que transporta aire húmedo al continente desde el océano Índico.

Las regresiones estacionales muestran valores altos pero no estadísticamente significativos.
En SON, valores positivos del SAM se asocian con anomalías positivas de precipitación en el este y centro de Australia (Fig. \@ref(fig:pp-regr-oceania)e.1).
En este trimestre, el S-SAM parece estar asociado con anomalías positivas de precipitación en un área relativamente reducida de la costa oriental (Fig. \@ref(fig:pp-regr-oceania)e.3) mientras que las anomalías positivas de precipitación relacionadas con A-SAM positivo afectan a todo el este de Australia (Fig. \@ref(fig:pp-regr-oceania)e.2).

En verano, un índice SAM positivo se asocia con anomalías de precipitación positivas en Australia occidental y oriental, sobre todo en la región noreste (Fig. \@ref(fig:pp-regr-oceania)b.1).
La parte oriental está dominada por la relación con el S-SAM y la occidental, por el A-SAM.
En otoño, la regresión con el SAM muestra anomalías positivas en el norte, similares a las de verano, que se asocian con el A-SAM.
En invierno los coeficientes de regresión son mucho más débiles que durante el resto del año.
Ninguno de estos coeficientes de regresión es estadísticamente significativo al nivel del 95%.
La señal de la primavera coincide en líneas generales con @hendon2007, pero mientras que ellos también detectaron una fuerte señal en verano, la Figura \@ref(fig:pp-regr-oceania)b.1 no muestra ninguna asociación estadísticamente significativa (aunque los coeficientes tienen un signo coherente).

(ref:pp-regr-america-cap) Igual que la Figura \@ref(fig:pp-regr-oceania) pero para Sudamérica.

```{r pp-regr-america, fig.width = 6, fig.height = 8.5, dependson="plot_pp"}
plot_pp("america")

```

En Sudamérica (Fig. \@ref(fig:pp-regr-america)), la regresión anual muestra que la fase positiva del SAM está asociada con anomalías de precipitación negativas en el SESA y el sur de Chile, y anomalías positivas en el sudeste de Brasil, alrededor de la posición climatológica de la Zona de Convergencia del Atlántico Sur (SACZ) (Fig. \@ref(fig:pp-regr-america)a.1).
Las figuras \@ref(fig:pp-regr-america)a.2 y a.3 muestran que mientras las señales sobre SESA y el sudeste de Brasil están asociadas significativamente con A-SAM, la del sur de Chile está relacionada con S-SAM.

Las regresiones estacionales reflejan un patrón similar al anual, excepto en invierno.
Aunque no sean estadísticamente significativas, todas las estaciones muestran valores negativos en SESA y el sur de Chile junto con valores positivos en el sur de Brasil en relación con el SAM.
La separación de estas características entre los mapas de regresión del A-SAM y S-SAM es también bastante consistente.
En invierno la señal del SAM es levemente positiva en el SESA y al sur de Chile y levemente negativa en el centro de Chile.

La circulación anómala a 700 hPa asociada al S-SAM (Fig. \@ref(fig:pp-regr-america)a.3) indica un flujo anómalo del este sobre el sur de Chile.
Esto conduce a una menor advección de aire húmedo desde el Océano Pacífico, que es la principal fuente de agua precipitable en esa región [@garreaud2007].
Por otro lado, la circulación anómala asociada a valores positivos del A-SAM (Fig. \@ref(fig:pp-regr-america)a.2) en el Atlántico es anticiclónica al este y ciclónica al oeste de Sudamérica.
Esto promueve un flujo anómalo del sudeste sobre el SESA que inhibe el flujo del chorro de baja altura desde Sudamérica hacia la región [p.ej. @silvestri2009; @zamboni2010].
Se encontró que este mismo patrón está asociado con el aumento de las precipitaciones en el sur de Brasil durante los eventos de SACZ [@rosso2018].

### Relación con los cEOFs {#sam-ceof}

Se evaluó también la relación de los cEOFs presentados en el Capítulo \@ref(ceofs) con los índices del SAM. 
Para ello, se calculó el coeficiente de determinación entre las series temporales de los cEOFs con cada uno de los índices SAM  definidos en cada nivel vertical (Fig. \@ref(fig:sam-eof-vertical)).
Dado que los cEOFs fueron definidos únicamente para el trimestre SON, esto se calculó sólo para estre trimestre. 
El índice SAM está correlacionado de forma estadísticamente significativa con la fase de 0º del cEOF1 en todos los niveles, y con la fase de 90º del cEOF1 y la fase de 90º del cEOF2 en la tropósfera.
Por otro lado, las correlaciones entre el SAM y la fase de 0º del cEOF2 son prácticamente nulas.

```{r ceof}
ceof <- readRDS(data_path("derived", "ceof.Rds"))
```

(ref:sam-eof-vertical-cap) Coeficiente de determinación ($r^2$) entre la fase de 0º (fila a) y 90º (fila b) de los cEOFs con el SAM (línea naranja), A-SAM (línea verde) y S-SAM (línea azul) para cada nivel durante el período `r periodo` para SON. Las líneas gruesas representan valores con p-valor menor a 0,01 ajustado por FDR.

```{r sam-eof-vertical, fig.height=4, fig.width=4}
time <- ceof$left %>%
  sep_ReIm() %>%
  .[, hgt := scale(hgt), by = .(cEOF, part)]

sam_r2 <- indices %>%
  .[, .(estimate = mean(estimate)), by = .(lev, term, time = seasonally(time))] %>% 
  .[time, on = .NATURAL, allow.cartesian = TRUE] %>%
  na.omit() %>% 
  .[, correlate(hgt, estimate), by = .(lev, term, part, cEOF, season(time, "es"))]

max_r2 <- sam_r2[part == "Imaginario"] %>% 
  .[, .SD[which.max(estimate^2)], by = .(cEOF, term, season)]

sam_r2 %>%
  .[, p.value_a := p.adjust(p.value, "fdr")] %>% 
  ggplot(aes(lev, estimate^2)) +
  geom_vline(xintercept = c(50, 200),  size = 0.2, color = "gray50") +
  # geom_point(data = ~.x[p.adjust(p.value, "fdr") < 0.01], aes(color = term)) +
  geom_line(data = ~copy(.x)[p.value_a > 0.01, estimate := NA], 
            aes(colour = stage(term, after_scale = scales::alpha(colour, 0.5))), 
            size = 2) +
  geom_line(aes(color = term, group = term)) +
  
  scale_x_level("Level (hPa)", minor_breaks = NULL) +
  scale_y_continuous(r2, limits = c(0, 1), labels = scales::percent_format(),
                     guide = guide_axis(check.overlap = TRUE)) +
  scale_size_manual("p-value", values = c("TRUE" = 1, 
                                          "FALSE" = 0.5), 
                    guide = "none") +
  scale_color_brewer(NULL, palette = "Dark2", labels = c(full = "SAM",
                                                         asym = "A-SAM",
                                                         sym = "S-SAM")) +
  facet_grid(part ~ cEOF, labeller = labeller(part = lab_cplx)) +
  coord_flip() +
  tag_facets("rc", position = "tr") +
  panel_background() 
```

En la tropósfera la correlación de ambas fases del cEOF1 y el SAM es igual a su correlación con el S-SAM, y su correlación con el A-SAM es mucho más baja y no significativa.
Esto indica que la relación entre el SAM y el cEOF1 en la tropósfera se explica en su totalidad por la componente zonalmente simétrica del SAM.
En la estratosfera, la fase de 0º del cEOF1 está correlacionada tanto con el A-SAM como con la S-SAM, mientras que la fase de 90º está altamente correlacionada sólo con el A-SAM.
Estas correlaciones son consistentes con los mapas de regresión de la altura geopotencial en la Figura \@ref(fig:eof1-regr-gh) y su comparación con los obtenidos para SAM, A-SAM y S-SAM (Fig. \@ref(fig:2d-regr)).

La Figura \@ref(fig:sam-eof-vertical) muestra que el cEOF2 sólo tiene relación con el SAM en su fase de 90º, asociada a la parte asimétrica y únicamente en la tropósfera.
La correlación entre ambos índices es muy alta, con valores superiores al 75% de la varianza compartida en toda la tropósfera y un máximo de `r scales::percent(max_r2[cEOF == "cEOF2" & term == "asym"]$estimate^2, 2)` en `r max_r2[cEOF == "cEOF2" & term == "asym"]$lev` hPa.
Esta altísima correlación es comparable a la correlación observada entre distintos índices del SAM (@ho2012).
Esto sugiere que la fase de 90º del cEOF2 es capaz de caracterizar la actividad de la componente zonalmente asimétrica de el SAM en su totalidad.

## Conclusiones del capítulo \@ref(asymsam)

La división del SAM entre su parte zonalmente asimétrica y simétrica muestra que estos dos aspectos del SAM tienen variabilidad, tendencias e impactos distintivos que merecen ser abordados por separado.

Los patrones asociados al S-SAM son mucho más anulares que los asociados al SAM en toda la atmósfera. 
En la tropósfera, el A-SAM describe un patrón de onda zonal 3 similar al cEOF2 que se extiende verticalmente en toda esta capa y alcanza su máximo en 250 hPa y explica la relación entre el SAM y el ENSO.
En la estratósfera describe un patrón de onda 1 similar al cEOF1. 

La relación entre el SAM y el cEOF1 en la tropósfera se explica en su totalidad por la componente zonalmente simétrica del SAM, mientras que la relación entre el cEOF2 y el SAM se explica por la relación entre la fase de 90º del cEOF2 y la parte asimétrica del SAM.

Esto último sugiere que el A-SAM no es una componente intrínseca del SAM, sino que es la respuesta de la circulación atmosférica a la influencia tropical que aparece reflejado en el primer EOF de las anomalías de altura geopotencial por construcción.

Los principales resultados de este capítulo han sido publicados en @campitelli2022.
