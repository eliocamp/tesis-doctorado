---
knit: purrr::partial(bookdown::render_book, output_format = 'all', preview = TRUE)
---

```{r setup, include=FALSE}
source(here::here("tesis/scripts/globals.R"))

library(knitr)

library(eliotesis)

library(metR)
library(data.table)
library(magrittr)

library(kableExtra)

library(ggplot2)
library(tagger)
library(ggperiodic)
library(ggnewscale)
library(gggrid)
library(patchwork)
library(latex2exp)


main_levs <- c(700, 300, 30, 50)
```

# Estructura simétrica y asimétrica del Modo Anular del Sur {#asymsam}

## Introducción

Como se explicó en la introducción, el patrón espacial del Modo Anular del Sur (SAM) suele describirse en términos de la circulación zonalmente simétrica, sin embargo este patrón tiene asimetrías zonales significativas.
Por otro lado, en el capítulo anterior se observó que algunas fases de los cEOFs están asociadas con patrones tipo SAM en algunos niveles.

El objetivo de este capítulo es, por tanto, describir los componentes zonalmente asimétricos y simétricos de la variabilidad del SAM.
En primer lugar, se propone una metodología que proporciona, para cada nivel, sendos índices que pretenden captar de forma independiente la variabilidad de la componente del SAM simétrica y asimétrica, respectivamente.
Luego se evaluó su estructura vertical y su coherencia, así como su variabilidad temporal y sus tendencias.
A continuación se estudiaron los patrones espaciales asociados a la variabilidad exclusiva de cada índice centrándose en 50 hPa como nivel estratosférico y 700 hPa como nivel troposférico.
Por último, se investigaron las relaciones del SAM a 700 hPa con las anomalías de temperatura y precipitación.

```{r read-hgt}
hgt <- ERA5_geopotential() %>% 
  ReadNetCDF(subset = list(time = main_period,
                           latitude = c(-90, 10),
                           level = as.list(main_levs)),
             vars = c(hgt = "z")) %>% 
  normalise_coords() %>% 
  na.omit() %>% 
  .[, hgt := hgt/9.8] %>% 
  .[, hgt_a := hgt - mean(hgt), by = .(lon, lat, lev, month(time))] %>% 
  .[, time := as.Date(time)] 
```

```{r compute-SAM}
set.seed(42)
SAM <- hgt[lat <= -20] %>% 
  .[lev == 700] %>%
  .[year(time) %between% year(main_period)] %>% 
  .[, hgt := hgt_a*sqrt(cos(lat*pi/180))] %>% 
  .[, .(eof = list(EOF(hgt ~ time | lon + lat, n = 1, data = .SD))), 
    by = .(lev)]

# I need to change the sign
SAM$eof[[1]]$left[, hgt := -hgt]
SAM$eof[[1]]$right[, hgt := -hgt]


dims <- hgt[lat <= -20] %>% 
  .[, .(x = uniqueN(lon), y = uniqueN(lat), t = uniqueN(time))]

```

```{r test-aao1}
# test that my SAM have the correct sign.
aao <- rsoi::download_aao(TRUE, data_path("raw", "aao.csv")) %>% 
  as.data.table() %>% 
  .[, .(time = as.Date(Date), aao = AAO)] %>% 
  .[year(time) >= 1979]

cor_aao <- SAM$eof[[1]]$left %>% 
  .[aao, on = .NATURAL] %>% 
  na.omit() %>% 
  .[, cor(hgt, aao)] 

if (sign(cor_aao) != 1) {
  stop("AAO and full index are not positively correlated!")
}
```

## Métodos

### Regresión segmentada

En la literatura suelen usarse composiciones de eventos positivos y negativos definidos a partir de un determinado límite para para estimar campos la asociación de una variable con la parte positiva y negativa de un índice.
Esta metodología no utiliza todos los datos eficientemente y los resultados son difíciles de interpretar si el valor absoluto típico del índice es mayor para casos positivos que negativos o viceversa.
En vez de eso, en este capítulo calculamos los campos asociados al SAM positivo y negativo utilizando regresión lineal segmentada.
Ésta consiste en ajustar un modelo lineal a tramos con continuidad en cada segmento como se ilustra en la Figura \@ref(fig:segmentada-ejemplo) con datos sintéticos.

```{r segmentada-ejemplo, fig.width=4, fig.height=3}
withr::with_seed(42, 
 {
   N <- 100
   x <- runif(N, -3, 3)
   y <- ifelse(x < 0, 2*x, .5*x) + rnorm(N, sd = 0.5)
   
   data.frame(x = x,
              y = y) %>% 
     ggplot(aes(x, y)) +
     geom_point() +
     geom_smooth(method = "lm", formula = y ~ x + x:sign(x), se = FALSE) +
     scale_x_continuous("X") +
     scale_y_continuous("Y")   
   
 })

```

(ref:segmentada-ejemplo-cap) Ejemplo de regresión segmentada. La relación entre X e Y es lineal pero con distinta pendiente para valores de X positivos y negativos.

Para obtener las pendientes asociadas a la relación lineal para cada signo, ajustamos la ecuación

$$
Y_i = \alpha X_i + \beta X_iI_{X\le 0} + X_0 + \epsilon_i
$$

donde $Y$ e $X$ son las variables dependiente e independiente respectivamente, $\alpha$ es la pendiente asociada a los valores positivos de $X$, $\beta$ es la diferencia entre la pendiente asociada a valores positivos y negativos de $X$, $I_{X\le 0}$ es la función indicador que es 1 cuando $X\le0$ y 0 cuando $X>0$, y $X_0$ y $\epsilon_i$ son la constante y los términos de error.
El coeficiente asociado a valores negativos de X es $\beta - \alpha$.

Esta metodología utiliza todos los datos disponibles.
Además, dado que $\beta$ es la diferencia en la pendiente entre valores positivos y negativos, es posible calcular la insignificancia estadística de la misma.

### Definición de los índices {#definition-of-indices}

El SAM suele definirse como el primer EOF de las anomalías de la presión al nivel del mar o de la altura geopotencial en niveles bajos [@ho2012].
Siguiendo a @baldwin2001, ampliamos esa definición verticalmente y utilizamos el término SAM para referirnos al primer EOF de las anomalías mensuales de altura geopotencial al sur de 20º S en cada nivel.

Para separar la componente zonalmente simétrica y asimétrica del SAM, calculamos la media zonal y las anomalías del patrón espacial completo del SAM, como muestra en la Figura \@ref(fig:method) en 700 hPa.
La señal espacial completa ($\mathrm{EOF_1}(\lambda, \phi)$) es la suma de la componente zonalmente asimétrica ($\mathrm{EOF_1^*}(\lambda, \phi)$) y la simétrica ($[\mathrm{EOF_1}](\lambda, \phi)$).
A continuación, calculamos el índice SAM, el índice SAM asimétrico (A-SAM) y el índice SAM simétrico (S-SAM) como los coeficientes de la regresión de cada campo de altura geopotencial mensual sobre los respectivos patrones (ponderando por el coseno de la latitud).
Finalmente, normalizamos los tres índices dividiéndolos por la desviación estándar del índice SAM en cada nivel.
Como resultado, las magnitudes entre los índices son comparables.
Sin embargo, sólo el índice SAM tiene desviación estándar unitaria por definición.
La varianza explicada por cada patrón se utiliza como indicador del grado de simetría o asimetría zonal de cada campo mensual.
Para cuantificar la coherencia entre las series temporales correspondientes a distintos índices o al mismo índice en distintos niveles, calculamos la correlación temporal entre ellas.

(ref:method-cap) Patrones espaciales del primer EOF de la altura geopotencial en 700 hPa para el período `r periodo`. (a) Campo completo, (b) componente zonalmente asimétrica y (c) componente zonalmente simétrica. Unidades arbitrarias con valores negativos en azul y negativos en azul.

```{r method, fig.width=6, fig.height=2.5}
sam_sep <- SAM[, eof[[1]]$right, by = .(lev)] %>% 
  setnames("hgt", "full") %>% 
  .[, c("sym", "asym") := list(mean(full), Anomaly(full)), by = .(lat, lev)] 


lab_eof <- c(full = TeX("$\\mathrm{EOF_1}(\\lambda, \\phi)$"),
             asym = TeX("$\\mathrm{EOF_1}^*(\\lambda, \\phi)$"), 
             sym  = TeX("$\\[\\mathrm{EOF_1}\\](\\lambda, \\phi)$"))

sam_plot <- sam_sep %>% 
  .[lev %in% c(700)] %>%
  rm_singleton() %>%
  melt(id.vars = c("lon", "lat")) %>% 
  .[, value := value + rnorm(.N, sd = 1e-6)] %>% 
  .[, variable := factor_sam(variable)] 

levels(sam_plot$variable) <- lab_eof

sam_plot %>% 
  copy() %>% 
  .[lat > -90] %>%
  .[, value := value/sqrt(cos(lat*pi/180))] %>%
  # .[, hgt := ifelse(lat == -90, mean(value[lat == -87.5]), hgt)] %>% 
  periodic(lon = c(0, 360)) %>%
  ggplot(aes(lon, lat)) +
  # geom_contour(aes(z = value, linetype = factor(-sign(..level..))), global.breaks = FALSE) +
  geom_contour_fill(aes(z = value), global.breaks = FALSE, breaks = ZeroBreaks) +
  geom_contour_tanaka(aes(z = value), global.breaks = FALSE, breaks = ZeroBreaks) +
  geom_qmap() +
  annotate_grid() +
  scale_x_longitude(labels = NULL) +
  scale_y_latitude(limits = c(NA, -20), labels = NULL) +
  scale_fill_divergent(guide = "none") +
  coord_polar2() +
  facet_grid(.~variable, labeller = labeller(variable = label_parsed, lev = lab_lev)) +
  axis_labs_smol() +
  theme(panel.grid = element_blank())  +
  tag_facets() +
  theme(panel.spacing = grid::unit(1, "lines"))
```

```{r compute-asymsam}
indices <- SAM() %>% 
  fread() %>% 
  .[, time := as.Date(time)] %>% 
  .[time %between% main_period]
indices_wide <- dcast(indices, lev + time ~ term, value.var = "estimate_norm")
```

```{r test-aao2}
# test that my indices have the correct sign. The Full index needs to be **positively** correlated
# with the AAO index.
cor_aao <- indices[term == "full" & lev == 700] %>% 
  .[aao, on = .NATURAL] %>% 
  na.omit() %>% 
  .[, cor(estimate, aao)] 

if (sign(cor_aao) != 1) {
  stop("AAO and full index are not positively correlated!")
}
```

#### Limitaciones

```{r sign-regression}
sign_regression <- hgt[lev %in% c(50, 700)] %>%
  indices_wide[., on = .NATURAL] %>% 
  # .[, ":="(samplus = fifelse(full > 0, full, 0),
  #          samminus = fifelse(full <= 0, full, 0)),
  #   by = .(lev, month(time))] %>% 
  .[, hgt_a := Anomaly(hgt_a), by = .(lat, lev, time)] %>%
  .[, FitLm(hgt_a, samplus = full, difference = full*(sign(full) <= 0), intercept = FALSE, se = TRUE), 
    by = .(lon, lat, lev, season(time))] %>% 
  .[, pval := Pvaluate(estimate, std.error, df, adjustment = "fdr")]

plot_sign_regression <- function(sign_regression) {
  sign_regression <- copy(sign_regression)
  
  diff <- sign_regression[term == "difference"] %>% 
    .[, .(lon, lat, lev, season, pval)]
  
  sign_regression[, estimate := c(estimate[term == "samplus"], sum(estimate)), by = .(lon, lat, lev, season)]
  sign_regression[term == "difference", term := "samminus"]
  sign_regression[, pval := NULL]
  
  composites_cors <- sign_regression %>% 
    dcast(season + lat + lon + lev  ~ term, value.var = "estimate") %>% 
    .[, FitLm(samplus, samminus, se = TRUE), by = .(lev, season)] %>% 
    .[term != "(Intercept)"] %>% 
    .[, .(lev, season, beta = estimate, r.squared)]
  
  sign_regression %>% 
    composites_cors[., on = c("season", "lev")] %>% 
    diff[., on = c("lon", "lat", "lev", "season")] %>% 
    .[order(season)] %>% 
    .[, season_text := paste0(season, 
                              "\nr2: ", 
                              scales::number(r.squared, accuracy = 0.01))] %>% 
    .[, season_text := factor(season_text, levels = unique(season_text), 
                              ordered = TRUE)] %>% 
    .[, term := factor(term, c("samplus", "samminus"))] %>% 
    periodic(lon = c(0, 360)) %>% 
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = estimate, fill = after_stat(level)), 
                      breaks = AnchorBreaks(0, exclude = 0), 
                      global.breaks = TRUE) +
    geom_contour_tanaka(aes(z = estimate), 
                        breaks = AnchorBreaks(0, exclude = 0), 
                        global.breaks = TRUE) +
    
    geom_contour_pval(aes(z = pval)) +
    geom_qmap(~.x[lat <= 0]) +
    annotate_grid() +
    scale_x_longitude(labels = NULL) +
    scale_y_latitude(limits = c(NA, -20), labels = NULL) +
    scale_fill_divergent_discretised(name = NULL, 
                                     guide = guide_colorsteps_bottom()) +
    coord_polar2() +
    axis_labs_smol() +
    facet_grid(term ~ season_text, labeller = labeller(term = c("samplus" = "SAM+", 
                                                                "samminus" = "SAM-"))) +
    tag_facets()
}

```

El método supone linealidad en las componentes del SAM.
Es decir, supone que los patrones de anomalías asociadas a valores positivos de cada componente del SAM son similares pero de signo opuesto a las asociadas a la fase valores negativos y de magnitud proporcional a la magnitud del índice.
Las composiciones de @fogt2012 (su Figura 4) sugieren que esto podría no ser del todo válido, aunque gran parte de esa aparente no linealidad podría deberse a la naturaleza heterogénea de los años seleccionados para construir las composiciones y a incertidumbre muestral.

Para poner esta suposición a prueba, calculamos la regresión segmentada de las anomalías zonales de altura geopotencial con el índice SAM para cada signo del SAM.
Las Figuras \@ref(fig:sign-regression-50) y \@ref(fig:sign-regression-700) muestran los campos de regresión en 50 y 700 hPa divididos por trimestres.
Se puede observar que en casi todas las estaciones y ambos niveles, los campos de regresión de SAM positivo y negativo son similares entre ellos.
Este análisis cualitativo se confirma por el análisis cuantitativo de al observar que el $r^2$ (representando la correlación espacial al cuadrado) tienen valores entre 0.7 y 0.9, indicando alta similaridad.
A su vez, también es similar la intensidad de los coeficientes de correlación, indicando un buen cumplimiento de la hipótesis de linealidad.

(ref:sign-regression-50-cap) Regresión segmentada de la anomalía zonal de altura geopotencial en 50 hPa con el índice SAM para cada signo para el período `r periodo`. La correlación espacial al cuadrado entre cada campo en cada estación se detalla debajo de la estación. `r pval_contours(de = " de la diferencia entre el signo positivo y el negativo ")` (no hay áreas).

```{r sign-regression-50, fig.width=6, fig.height=3.7}
plot_sign_regression(sign_regression[lev == 50])
```

(ref:sign-regression-700-cap) Igual que la Figura \@ref(fig:sign-regression-50) pero para 700 hPa.

```{r sign-regression-700, fig.width=6, fig.height=3.7}
plot_sign_regression(sign_regression[lev == 700])
```

Al realizar el análisis EOF utilizando los datos de todos los meses también estamos asumiendo que la estructura del SAM es la misma en todas las estaciones.
La Figura \@ref(fig:season-regression) muestra la regresión del SAM para cada trimestre del año y la significancia estadística de la diferencia entre cada estación y SON.

En 50 hPa (Fig. \@ref(fig:season-regression) fila a), los patrones del SAM para MAM y JJA son muy similares a SON, con correlación espacial cuadrada mayor a 0.75.
En estas tres estaciones, el SAM en 50 hPa se asocia a una onda planetaria 1 con su centro negativo en 60ºO.
El patrón de JJA tiene algunas diferencias significativas con respecto a SON, principalmente un corrimiento e intensificación de la anomalía negativa de la onda.
El patrón de DJF, en cambio, es muy distinto; la onda 1 tiene su mínimo cerca de 180ºO y está más retraída a latitudes altas.
Además, su correlación espacial es esencialmente nula.

En 700 hPa (Fig. \@ref(fig:season-regression) fila b), las cuatro estaciones tienen patrones bastante similares, prácticamente sin diferencias estadísticamente significativas con respecto a SON y con correlaciones cuadradas mayores a 0.6.
El patrón de DJF el más distinto, siendo similar a SON pero menos intenso.
Esto es consistente con los resultados de @fogt2020.

Estos resultados sugieren que la suposición de estabilidad estacional se cumple excepto por DJF en la estratósfera.
Esto indica que hay que tener cuidado en la interpretación del SAM asimétrico en DJF en la estratosfera ya que el patrón de SAM asimétrico impuesto por la metodología no coincide con el patrón de SAM asimétrico que se obtendría considerando únucamente este trimestre.

(ref:season-regression-cap) Regresión múltiple de las anomalías zonales de altura geopotencial para cada estación. El sombreado muestra la regresión de cada estación y los contornos grises, la diferencia de cada estación con respecto a SON (valores negativos en línea punteada y positivos en línea sólida). La correlación espacial al cuadrado entre cada campo y el campo de SON se detalla debajo de la estación. `r pval_contours()`, donde para estaciones distintas a SON, marca el p-valor de la diferencia respecto a SON.

```{r season-regression, fig.height=5.5, fig.width=6, warning=FALSE}
season_regression <- hgt[lev %in% c(50, 700)] %>%
  indices_wide[., on = .NATURAL] %>% 
  .[, hgt_a := Anomaly(hgt_a), by = .(lat, lev, time)] %>%
  .[, ":="(DJF = as.numeric(season(time) == "DJF"), 
           MAM = as.numeric(season(time) == "MAM"), 
           JJA = as.numeric(season(time) == "JJA"))] %>%    # Feo, pero bueno. 
  .[, FitLm(hgt_a, 
            SON = full, 
            DJF = full*DJF, 
            MAM = full*MAM, 
            JJA = full*JJA, se = TRUE), 
    by = .(lon, lat, lev)] %>% 
  .[term != "(Intercept)"] %>% 
  .[, pval := Pvaluate(estimate, std.error, df, adjustment = "fdr"), 
    by = .(term, lev)] %>%
  .[, baseline := estimate[term == "SON"], by = .(lon, lat, lev)] %>%
  .[term != "SON", dif := estimate] %>% 
  .[term != "SON", estimate := estimate + baseline] %>%
  .[, term := factor(term, levels = c("SON", "DJF", "MAM", "JJA"))]


season_cors <- season_regression %>% 
  .[, .(r2 = cor(estimate, baseline)^2), by = .(term, lev)]

season_regression <- season_regression %>% 
  season_cors[., on = c("term", "lev")] %>% 
  .[, season_text := paste0(term, 
                            "\nr2: ", 
                            scales::number(r2, accuracy = 0.01))] %>% 
  .[, season_text := factor(season_text, levels = unique(season_text), 
                            ordered = TRUE)] %>% 
  periodic(lon = c(0, 360))

ggplot(season_regression[lev == 50], aes(lon, lat)) +
  scale_fill_divergent_discretised(name = "50 hPa",
                                   guide = guide_colorsteps_bottom()) +
  tag_facets("panel", tag_levels = "1", tag_prefix = "a.") +
  
  ggplot(season_regression[lev == 700], aes(lon, lat)) +
  scale_fill_divergent_discretised(name = "700 hPa",
                                   guide = guide_colorsteps_bottom()) +
  tag_facets("panel", tag_levels = "1", tag_prefix = "b.") &
  
  geom_contour_fill(aes(z = estimate, fill = after_stat(level)), 
                    breaks = AnchorBreaks(0, exclude = 0), 
                    global.breaks = TRUE) &
  geom_contour_tanaka(aes(z = estimate), 
                      breaks = AnchorBreaks(0, exclude = 0), 
                      global.breaks = TRUE) &
  geom_contour2(aes(z = dif, label = after_stat(level),
                    linetype = after_stat(factor(sign(-level)))), 
                breaks = AnchorBreaks(0, exclude = 0), linewidth = 0.5, 
                color = "gray40", label_colour = "gray20", label_size = 3) &
  geom_contour_pval(aes(z = pval)) &
  geom_qmap(~.x[lat <= 0]) &
  annotate_grid() &
  scale_x_longitude(labels = NULL) &
  scale_y_latitude(limits = c(NA, -20), labels = NULL) &
  scale_linetype(guide = "none") &
  coord_polar2() &
  axis_labs_smol() &
  facet_grid(lev ~ season_text, labeller = labeller(lev = AddSuffix(" hPa"))) &
  plot_layout(ncol = 1) 
```

El método también asume que el patrón zonalmente asimétrico del SAM permanece estacionario a lo largo del periodo considerado.
@silvestri2009 sugiere que este podría no ser el caso entre 1958 y 2004.
Para probar esta suposición, calculamos el SAM para las dos mitades del periodo (1979 a 1998 y 1999 a 2020), que se muestran en la Figura \@ref(fig:sam-period).
Las diferencias entre los dos periodos parecen ser relativamente pequeñas, tanto en la troposfera como en la estratosfera.

(ref:sam-period-cap) Patrón espacial del primer EOF computado para el período 1979 -- 1998 (columna 1) y 1999 -- 2020 (columna 2) para 50 hPa (fila a) y 700 hPa (fila b). Unidades arbitrarias con valores negativos en azul y negativos en azul.

```{r sam-period, warning = FALSE, fig.width=4, fig.height=4}
SAM_period <- hgt[lat <= -20] %>% 
  .[lev %in% c(50, 700)] %>% 
  .[year(time) %between% year(main_period)] %>% 
  .[, hgt := hgt_a*sqrt(cos(lat*pi/180))] %>%
  .[, period := factor(fifelse(year(time) < 1999, "old", "new"), levels = c("old", "new"))] %>% 
  .[, list(eof = list(EOF(hgt ~ time | lon + lat, n = 1, data = .SD))), 
    by = .(lev, period)] 
sam_period_cor <- SAM_period %>% 
  .[, eof[[1]]$right, by = .(lev, period)] %>% 
  copy() %>% 
  .[, hgt := Anomaly(hgt), by = .(lat, lev)] %>% 
  .[] %>% 
  dcast(lev + lon + lat ~ period, value.var = "hgt") %>% 
  .[, correlate(new, old), by = .(lev)]

SAM_period %>% 
  .[, eof[[1]]$right, by = .(lev, period)] %>% 
  copy() %>% 
  .[, hgt := Anomaly(hgt), by = .(lat, lev)] %>% 
  periodic(lon = c(0, 360)) %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = hgt, fill = after_stat(level)), 
                    breaks = AnchorBreaks(0, exclude = 0)) +
  geom_contour_tanaka(aes(z = hgt), 
                      breaks = AnchorBreaks(0, exclude = 0)) +
  # geom_contour_pval(aes(z = pval)) +
  geom_qmap(~.x[lat <= 0]) +
  annotate_grid() +
  scale_x_longitude(labels = NULL) +
  scale_y_latitude(limits = c(NA, -20), labels = NULL) +
  scale_fill_divergent_discretised(name = NULL,
                                   guide = "none") +
  scale_linetype(guide = "none") +
  coord_polar2() +
  axis_labs_smol() +
  facet_grid(lev ~ period, labeller = labeller(lev = AddSuffix(" hPa"),
                                               period = c(new = "1999 -- 2020",
                                                          old = "1979 -- 1998"))) +
  tag_facets("rc")
```

## Resultados

### Evolución temporal {#temporal}

(ref:asymsam-timeseries-cap) Serie temporal de A-SAM y S-SAM en 50 hPa (panel a) y 700 hPa (panel b). A la derecha, la densidad de probabilidad de cada índice. Las series están estandarizadas por el desvío estándar del SAM en cada nivel.

```{r asymsam-timeseries, fig.width=6, fig.height=3}
indices %>% 
  .[lev %in% c(50, 700) & term != "full"] %>%
  # .[, estimate_norm := estimate_norm/sd(estimate_norm), by = .(lev, term)] %>% 
  ggplot(aes(time, estimate_norm)) +
  geom_line(aes(color = term)) +
  # ggridges::geom_vridgeline(stat="ydensity", scale = -4e8, fill = NA,
  #                           aes(color = term, width = ..density.., x = min(time - 1e7))) +
  # geom_smooth(aes(color = term), method = "loess", n = 481, span = 10*12/481, method.args = list(degree = 1)) +
  # geom_point(data = ~.x[lev == 50][time == as.Date("1987-11-01") & term == "sym" | 
  #                         time == as.Date("1987-08-01") & term == "asym"]) +
  scale_color_brewer(NULL, palette = "Dark2", labels = lab_sam) +
  scale_y_continuous(NULL, position = "right") +
  scale_x_date(NULL, expand = c(0, 0), 
               date_labels = "%Y", date_minor_breaks = "1 year",
               breaks = lubridate::as_date(seq(as.Date("1950-01-01"), as.Date("2040-01-01"), 
                                               by = "5 year"))) +
  facet_grid(lev~., labeller = labeller(lev = lab_lev), switch = "y") +
  tag_facets() +
  
  indices %>% 
  .[lev %in% c(50, 700) & term != "full"] %>% 
  ggplot(aes(estimate_norm)) +
  geom_density(aes(color = term), bw = "SJ") +
  facet_grid(lev~., labeller = labeller(lev = lab_lev)) +
  scale_color_brewer(NULL, palette = "Dark2", labels = lab_sam, guide = "none") +
  scale_y_continuous(NULL, labels = NULL, breaks = NULL) +
  scale_x_continuous(NULL, labels = NULL, breaks = 0) +
  coord_flip()  +
  theme(strip.text = element_blank()) +
  plot_layout(widths = c(4, 1))  +
  panel_background()
```

```{r compute-spectrums}
spec <- indices %>% 
  .[year(time) >= 1979] %>% 
  .[lev %in% c(50, 700)] %>% 
  .[order(time)] %>% 
  # .[, estimate_norm := estimate_norm/sd(estimate_norm), by = .(lev, term)] %>% 
  .[, fftspectrum(estimate, c(5, 9), B = 5000, probs = c(0, 0.95)), by = .(term, lev)]
```

```{r spectrum-max}
max_period <- spec[lev == 50 & term == "sym"] %>% 
  .[which.max(spec - `95%`)] %>% 
  .[, 1/freq]
```

Primero evaluamos la evolución temporal del A-SAM y S-SAM.
La Figura \@ref(fig:asymsam-timeseries) muestra las series temporales en 700 hPa y 50 hPa y sus correspondientes estimaciones de densidad.
Seleccionamos estos dos niveles como representativos de la variabilidad troposférica y estratosférica respectivamente.
Como se muestra a continuación, las variabilidades de ambos índices son muy coherentes dentro de cada región de la atmósfera, por lo que es razonable tomar un nivel como representativo de cada capa.

La variabilidad mes a mes es evidente para ambos índices, con variaciones ruidosas en las frecuencias bajas.

(ref:spectrum-cap) Espectro de cada serie temporal suavizada. El sombreado indica el intervalo de confianza del 95% del espectro nulo calculado usando bootstrap tomando 5000 simulaciones de un modelo autoregresivo ajustado a los datos. La línea gris indica la amplitud promedio teórica del modelo autoregresivo. Para el período `r periodo`.

```{r spectrum, fig.height=4, fig.width=6}
spec %>%
  .[, term := factor_sam(term)] %>% 
  # .[term != "full"] %>% 
  ggplot(aes(1/freq/12, spec)) +
  geom_ribbon(aes(ymin = 0, ymax = `95%`), position = "dodge", alpha = 0.1) +
  geom_line(aes(y = ar_spectrum), alpha = 0.15) +
  geom_line() +
  annotation_logticks(sides = "b") +
  scale_color_brewer(NULL, palette = "Dark2", aesthetics = c("color", "fill")) +
  scale_x_log10("Período (años)", sec.axis = sec_axis(~.*12, name = "Período (meses)")) +
  scale_y_continuous("Espectro") +
  facet_grid(lev ~ term, 
             labeller = labeller(lev = lab_lev, term = lab_sam),
             scales = "free") +
  tag_facets("rc") 
```

Los espectros de estas series temporales se muestran en la Figura \@ref(fig:spectrum).
El S-SAM estratosférico varía fuertemente con un periodo entre 10 y 30 meses (Fig. \@ref(fig:spectrum) a.3).
En el periodograma del S-SAM troposférico (Fig.\@ref(fig:spectrum) b.3) se aprecia un pico local en un rango de frecuencias similar, aunque no es estadísticamente significativo.
Esta banda de periodicidad está alrededor del rango de periodicidad de la Oscilación Cuasi-Bienal (QBO, por su siglas en inglés, @baldwin2001b) y es consistente con [@vasconcellos2022], quien encontró que el SAM y la QBO comparten una alta potencia común significativa alrededor de la banda de 2 años.
El hecho de que esta periodicidad no sea evidente en el índice A-SAM, también es consistente con sus composiciones de anomalías de altura geopotencial durante la QBO oriental y occidental, que muestran un monopolo bastante simétrico sobre la Antártida.
En la troposfera, el pico de variabilidad más significativo se encuentra en A-SAM en torno a `r 12*3` meses.

```{r compute-cors}
ccf_dt <- function(..., plot = FALSE) {
  stat <- ccf(..., plot = plot)
  list(lag = stat$lag[, 1, 1], 
       acf = stat$acf[, 1, 1])
}

cors <- indices_wide %>% 
  .[year(time) >= 1979] %>% 
  .[, ccf_dt(asym, sym, lag.max = 5), by = .(lev)]
```

Las series temporales A-SAM y S-SAM parecen estar correlacionadas.
Además, observando los extremos en la estratosfera, la serie S-SAM parece ir por detrás de la serie A-SAM (véanse, por ejemplo, los eventos positivos de finales de 1987).
La Figura \@ref(fig:cor-lev) muestra la correlación entre A-SAM y S-SAM en cada nivel para los retrasos cero y -1.
Los valores de las correlaciones instantáneas entre A-SAM y S-SAM son relativamente constantes en toda la troposfera, fluctuando entre `r signif(cors[lag == 0 & lev >= 100, min(acf)], 2)` y `r signif(cors[lag == 0 & lev >= 100, max(acf)], 2)`.
Las correlaciones con desfase de un mes son igualmente constantes pero muy reducidas.
En la estratosfera, las correlaciones instantáneas caen a un mínimo de `r signif(cors[lag == 0 & lev < 100][which.min(acf)]$acf, 2)` en `r cors[lag == 0 & lev < 100][which.min(acf)]$lev` hPa y luego aumentan nuevamente monotónicamente con la altura hasta el nivel más alto del reanálisis (aunque los resultados cerca de la parte superior de los modelos deben interpretarse con cuidado).
Al mismo tiempo, las correlaciones con un mes de defasaje aumentan con la altura.
Por lo tanto, el índice A-SAM estratosférico tiende a preceder al índice S-SAM.

(ref:cor-lev-cap) Correlación instantánea y con un defasaje de 1 mes entre S-SAM y A-SAM para el período `r periodo`.

```{r cor-lev, fig.width=3, fig.height=3}
cors %>% 
  .[lag %in% c(0, -1)] %>% 
  ggplot(aes(lev, acf)) +
  geom_line(aes(color = factor(lag, levels = c(0, -1), ordered = TRUE),
                linetype = factor(lag, levels = c(0, -1), ordered = TRUE))) +
  scale_x_level() +
  scale_y_continuous("Correlación", limits = c(0, 1)) + 
  scale_linetype_manual(name = NULL, values = c(1, 5), 
                        labels = c("0" = "Instantánea", 
                                   "-1" = "A-SAM adelanda a\nS-SAM en 1 month")) +
  scale_color_brewer(NULL, palette = "Dark2", 
                     labels = c("0" = "Instantánea",
                                "-1" = "A-SAM adelanda a\nS-SAM en 1 month")) +
  coord_flip() +
  panel_background()
```

(ref:cross-correlation-cap) Correlación cruzada entre niveles para el índice SAM (a), A-SAM (b) y S-SAM (c) para el período `r periodo`.

```{r cross-correlation, fig.width = 6, fig.height=3}
tri <- matrix(c(1000, 1000, 1000, 1, 1, 1, 1000, 1000), ncol = 2, byrow = TRUE) %>% 
  as.data.table() %>% 
  setnames(., colnames(.), c("item1", "item2"))

logbreaks <- function(range) {
  ticks <- ggplot2:::calc_logticks(minpow = log10(min(range)), maxpow = log10(max(range)))
  ticks$value[ticks$end == 0.2]
}

N <- indices %>% 
  .[, .N, by = .(lev, term)] %>% 
  .[, unique(N)]

crosscor <- indices %>% 
  .[year(time) >= 1979] %>% 
  copy() %>% 
  .[, widyr::pairwise_cor(.SD, lev, time, estimate, diag = TRUE), by = .(term)] 

crosscor %>% 
  .[, p.value := 2*pnorm(atanh(correlation), 0, sd = 1/sqrt(N), lower.tail = FALSE)] %>% 
  .[, p.value := p.adjust(p.value, method = "bonferroni")]

crosscor %>% 
  .[, term := factor_sam(term)] %>% 
  ggplot(aes(item2, item1)) +
  geom_contour_fill(aes(z = correlation, fill = ..level..),
                    breaks = MakeBreaks(binwidth = 0.1)) +
  geom_contour_tanaka(aes(z = correlation), size = 0.1, na.fill = .99, 
                      breaks = MakeBreaks(binwidth = 0.1)) +
  geom_text_contour(aes(z = correlation), breaks = MakeBreaks(binwidth = 0.1),
                    color = "white", 
                    rotate = FALSE, 
                    stroke.color = "black", stroke = 0.2, 
                    skip = 1, size = 2, 
                    data = ~.x[item2 > item1]) +
  geom_polygon(data = tri, fill = "#fbfbfb") +
  scale_fill_divergent_discretised("Correlación cruzada",
                                   guide = guide_colorsteps_bottom()) +
  scale_x_level(minor_breaks = logbreaks, position = "top") +
  scale_y_level(minor_breaks = logbreaks) +
  coord_equal() +
  facet_grid(. ~ term, labeller = labeller(term = lab_sam)) +
  theme(panel.spacing.x = unit(2, "lines"), strip.placement = "outside") +
  tag_facets(position = "br")
```

La Figura \@ref(fig:cross-correlation) muestra la correlación cruzada (lag cero) entre niveles para los índices SAM, A-SAM y S-SAM.
Para el SAM (Fig. \@ref(fig:cross-correlation)a), los valores altos por debajo de 100 hPa reflejan la coherencia vertical en toda la troposfera.
Por encima de 100 hPa, la correlación entre niveles disminuye más rápidamente, lo que indica una variabilidad menos coherente.
Sin embargo, las correlaciones entre los niveles troposféricos y los niveles estratosféricos bajos y medios siguen siendo relativamente altas (por ejemplo, más de 0,4 entre los niveles troposféricos y los niveles por debajo de 30 hPa).
A-SAM y S-SAM (Fig. \@ref(fig:cross-correlation)b y c, respectivamente) comparten un alto nivel de coherencia similar en la troposfera, pero difieren en su comportamiento estratosférico.
La coherencia estratosférica es mayor para el A-SAM que para el S-SAM.
El S-SAM estratosférico tiene una conexión con el S-SAM troposférico algo más intensa que el A-SAM estratosférico con el A-SAM troposférico.

(ref:trends-cap) Tendencias lineales (en desvio estandard por década) del SAM (columna a), A-SAM (columna b) y S-SAM (columna c) para cada nivel usando datos del todo el año (fila 1) y promedios estacionales (filas 2 a 5) para el período `r periodo`. El sombreado indica el intervalo de confianza de 95%.

```{r trends, fig.width = 6, fig.height=4}
indices %>% 
  .[, lapply(.SD, mean), by = .(lev, PC, term, time = seasonally(time))] %>% 
  .[, season := season(time)] %>% 
  rbind(., copy(indices)[, season := "Annual"]) %>% 
  .[year(time) >= c(1979)] %>% 
  .[, estimate_norm := estimate_norm/sd(estimate_norm), by = .(lev, term)] %>%
  .[, FitLm(estimate_norm, time = time, se = TRUE), by = .(type = term, lev, season)] %>% 
  rm_intercept() %>% 
  .[, term := NULL] %>%  
  .[, estimate := estimate*365*10] %>% 
  .[, std.error := std.error*365*10] %>% 
  .[, pval := Pvaluate(estimate, std.error, df, "fdr")] %>% 
  setnames("type", "term") %>% 
  .[, season := forcats::fct_relevel(season, "Annual")] %>% 
  .[, t := qt(.975, df)] %>% 
  .[, term := factor_sam(term)] %>% 
  ggplot(aes(lev, estimate)) +
  geom_hline(yintercept = 0) +
  geom_ribbon(aes(ymax = estimate + std.error*t, ymin = estimate - std.error*t), 
              fill = "#95a3ab", color = "black", 
              alpha = .6, size = 0.1) +
  geom_line() +
  # stat_subset(aes(subset = pval <= 0.05), shape = 4, size = 2) +
  scale_fill_brewer(palette = "Dark2", aesthetics = c("color", "fill")) +
  scale_x_level() +
  scale_y_continuous("Desvío estándard por década") +
  coord_flip() +
  facet_grid(season ~ term,labeller = labeller(term = lab_sam)) +
  tag_facets("cr") +
  panel_background()
```

Evaluamos las tendencias lineales para cada uno de los índices para el periodo `r periodo` en cada nivel para el año completo y separado por trimestres (Fig. \@ref(fig:trends)).
El índice SAM presenta una tendencia positiva estadísticamente significativa (Fig. \@ref(fig:trends)a.1) en todos los niveles entre 1000 hPa y aproximadamente 50 hPa, con un máximo en 100 hPa.
Las tendencias estacionales (Fig. \@ref(fig:trends) columna a) indican que las tendencias son significativas sólo en verano y marginalmente en otoño.
Esto es consistente con los resultados de estudios previos, los cuales documentaron tendencias positivas en verano, menores en otoño y ninguna tendencia en las demás estaciones (por ejemplo, @fogt2020 y sus referencias) utilizando índices del SAM basados en la circulación en o cerca de superficie.

Al separar la señal SAM en sus partes asimétrica y simétrica, no sólo podemos ver que estas tendencias se deben casi por completo al componente simétrico (comparar columnas b y c Figura \@ref(fig:trends)), sino que en algunos casos las tendencias se vuelven más claras.
En verano, A-SAM tiene una tendencia negativa estadísticamente no significativa en la troposfera media que oculta la tendencia en el índice SAM; como resultado, las tendencias calculadas utilizando sólo la componente simétrica son más intensas (comparar la región sombreada en la Figura \@ref(fig:trends)a.2 y c.2).
En otoño, el índice S-SAM revela una tendencia positiva estadísticamente significativa en la estratosfera que no es significativa utilizando el índice SAM.

Una tendencia positiva en el índice S-SAM y ninguna tendencia en el índice A-SAM podría sugerir en un primer momento una tendencia hacia un SAM más simétrico.
Sin embargo, un S-SAM muy negativo con tendencia a un S-SAM menos negativo se traduciría en una tendencia positiva del S-SAM pero en una SAM más asimétrica.

```{r all-trends, eval=FALSE, warning=FALSE, include=FALSE}
data <- indices %>% 
  .[, lapply(.SD, mean), by = .(lev, PC, term, time = seasonally(time))] %>% 
  .[, estimate_norm := estimate_norm/sd(estimate_norm), by = .(lev, term)] %>%
  .[, season := season(time)] %>% 
  .[, year := year(time)] %>% 
  .[lev %in% c(1000, 700, 300, 50, 10)]

roll_lm_dt <- function(x, y, width, ...) {
  model <- roll::roll_lm(x = as.numeric(x), y = y, width = width, ...)
  
  n <- roll::roll_sum(x = !is.na(x + y), width = width, ...)
  df <- n - 2
  x_name <- deparse(substitute(x))
  
  n <- length(y)
  
  ret <- list(x = rep(x, 2), 
              term = rep(c("(Intercept)", x_name), 
                         each =  length(model$coefficients[, 1])),
              estimate = c(model$coefficients[, 1], 
                           model$coefficients[, 2]),
              std.error = c(model$std.error[, 1], 
                            model$std.error[, 2]),
              df = rep(df, 2)
  )
  
  names(ret)[1] <- x_name
  ret
}

years <- unique(year(data$time))
n <- length(years)
min_obs <- 30
lapply(years, function(y) {
  data %>% 
    .[year >= y] %>% 
    .[, roll_lm_dt(time, estimate, width = n, min_obs = min_obs), 
      by = .(season, lev, sam = term)] %>% 
    .[, year_start := y]
}) %>% 
  rbindlist() %>% 
  .[term != "(Intercept)"] %>% 
  .[, term := NULL] %>% 
  .[, year_end := year(time)] %>% 
  .[, pval := Pvaluate(estimate, std.error, df, adjustment = "none"),
    by = .(season, lev, sam)] %>% 
  .[sam == "asym"] %>%
  na.omit() %>% 
  # .[lev == 700] %>% 
  ggplot(aes(year_end, year_start)) + 
  geom_contour_fill(aes(z = estimate), bins = 20) +
  geom_contour_pval(aes(z = pval)) +
  scale_fill_divergent() +
  facet_grid(lev ~ season) +
  coord_equal()
```

(ref:r-squared-trend-cap) Tendencias lineales (en porcentaje por década) de la varianza explicada por el A-SAM y el S-SAM en cada nivel para cada trimestre en el período `r periodo`. El sombreado indica el intervalo de confianza del 95%.

```{r r-squared-trend, fig.height=4, fig.width=4, warning = FALSE}
indices %>% 
  .[term != "full"] %>% 
  .[year(time) >= 1979] %>% 
  .[, FitLm(r.squared, time, se = TRUE), by = .(lev, type = term, season(time))] %>%
  rm_intercept() %>%
  .[, estimate := estimate*365*10] %>% 
  .[, std.error := std.error*365*10] %>% 
  ggplot(aes(lev, estimate)) +
  geom_hline(yintercept = 0) +
  geom_ribbon(aes(fill = type, color = type, 
                  ymin = estimate - 1.96*std.error, ymax = estimate + 1.96*std.error), 
              size = 0.2, alpha = 0.2) +
  geom_line(aes(color = type)) +
  scale_x_level() +
  scale_y_continuous("Change in explained variance per decade", 
                     label = scales::percent_format(1)) +
  scale_fill_brewer(NULL, palette = "Dark2", aesthetics = c("color", "fill"), labels = lab_sam) +
  coord_flip() +
  facet_wrap(~season) +
  panel_background()
```

Para estudiar la cuestión de si el SAM se está volviendo más o menos asimétrica, mostramos las tendencias de la varianza explicada de cada índice para cada trimestre en la Figura \@ref(fig:r-squared-trend).
En la troposfera, la única tendencia significativa es la de DJF, en la que el A-SAM tiene una tendencia positiva de alrededor del 2% por década, lo que sugiere que el DJF SAM se ha vuelto más asimétrico en el período de `r min(year(main_period))` a `r max(year(main_period))` @fogt2012 observó un cambio de una SAM más asimétrica antes de 1980 a una SAM más simétrica después de 1980, pero nuestro periodo de estudio (`r periodo`) nos impide detectar ese cambio.
Sin embargo, debido a la naturaleza atípica de la componente asimétrico del SAM durante la DJF (Sección \@ref(definition-of-indices)), esto debe tomarse sólo como una evidencia preliminar.
La otra tendencia significativa se da en la estratosfera durante SON, donde hay una tendencia positiva en la varianza explicada por la S-SAM de aproximadamente un 4% por década.
Este cambio podría ser el resultado del forzamiento provocado por el agotamiento del ozono.

```{r r-squared-timeseries2, eval = FALSE}
logistic_trans <- scales::trans_new("logistic", 
                                    transform = scales::logit_trans()$inverse, 
                                    inverse = scales::logit_trans()$trans
)
n_years <- uniqueN(year(indices$time))
indices %>%
  .[lev %in%c(700, 50)] %>%
  .[term != "full"] %>%
  # .[year(time) >= 1979] %>%
  .[, .(r.squared = mean(r.squared)), by = .(time = seasonally(time), lev, term)] %>%
  .[year(time) >= 1979, pred := predict(betareg::betareg(r.squared ~ time)), 
    by = .(lev, term, season(time))] %>% 
  ggplot(aes(time, r.squared)) +
  geom_line(aes(color = term)) +
  geom_line(aes(y = pred, color = term)) +
  geom_smooth(aes(color = term), span = 30/n_years) +  # 30 años
  # geom_smooth(aes(color = term), data = ~.x[year(time) > 1979],
  #             method = "lm") +
  facet_grid(lev~season(time), scales = "free") +
  scale_y_continuous(trans = scales::logit_trans()) +
  coord_trans(y = logistic_trans) +
  scale_color_brewer(NULL, palette = "Dark2",
                     aesthetics = c("color", "fill"),
                     labels = lab_sam)
```

### Patrones espaciales {#spatial}

```{r compute-regr-pattern}
indices_2d_yearly <- hgt[lev %in% c(main_levs)] %>% 
  .[, time := as.Date(time)] %>% 
  indices_wide[., on = .NATURAL, allow.cartesian = TRUE] %>% 
  .[year(time) >= 1979] %>% 
  .[, rbind(as.data.table(FitLm(hgt_a, sym, asym, se = TRUE)),
            as.data.table(FitLm(hgt_a, full, se = TRUE))),
    by = .(lon, lat, lev)] %>% 
  rm_intercept() %>% 
  .[, p.val := Pvaluate(estimate, std.error, df, "fdr"), by = .(term, lev)] %>% 
  periodic(lon = c(0, 360)) %>% 
  .[, term := factor_sam(term)] %>% 
  .[, season := "Annual"]
```

(ref:2d-regr-cap) Regresión de altura geopotencial (metros) en 50 hPa (fila a) y 700 hPa (fila b) con el SAM (columna 1), A-SAM (columna 2) y S-SAM (columna 3) para el período `r periodo`. Los puntos en panel b.2 indican la posición de los puntos de referencia usados por @raphael2004 para calcular su índice de la onda zonal 3.

```{r 2d-regr, fig.width=6, fig.height=6, warning=FALSE}
gdata <- indices_2d_yearly %>% 
  .[lat <= -20] %>% 
  .[lev %in% c(50, 700)] %>%
  .[, lev := as.numeric(lev)] %>% 
  .[, term := factor_sam(term)] 

ggplot(gdata[lev == 50], aes(lon, lat)) +
  scale_fill_divergent_discretised(name = "50 hPa",
                                   guide = guide_colorsteps_bottom()) +
  geom_contour_fill(aes(z = estimate, fill = after_stat(level)),
                    breaks = AnchorBreaks(0, exclude =  0)) +
  geom_contour_tanaka(aes(z = estimate),
                      breaks = AnchorBreaks(0, exclude =  0),
                      size = 0.3) +
  tag_facets("panel", tag_levels = "1", tag_prefix = "a.") +
  
  ggplot(gdata[lev == 700], aes(lon, lat)) +
  scale_fill_divergent_discretised(name = "700 hPa",
                                   guide = guide_colorsteps_bottom()) +
  geom_contour_fill(aes(z = estimate, fill = after_stat(level)),
                    breaks = AnchorBreaks(0, exclude =  0)) +
  geom_contour_tanaka(aes(z = estimate),
                      breaks = AnchorBreaks(0, exclude =  0),
                      size = 0.3) +
  geom_point(data = data.frame(lon = ConvertLongitude(c(50, 166, -76)),
                               lat = -49,
                               term = factor_sam("asym"),
                               lev = as.numeric(700)) %>%
               periodic(lon = c(0, 360)),
             shape = 21, size = 2.5, color = "black", fill = "#de3e80") +
  tag_facets("panel", tag_levels = "1", tag_prefix = "b.") &
  geom_qmap(~.x[lat <= -20]) &
  annotate_grid() &
  scale_x_longitude(labels = NULL) &
  scale_y_latitude(limits = c(NA, -20), labels = NULL) &
  scale_linetype(guide = "none") &
  coord_polar2() &
  facet_grid(lev ~ term, labeller = labeller(lev = lab_lev, term = lab_sam)) &
  # tag_facets("cr", position = list(x = 0.15, y = 0.85)) &
  theme(panel.grid = element_blank())  &
  plot_layout(ncol = 1)
```

A continuación calculamos la regresión espacial de las anomalías de altura geopotencial sobre los índices SAM, A-SAM y S-SAM en los niveles de 50 hPa y 700 hPa (Fig. \@ref(fig:2d-regr)).
Los coeficientes de regresión de la columna 1 de la Figura \@ref(fig:2d-regr) se calcularon utilizando el índice del SAM.
Los coeficientes de regresión de las columnas 2 y 3 se calcularon mediante regresión múltiple utilizando los índices A-SAM y S-SAM al mismo tiempo, de manera que deben interpretarse como los patrones asociados a cada índice, eliminando la variabilidad (linealmente) explicada por el otro.

En la estratosfera, el patrón espacial asociado al SAM está claramente dominado por un monopolo que no está centrada en el Polo Sur (Fig. \@ref(fig:2d-regr)a.1).
El patrón asociado a la parte asimétrica se caracteriza por una estructura de onda-1 con centros sobre el Pasaje de Drake en el Hemisferio Occidental y el Mar de Davis en el Hemisferio Oriental.
Este eje se alinea con el defasaje del monopolo del SAM.
Finalmente, el patrón asocaido al S-SAM, es un monopolo más simétrico aunque todavía no perfectamente centrado en el Polo Sur.

```{r compute-raphael}
raphael <- ReadNetCDF(ERA5_geopotential(), 
                      subset = list(time = range(indices_wide$time),
                                    latitude = -49,
                                    level = 500),
                      vars = c(hgt = "z")) %>% 
  normalise_coords() %>% 
  na.omit() %>% 
  .[, hgt := hgt/9.8] %>% 
  .[, time := as.Date(time)] %>% 
  .[, hgt := Anomaly(hgt), by = .(lat, time)] %>% 
  .[lon %~% ConvertLongitude(c(50, 166, -76))] %>%   # 50°E, 166°E and 76°W. 
  .[, hgt_s := frollmean(hgt, 3, NA, align = "center"), by = .(lon, lat)] %>% 
  na.omit() %>% 
  .[, hgt_s := scale(hgt_s), by = .(lon, lat, month(time))] %>% 
  .[, .(raphael = mean(hgt_s)), by = time] 

cor_raphael <- raphael[indices_wide[lev == 500], on = "time"] %>% 
  na.omit() %>% 
  .[, correlate(asym, raphael)]
```

En la troposfera, el patrón de regresión asociado al SAM muestra la ya conocida combinación de modo anular zonalmente simétrico con asimetrías zonales en forma de onda-3 (Fig. \@ref(fig:2d-regr)b.1, [@fogt2012]).
Los patrones de regresión asociados a los índices A-SAM y S-SAM separan ambas estructuras correctamente.
El A-SAM se ve asociado a un patrón de onda 3 zonalmente asimétrico y de amplitud modulada; con mayor amplitud en hemisferio occidental y casi nula amplitud en el oriental.
El S-SAM, por su parte, se asocia a una estructura anular mucho más zonalmente simétrica que el SAM.
El patrón de onda-3 observado en la Figura \@ref(fig:2d-regr)b.2 está girado media longitud de onda respecto a la posición media del patrón de onda-3 medio descrito por @raphael2004, cuyas posiciones de referencia están marcadas con puntos en la figura.
De hecho, no existe correlación entre el índice de @raphael2004 y el A-SAM (cor = `r cor_raphael$text`).
Así, el índice A-SAM troposférico representa un desplazamiento zonal en la posición de la onda 3 climatológica.

(ref:wave-amplitude-cap) Amplitud (metros) de las ondas zonales de los patrones de regresión de altura geopotencial de la Figura \@ref(fig:2d-regr) para ondas zonales con número de onda 0, 1, 2 y 3, donde el número de onda 0 representa la amplitud de la media zonal.

```{r wave-amplitude, fig.width=4, fig.height=3}
indices_2d_yearly %>% 
  .[lat < -20] %>%
  .[lev %in% c(50, 700)] %>% 
  .[, FitWave(estimate, 0:3), by = .(lat, lev, term)] %>% 
  ggplot(aes(lat, amplitude)) +
  geom_line(aes(color = factor(k)), size = 1) +
  scale_color_brewer("Número de onda", palette = "Set1") +
  scale_y_continuous("Amplitud") +
  scale_x_latitude(ticks = 20) +
  coord_flip() +
  facet_grid(lev~term, labeller = labeller(term = lab_sam, lev = lab_lev)) +
  tag_facets("cr", position = "tr") +
  panel_background() +
  theme(panel.spacing = grid::unit(0.5, "lines"))
```

La amplitud de las ondas zonales con números de onda 0 a 3 en cada latitud a 50 hPa y 700 hPa se muestran en la Figura \@ref(fig:wave-amplitude), donde el número de onda cero representa la amplitud de la media zonal.
Las amplitudes de las ondas zonales del patrón espacial descrito por el índice SAM (Fig. \@ref(fig:wave-amplitude) columna a) están dominadas por la media zonal (número de onda 0) en ambos niveles.
Sin embargo, las ondas zonales son importantes, sobre todo al sur de 50ºS, con un número de onda 1 claramente dominante en 50 hPa (Fig. \@ref(fig:wave-amplitude)a.1) y una mezcla de ondas de amplitud similar en 700 hPa (Fig. \@ref(fig:wave-amplitude)a.2).
La Figura \@ref(fig:wave-amplitude) columna b muestra que el A-SAM está dominado principalmente por la onda 1 en la estratosfera (Fig. \@ref(fig:wave-amplitude)b.1), mientras que en la troposfera se explica por una combinación de ondas zonales 3 a 1 en nivel decreciente de importancia (Fig. \@ref(fig:wave-amplitude)b.2) con una amplitud despreciable de la media zonal.
Por otra parte, el S-SAM se explica casi en su totalidad por la media zonal en ambos niveles (Fig. \@ref(fig:wave-amplitude) columna c), con poca o ninguna contribución de las ondas zonales con números de onda de 1 a 3.

```{r compute-vertical-regression}
indices_wide %>% 
  copy() %>% 
  setnames("lev", "index_level") -> indices_for_regr

vertical_regr <- ReadNetCDF(ERA5_geopotential(), 
                            subset = list(time = range(indices_wide[year(time) >= 1979]$time),
                                          latitude = c(-65, -40)),
                            vars = c(hgt = "z")) %>% 
  normalise_coords() %>% 
  .[, time := as.Date(time)] %>% 
  na.omit() %>% 
  .[, .(hgt = weighted.mean(hgt, w = cos(lat*pi/180))), by = .(lon, lev, time)] %>% 
  .[, hgt := hgt/9.8] %>% 
  .[, hgt_a := Anomaly(hgt), by = .(lon, lev, month(time))] %>% 
  indices_for_regr[., on = .NATURAL, allow.cartesian = TRUE] %>% 
  .[, FitLm(hgt_a, asym, se = TRUE),
    by = .(lon, lev, index_level)] %>% 
  rm_intercept() %>% 
  .[, p.val := Pvaluate(estimate, std.error, df, "fdr"), by = .(term, index_level, lev)] %>% 
  .[, term := factor_sam(term)] 
```

(ref:vertical-regression-cap) Regresión de las anomalías mensuales de altura geopotencial promediada entre 65ºS y 45ºS (metros) y el índice A-SAM de 50 hPa (a) y 700 hPa (b) (niveles indicados en línea punteada) para el período `r periodo`.

```{r vertical-regression, fig.width = 4, fig.height=3}
vertical_regr %>% 
  .[index_level %in% c(50, 700)] %>% 
  .[term == "asym"] %>%
  .[, index_level := as.integer(index_level)] %>% 
  # wrap() %>% 
  ggplot(aes(lon, lev)) +
  geom_contour_fill(aes(z = estimate, fill = ..level..), breaks = AnchorBreaks(0, 10, 0)) +
  geom_contour_tanaka(aes(z = estimate),
                      breaks = AnchorBreaks(0, 10, 0),
                      size = 0.3) +
  geom_hline(data = data.frame(lev = c(50, 700),
                               index_level = c(50, 700)), 
             aes(yintercept = lev), linetype = 2, color = "gray50") +
  # geom_contour2(aes(z = p.val), breaks = 0.01) +
  scale_fill_divergent_discretised(NULL, 
                                   guide = guide_colorsteps_bottom(13)) +
  # oob = scales::squish,
  scale_y_level() +
  scale_x_longitude(ticks = 60)  +
  facet_grid(index_level~., labeller = labeller(index_level = lab_lev)) +
  tag_facets(position = "bl") +
  theme(panel.spacing = grid::unit(1, "lines"))
```

Para analizar la estructura vertical de las anomalías de altura geopotencial asociadas al índice A-SAM, mostramos una sección transversal vertical de regresiones de anomalías de altura geopotencial promediadas entre 65ºS y 40ºS con el índice A-SAM de 50 hPa (Fig. \@ref(fig:vertical-regression)a) y con el índice A-SAM de 700 hPa (Fig. \@ref(fig:vertical-regression)b).
Las anomalías de altura geopotencial asociadas a el A-SAM estratosférico (Fig. \@ref(fig:vertical-regression)a) están claramente limitadas a la estratosfera, lo que subraya el desacoplamiento entre el A-SAM estratosférico y el troposférico.
La estructura vertical de esta señal se inclina unos 60 grados hacia el oeste entre 100 hPa y 1 hPa, lo que sugiere procesos baroclínicos.
La señal en la estratosfera se maximiza cerca de 10 hPa a pesar de utilizar el índice de 50 hPa para la regresión.

El A-SAM troposférico (Fig. \@ref(fig:vertical-regression)b) presenta señales significativas que se extienden hacia arriba hasta los niveles más altos del reanálisis.
En la troposfera, la estructura de la onda 3 es barotrópica equivalente, con una amplitud máxima en torno a los 250 hPa.
Las anomalías son mayores en el hemisferio occidental, donde se extienden hasta la estratosfera.
En el hemisferio oriental, la señal de la onda 3 es menor y se limita a la troposfera, mientras que las anomalías negativas dominan en la estratosfera.
Aunque el índice A-SAM troposférico está asociado a anomalías geopotenciales estratosféricas, éstas no se proyectan fuertemente sobre el A-SAM estratosférico.
Las estructuras mostradas en la Figura \@ref(fig:vertical-regression) son robustas a la elección del nivel del índice.
Para cualquier índice estratosférico (por encima de 100 hPa), las anomalías resultantes son muy similares a la estructura de onda-1 con máximo cerca de 10 hPa en la Figura \@ref(fig:vertical-regression)a.
Por el contrario, para cualquier índice troposférico (por debajo de 100 hPa), el resultado es muy similar al de la Figura \@ref(fig:vertical-regression)b.
Los patrones cambian principalmente en amplitud (no se muestra).

```{r enso-cor}
enso <- ENSO() %>% 
  fread() %>% 
  .[, time := as.Date(time)]

enso_sam_cor <- enso %>% 
  .[indices, on = "time", allow.cartesian = TRUE] %>% 
  .[lev == 700] %>% 
  .[, with(cor.test(estimate, oni), 
           list(cor = estimate, 
                p.value = p.value)), by = .(lev, term)] %>% 
  .[, type := "Correlation"] %>% 
  .[, season := "Year"] %>% 
  .[, lev := NULL]

enso_sam_cor_season <- enso %>% 
  .[indices, on = "time", allow.cartesian = TRUE] %>% 
  .[lev == 700] %>% 
  .[, with(cor.test(estimate, oni), 
           list(cor = estimate, 
                p.value = p.value)), by = .(lev, term, season(time))] %>% 
  .[, type := "Correlation"] %>% 
  .[, lev := NULL]


enso_sam_partial <- enso %>% 
  .[indices_wide[lev == 700], on = "time"] %>% 
  .[, partial_cor(oni, asym, sym)] %>% 
  setnames("partial_correlation", "cor") %>% 
  .[, type := "Partial Correlation"] %>% 
  .[, season := "Year"] 


enso_sam_partial_season <- enso %>% 
  .[indices_wide[lev == 700], on = "time"] %>% 
  .[, partial_cor(oni, asym, sym), by = .(season(time))] %>% 
  setnames("partial_correlation", "cor") %>% 
  .[, type := "Partial Correlation"] 


enso_cors <- rbind(enso_sam_cor, 
                   enso_sam_cor_season, 
                   enso_sam_partial,
                   enso_sam_partial_season, use.names = TRUE) %>% 
  .[type == "Partial Correlation" | term == "full"]

cor_texts <- enso_cors %>% 
  copy() %>% 
  .[, p.value := p.adjust(p.value, "fdr")] %>% 
  .[, cor := round(cor, 2)] %>% 
  .[, p.value := report_p(p.value)] 
```

(ref:enso-cor-table-cap) Correlación entere los índices del SAM y el ONI. En negrita, las correlaciones con p-valor ajustado por FDR menores a 0.01.

```{r enso-cor-table}
table <- enso_cors %>% 
  copy() %>% 
  .[, p.value := p.adjust(p.value, "fdr")] %>% 
  .[, p.value := paste0("(", scales::pvalue(p.value), ")")] %>% 
  .[, cor_text := scales::number(cor, 0.01)] %>% 
  .[, term := lab_sam[term]] %>% 
  .[] %>% 
  melt(id.vars = c("term", "season" ), measure.vars = c("cor_text", "p.value")) %>% 
  dcast(season + variable ~ term, value.var = "value") %>% 
  .[, variable := NULL] %>% 
  setcolorder(c("season", lab_sam))


table2 <- enso_cors %>% 
  copy() %>% 
  .[, p.value := p.adjust(p.value, "fdr")] %>% 
  
  .[, term := lab_sam[term]] %>% 
  dcast(season ~ term, value.var = "p.value") %>% 
  setcolorder(c("season",lab_sam))

if (is_word()) {
  table %>% 
    flextable::flextable() %>% 
    flextable::set_caption("(ref:enso-cor-table-cap)")
} else {
  table %>% 
    kbl(align = "c", 
        caption = "(ref:enso-cor-table-cap)", 
        col.names = c("", lab_sam), booktabs = TRUE) %>%
    kable_classic_2(full_width = F) %>%
    column_spec(2, bold = rep(table2[, 2] < 0.01, each = 2)) %>%
    column_spec(3, bold = rep(table2[, 3] < 0.01, each = 2)) %>%
    column_spec(4, bold = rep(table2[, 4] < 0.01, each = 2)) %>%
    collapse_rows(columns = 1:2, valign = "top") %>% 
    add_header_above(c(" " = 1, "Correlación" = 1, 
                       "Correlación parcial" = 2)) 
}

```

El patrón de la onda 3 de la Figura \@ref(fig:2d-regr)b.2 es muy similar al PSA [@mo1987; @kidson1988], que es un patrón de teleconexión asociado al ENSO [@karoly1989].
De hecho, @fogt2011a demostró que existe una relación significativa entre el SAM y el ENSO.
La correlación entre el SAM y el ENSO (medido por el Índice del Niño Oceánico [ONI, @bamston1997]) se muestra en la Tabla \@ref(tab:enso-cor-table) para cada índice SAM y para cada trimestre y para todo el año.
Existe una correlación significativa entre SAM y ENSO que, cuando se divide en trimestres, sólo es es importante en DJF y SON.
Esta relación es captada principalmente por el A-SAM, ya que este índice presenta correlaciones parciales significativas con el ENSO, mientras que las correlaciones con el S-SAM son todas menores y no significativas.
Incluso en los trimestres donde la correlación entre SAM y ENSO es esencialmente nula (MAM y JJA), la correlación parcial entre el A-SAM es mucho más alta; en MAM incluso es significativa al nivel del 95%.
El mismo análisis se realizó utilizando el Índice ENSO Multivariado [@wolter2011] y el Índice de Oscilación del Sur [@ropelewski1987], obteniendo resultados similares.
Esto último nos permite concluir que estos resultados no dependen del índice ENSO utilizado.

## Impactos {#impacts}

```{r compute-air-regr}
time_subset <- list(time = range(indices[year(time) >= 1979]$time))

air <- ERA5_T2M() %>% 
  ReadNetCDF(vars = c("air" = "t2m"), 
             subset = c(time_subset, list(latitude = c(-90, 20)))) %>% 
  normalise_coords() %>% 
  .[, time := as.Date(time)]

air_regr <- air %>% 
  # .[, air := Anomaly(air), by = .(lon, lat)] %>%
  .[indices_wide[lev == 700], on = .NATURAL] %>% 
  # mei[., on = .NATURAL] %>% 
  rm_singleton() %>% 
  .[year(time) >= 1979] %>% 
  .[, lapply(.SD, mean, na.rm = TRUE), by = .(lon, lat, time = seasonally(time))] %>%
  .[, rbind(as.data.table(FitLm(air, asym, sym, se = TRUE)),
            as.data.table(FitLm(air, full, se = TRUE))),
    by = .(lon, lat, season(time))] %>% 
  rm_intercept() %>% 
  .[, term := factor_sam(term)]
```

(ref:regr-air-season-cap) Regresión de las anomalías de temperatura a dos metros (Kelvin) con el índice SAM (columna a), A-SAM (columna b) y S-SAM (columna c) en cada trimestre para el período `r periodo`. `r pval_contours()`. La escala de colores se corta en $\pm0.6 \mathrm{K}$ para resaltar valores de regresión en los trópicos y latitudes medias a expensas de los valores en las regiones polares.

```{r regr-air-season, fig.width = 6, fig.height = 8}
anchor_limits <- function(anchor = 0, binwidth = NULL, exclude = NULL,  bins = 10,
                          range = c(NA, NA), sym = TRUE) {
  force(range)
  force(anchor)
  force(binwidth)
  force(exclude)
  force(bins)
  function(x, binwidth2 = NULL) {
    if (sym) {
      D <- max(abs(x[1] - anchor), abs(x[2] - anchor))
      x <- c(anchor - D, anchor + D)
    }
    
    
    if (!is.null(binwidth)) binwidth2 <- binwidth
    if (is.null(binwidth2)) {
      binwidth2 <- diff(pretty(x, bins))[1]
    }
    
    mult <- ceiling((x[1] - anchor)/binwidth2) - 1L
    start <- anchor + mult*binwidth2
    b <- seq(start, x[2] + binwidth2, binwidth2)
    b <- b[!(b %in% exclude)]
    
    if (!is.na(range[1])) {
      m <- min(b)
      b <- c(b[b >= (range[1] + 1e-9)], -Inf)  # DAMN YOU FLOATING POINT ERRORS!!! 
    }
    
    if (!is.na(range[2])) {
      m <- max(b)
      b <- c(b[b <= (range[2] - 1e-9)], Inf)
    }
    sort(b)
    
  }
}

air_regr %>% 
  copy() %>% 
  .[, p.value := Pvaluate(estimate, std.error, df, "fdr"), by = .(term, season)] %>% 
  periodic(lon = c(0, 360)) %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = estimate, fill = ..level..), 
                    breaks = anchor_limits(0, 0.1, 0, range = c(-.6, 0.6))) +
  geom_contour_pval(aes(z = p.value)) +
  geom_qmap(~.x[lat <= 0]) +
  annotate_grid() +
  scale_x_longitude(labels = NULL) +
  scale_y_latitude(labels = NULL, limits = c(NA, 0)) +
  scale_fill_divergent_discretised("2-meter air temperature", 
                                   guide = guide_colorsteps_bottom(even.steps = FALSE)) +
  coord_polar2(ymax = 0) +
  facet_grid(season ~ term, labeller = labeller(term = lab_sam, lev = lab_lev)) +
  tag_facets("rc") +
  theme(panel.grid = element_blank()) 

```

Para evaluar las diferencias en los impactos asociados a los índices SAM, A-SAM y S-SAM, realizamos una regresión de la temperatura del aire y la precipitación a 2 metros sobre cada uno de los tres índices del SAM de 700 hPa.
Como se mostró en secciones anteriores, los tres índices son muy coherentes en la troposfera, por lo que seleccionamos este nivel para representar la circulación troposférica por compatibilidad con la literatura previa.
Las regresiones se realizaron sin quitarle la tendencia ni a las variables ni a los índices, pero calcular las regresiones con valores sin tendencias no cambia los resultados considerablemente (no se muestra).

La Figura \@ref(fig:regr-air-season) muestra las regresiones con la temperatura a 2 metros.
En verano, los valores positivos del índice SAM (Fig. \@ref(fig:regr-air-season)a.1) se asocian a anomalías negativas de temperatura cerca de la Antártida rodeadas por un anillo de anomalías positivas en las latitudes medias.
El anillo no es zonalmente simétrico, ya que hay cuatro máximos locales distintivos en torno a 30ºW, 120ºW, 150ºE y 90ºE respectivamente.
En los trópicos, las anomalías son negativas en el Pacífico ecuatorial, lo que concuerda con la correlación negativa entre SAM y ENSO observada en la Tabla \@ref(tab:enso-cor-table).
Los paneles a.2 y a.3 de la Figura \@ref(fig:regr-air-season) muestran que tanto las anomalías zonales de este patrón como los altos valores en los trópcios están asociados principalmente al A-SAM y que el S-SAM está asociado a anomalías de temperatura más zonalmente simétricas en latitudes altas.
Sobre la Antártida, los valores positivos del índice SAM están asociados a anomalías negativas de temperatura, en particular sobre la costa oriental.
Estas anomalías están asociadas únicamente con el S-SAM.
Por otro lado, las anomalías de temperatura en el océano Índico, el sur de África y Australia están fuertemente relacionadas con A-SAM y no están presentes en el patrón de regresión con el SAM.

En otoño, invierno y primavera (filas b, c y d en la Figura \@ref(fig:regr-air-season)) el SAM está asociado a un patrón de anomalías de temperatura zonalmente asimétrico en latitudes altas, con valores negativos sobre la Antártida y el Mar de Amundsen y positivas al sur de Nueva Zelanda y centradas en el pasaje de Drake que se extienden hasta la Patagonia.
Esto refleja la naturaleza más asimétrica del SAM durante estas estaciones en comparación al verano.
@jones2019 observó características similares en las mediciones de estaciones, aunque utilizando datos de 1957 a 2016.
En general se observa que la señal sobre la Antártida está asociada al S-SAM (aunque estadísticamente significativa sólo en invierno), mientras que las anomalías sobre el Océano Antártico y latitudes más bajas se asocian al A-SAM.
En primavera, la señal tropical de A-SAM es similar a la del verano, revelando de nuevo la importancia del vínculo ENSO\--A-SAM.

El patrón de anomalías negativas en el polo rodeadas de anomalías positivas que se observa aproximadamente en todas las estaciones -aunque con intensidad variable y detalles a pequeña escala- se traduce en un gradiente de temperatura meridional aumentado maximizado en la línea cero, lo que es coherente con la intensificación y migración hacia el polo de los vientos del oeste comúnmente vinculados a el SAM a través del balance térmico del viento.
Por tanto, no es sorprendente verlo más claramente asociado al S-SAM.
Las temperaturas sobre la Antártida Oriental se ven más afectadas por el S-SAM, mientras que en la Antártida Occidental son más sensibles al A-SAM.
Dado que el índice S-SAM está negativamente correlacionado con la temperatura sobre la Antártida Oriental, es posible que la tendencia positiva en el índice S-SAM pueda ayudar a explicar la falta de tendencia positiva de la temperatura en la Antártida Oriental en comparación con la Antártida Occidental en el contexto del calentamiento global [@nicolas2014].

```{r calc-indices2d-seasonal}
indices_2d_seasonal <- hgt[lev %in% 700] %>% 
  indices_wide[., on = .NATURAL, allow.cartesian = TRUE] %>% 
  .[, lapply(.SD, mean, na.rm = TRUE), by = .(lon, lat, time = seasonally(time))] %>% 
  .[, rbind(as.data.table(FitLm(hgt_a, sym, asym, se = TRUE)),
            as.data.table(FitLm(hgt_a, full, se = TRUE))),
    by = .(lon, lat, season(time))] %>% 
  rm_intercept() %>% 
  .[, p.val := Pvaluate(estimate, std.error, df, "fdr"), by = .(term, season)] %>% 
  periodic(lon = c(0, 360)) %>% 
  .[, term := factor_sam(term)]

indices_2d <- rbind(indices_2d_yearly[lev == 700] %>% .[, lev := NULL], indices_2d_seasonal) %>% 
  .[, season := forcats::fct_relevel(season, "Annual")] 
```

```{r compute-pp-regr}
# pp <- CMAP() %>% 
#   ReadNetCDF(subset = list(lat = c(-90, -20))) %>% 
#   normalise_coords() %>% 
#   .[, precip := Anomaly(precip), by = .(lon, lat)]


continents <- list(africa  = list(lon = c(0, 60),
                                  lat = c(-40, 0)),
                   oceania = list(lon = c(100, 180),
                                  lat = c(-50, -5)),
                   america = list(lon = c(265, 325),
                                  lat = c(-60, -10)))


add_continent <- function(dt) {
  dt[, continent := fcase(lon %between% continents$africa$lon & 
                            lat %between% continents$africa$lat, "africa",
                          lon %between% continents$oceania$lon & 
                            lat %between% continents$oceania$lat, "oceania",
                          lon %between% continents$america$lon &
                            lat %between% continents$america$lat, "america")] %>% 
    .[, continent := factor(continent, levels = c("africa", "oceania", "america"), ordered = TRUE)] %>% 
    .[]
}

cmap <- CMAP() %>% 
  fread() %>% 
  .[, time := as.Date(time)] %>% 
  .[lat %between% c(-90, 0)] %>% 
  .[time %between% range(indices$time)] %>% 
  .[, days := lubridate::days_in_month(time[1]), by = time] 

nas_cmap <- cmap[, .(n_na = sum(is.na(pp))), by = .(lon, lat)]

pp_regr_season <- cmap %>% 
  .[indices_wide[lev == 700], on = .NATURAL] %>% 
  .[time %between% range(cmap$time)] %>% 
  nas_cmap[., on = c("lon", "lat")] %>% 
  .[n_na == 0] %>% 
  .[, lapply(.SD, mean, na.rm = TRUE), by = .(lon, lat, time = seasonally(time))] %>%
  .[, pp_a := Anomaly(pp), by = .(lon, lat, season(time))] %>%
  # .[, nas := mean(is.na(pp_a)), by = .(lon, lat, season(time))] %>% 
  # .[nas >= 0.15, precip := NA] %>% 
  # .[is.finite(precip_a)] %>%
  .[, rbind(as.data.table(FitLm(pp_a, asym, sym, se = TRUE)),
            as.data.table(FitLm(pp_a, full, se = TRUE))),
    by = .(lon, lat, season(time))] %>% 
  rm_intercept() %>% 
  .[, term := factor_sam(term)]

pp_regr_annual <- cmap %>% 
  .[indices_wide[lev == 700], on = .NATURAL] %>% 
  .[time %between% range(cmap$time)] %>% 
  nas_cmap[., on = c("lon", "lat")] %>% 
  .[n_na == 0] %>% 
  .[, pp_a := Anomaly(pp, na.rm = TRUE), by = .(lon, lat, month(time))] %>%
  # .[, nas := mean(is.na(pp_a)), by = .(lon,  lat)] %>%
  # .[nas >= 0.15, precip := NA] %>% 
  # .[is.finite(precip_a)] %>%
  .[, rbind(as.data.table(FitLm(pp_a, asym, sym, se = TRUE)),
            as.data.table(FitLm(pp_a, full, se = TRUE))),
    by = .(lon, lat)] %>% 
  rm_intercept() %>% 
  .[, term := factor_sam(term)] %>% 
  .[, season := "Annual"]


pp_regr <- rbind(pp_regr_season, pp_regr_annual) %>% 
  .[, season := forcats::fct_relevel(season, "Annual")] 
```

```{r pp-enso-patterns, eval=FALSE, include=FALSE}
# This computation is not part of the paper, but was used as an answer to a reviewr. 
pp_patterns <- enso  %>% 
  .[cmap, on = "time"] %>% 
  .[, lapply(.SD, mean, na.rm = TRUE), by = .(lon, lat, time = seasonally(time))] %>% 
  na.omit() %>% 
  .[, FitLm(pp_a, oni), by = .(lon, lat, season(time))] %>% 
  rm_intercept() %>% 
  add_continent() %>% 
  .[continent %in% names(continents)[-1]] 

# pp_patterns %>%
#   .[continent == "america"] %>%
#   ggplot(aes(lon,lat)) +
#   geom_contour_fill(aes(z = estimate)) +
#   facet_wrap(season~continent, scales = "free") +
#   scale_fill_divergent()


pp_enso_index <- cmap %>% 
  .[, lapply(.SD, mean, na.rm = TRUE), by = .(lon, lat, time = seasonally(time))] %>%
  add_continent() %>% 
  .[continent %in% names(continents)[-1]] %>% 
  na.omit() %>% 
  .[, continent := NULL] %>% 
  .[, season := season(time)] %>% 
  .[pp_patterns, on = c("lon", "lat", "season")] %>% 
  .[, mean(estimate*pp_a), by = .(time, continent)]


cors_enso_pp <- pp_enso_index %>%
  dcast(time ~ continent, value.var = "V1") %>%
  .[, cor(oceania, america), by = season(time)] %>% 
  .[, label := paste0(season, " (cor=", signif(V1, 2), ")")]

pp_enso_index %>%
  dcast(time ~ continent) %>%
  .[, season := season(time)] %>%
  ggplot(aes(oceania, america)) +
  geom_point() +
  geom_smooth(method = "lm") +
  scale_x_continuous("Oceania index") +
  scale_y_continuous("America Index") +
  facet_wrap(~season, scales = "free", labeller = labeller(season= setNames(cors_enso_pp$label,
                                                                            cors_enso_pp$season)))


```

(ref:global-pp-cap) Regresión de anomalías de precipitación (mm por día) con el SAM (a), A-SAM (b) y S-SAM (c) para el período `r periodo`. En gris, las zonas con valores faltantes. `r pval_contours()`. La escala de colores se corta en $\pm0.25 \mathrm{K}$ para resaltar valores de regresión en los trópicos y latitudes medias a expensas de los valores en las regiones polares.

```{r global-pp, fig.width=6, fig.height=3.3}
discrete_div_pp <- colorRampPalette(c("#8E521C", "white", "#00665E"))

breaks_pp <- sort(c(seq(-0.25, 0.25, by = 0.05), -0.7, 0.75))
breaks_pp <- breaks_pp[breaks_pp != 0]

lons <- c(0, unique(pp_regr$lon), 360)
pp_regr %>%
  .[season == "Annual"] %>%
  .[, p.value := Pvaluate(estimate, std.error, df, "fdr"), by = .(season, term)] %>% 
  periodic(lon = c(1.25, 360 + 1.25)) %>%
  wrap() %>%
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = estimate, fill = ..level..), 
                    breaks = anchor_limits(0, 0.05, 0, range = c(-0.25, 0.25))) +
  # stat_subset(aes(subset = is.na(estimate)), geom = "tile", color = "gray50") +
  geom_contour_pval(aes(z = p.value), p.value = 0.05) +
  geom_contour_filled(aes(z = n_na, fill = NA), 
                      data = nas_cmap %>% 
                        periodic(lon = c(1.25, 360 + 1.25)) %>%
                        wrap(),
                      breaks = c(0.5, 600), 
                      fill = "gray50") +
  geom_contour2(aes(z = n_na), 
                data = nas_cmap %>% 
                  periodic(lon = c(1.25, 360 + 1.25)) %>%
                  wrap(),
                breaks = c(0.5), fill = "black", size = 0.1) +
  geom_qmap(~.x[lat <= 0], keep = 0.015, weighting = 0.9) +
  scale_x_longitude(breaks = NULL) +
  scale_y_latitude(breaks = NULL, limits = c(-90, NA)) +
  # discrete_scale("fill", "name", name = "Precipitation",
  #                palette = discrete_div_pp,
  #                guide = guide_colorsteps_bottom(show.limits = TRUE, even.steps = FALSE)) +
  scale_fill_divergent_discretised("Precipitation",
                                   low = "#8E521C", high = "#00665E",
                                   guide = guide_colorsteps_bottom(even.steps = FALSE)) +
  scale_linetype(guide = "none") +
  coord_polar2(ymax = 0) +
  annotate_grid() +
  # coord_quickmap(ylim = c(NA, 0)) +
  facet_grid(.~term, labeller = labeller(term = lab_sam)) +
  # tag_facets("panel", position = "tl")  +
  tag_facets("panel") +
  theme(panel.grid = element_blank()) 
```

La Figura \@ref(fig:global-pp) muestra la regresión de los índices SAM con la precipitación para el hemisferio sur.
La señal de precipitación asociada a SAM (Fig. \@ref(fig:global-pp)a) muestra en general una disminución de la precipitación en torno a los 45ºS, un ligero aumento de la precipitación en torno a los 30ºS y un aumento de la precipitación sobre la Antártida, un patrón descrito por otros estudios [p. ej. @hendon2014].
Este patrón se mantiene prácticamente sin cambios entre estaciones, aunque varía en intensidad (no se muestra).
Los paneles b y c de la Figura \@ref(fig:global-pp) muestran que la señal A-SAM sólo se da en los trópicos y latitudes medias, mientras que la señal S-SAM es fuerte en las latitudes altas.
En particular, los valores positivos de S-SAM se asocian con el aumento de las precipitaciones sobre la Antártida y la disminución de las precipitaciones alrededor del Océano Austral.

Para estudiar con más detalle los impactos locales, las Figuras \@ref(fig:pp-regr-oceania) y \@ref(fig:pp-regr-america) muestran la regresión de los índices SAM con la precipitación media estacional y la altura geopotencial de 700 hPa para Nueva Zelanda e islas aledañas, y Sudamérica respectivamente.
No se muestra Sudáfrica porque allí no se detectó ninguna señal significativa.

```{r def-plot_pp}
plot_pp <- function(this_continent, data = pp_regr) {
  gh <- indices_2d %>% 
    copy() %>%
    .[, c("u", "v") := GeostrophicWind(estimate, lon, lat, cyclical = TRUE), by = .(term, season)] %>%
    add_continent() %>% 
    .[continent == this_continent] 
  
  gdata <- data %>%
    .[term != "mei"] %>% 
    add_continent() %>% 
    # .[lat <= -10] %>% 
    .[continent == this_continent] %>%
    .[, p.value := Pvaluate(estimate, std.error, df, "fdr"), by = .(season, continent, term)]
  
  
  gdata %>%   
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = estimate, fill = ..level..), na.fill = 0, 
                      breaks = anchor_limits(0, 0.1, 0, range = c(-.8, 0.8))) +
    stat_subset(aes(subset = is.na(estimate)), geom = "tile", color = "gray50") +
    # geom_raster(aes(fill = estimate/30)) +
    geom_contour_pval(aes(z = p.value)) +
    # geom_contour_fill(aes(z = as.numeric(is.na(estimate))), breaks = 1) +
    # stat_subset(aes(subset = p.value <= 0.05 & is.cross(lon, lat, 2)), size = 0.4, alpha = 0.8) +
    geom_contour2(data = gh, breaks = MakeBreaks(bins = 15, exclude = 0),
                  color = "gray50", size = 0.2, global.breaks = FALSE, 
                  aes(z = estimate, linetype = factor(-sign(..level..)))) +
    geom_text_contour(data = gh, breaks = MakeBreaks(bins = 15, exclude = 0),
                      global.breaks = FALSE,
                      size = 2.5,
                      stroke = 0.15, stroke.color = "white",
                      aes(z = estimate), rotate = FALSE, skip = 1) +
    geom_qmap(~.x[lat <= 10]) +
    scale_x_longitude(ticks = 15, minor_breaks = NULL) +
    scale_y_latitude(ticks = 10,  minor_breaks = NULL) +
    # discrete_scale("fill", "name", name = "Precipitation",
    #             palette = discrete_div_pp,
    #             guide = guide_colorsteps_bottom(show.limits = TRUE, even.steps = FALSE)) +
    scale_fill_divergent_discretised("Precipitation",
                                     # limits = c(-.8, .8),
                                     # oob = scales::squish,
                                     low = "#8E521C",
                                     high = "#00665E",
                                     # label = scales::percent_format(),
                                     guide = guide_colorsteps_bottom(even.steps = FALSE)) +
    
    scale_linetype(guide = "none") +
    coord_sf(xlim = continents[[this_continent]]$lon,
             ylim = continents[[this_continent]]$lat) +
    facet_grid(season ~ term, labeller = labeller(term = lab_sam, lev = lab_lev)) +
    tag_facets("rc", position = "bl")  +
    axis_labs_smol() 
}
```

(ref:pp-regr-oceania-cap) Regresión de anomalías de precipitación (mm por día, sombrado) y anomalías de altura geopotencial (líneas finas, valores positivos en líneas llenas y negativos en líneas punteadas) para todo el año (fila a) y medias estacionales (filas b a e) con el SAM (columna 1), A-SAM (columna 2) y S-SAM (columna 3) para el período `r periodo`. Nueva Zelanda e islas aledañas. `r pval_contours()`.

```{r pp-regr-oceania, fig.width = 6, fig.height = 6.5}
plot_pp("oceania") 
```

En Australia, la regresión anual muestra que el índice SAM está asociado con anomalías positivas de precipitación en la región sudeste (Fig. \@ref(fig:pp-regr-oceania)a.1), en acuerdo con @gillett2006.
La separación entre A-SAM y S-SAM sugiere que esta anomalía positiva se explica por el S-SAM sólo en la costa este (Fig. \@ref(fig:pp-regr-oceania)c.1).
Las anomalías de altura geopotencial asociadas a este índice (contornos negros) son indicativas de un flujo hacia el este procedente del mar de Tasmania, lo que podría explicar las anomalías positivas en las precipitaciones encontradas por @hendon2007.
El A-SAM parece estar relacionado con anomalías positivas de precipitación en la costa oeste del sureste de Australia (Fig. \@ref(fig:pp-regr-oceania)b.2), que podrían explicarse de forma similar por la circulación anómala del oeste que transporta aire húmedo al continente desde el océano Índico.

Las regresiones estacionales muestran anomalías estadísticamente significativas sólo en primavera, cuando un SAM positivo se asocia con anomalías positivas de precipitación en el este y centro de Australia (Fig. \@ref(fig:pp-regr-oceania)a.5).
En este trimestre, el S-SAM parece estar asociado con anomalías positivas de precipitación en un área relativamente reducida de la costa oriental (Fig. \@ref(fig:pp-regr-oceania)c.5) mientras que las anomalías positivas de precipitación relacionadas con A-SAM positivo afectan a todo el este de Australia (Fig. \@ref(fig:pp-regr-oceania)b.5).

En verano, un índice SAM positivo se asocia con anomalías de precipitación positivas en Australia occidental y oriental, sobre todo en la región noreste (Fig. \@ref(fig:pp-regr-oceania)a.2).
La parte oriental está dominada por la relación con el S-SAM y la occidental, por el A-SAM.
En otoño, la regresión con el SAM muestra anomalías positivas en el norte, similares a las de verano, que se asocian con el A-SAM.
En invierno los coeficientes de regresión son mucho más débiles que durante el resto del año.
Ninguno de estos coeficientes de regresión es estadísticamente significativo al nivel del 95%.
La señal de la primavera coincide en líneas generales con @hendon2007, pero mientras que ellos también detectaron una fuerte señal en verano, la Figura \@ref(fig:pp-regr-oceania)a.2 no muestra ninguna asociación estadísticamente significativa (aunque los coeficientes tienen un signo coherente).

(ref:pp-regr-america-cap) Igual que la Figura \@ref(fig:pp-regr-oceania) pero para Sudamérica.

```{r pp-regr-america, fig.width = 6, fig.height = 8.5}
plot_pp("america")
```

En Sudamérica (Fig. \@ref(fig:pp-regr-america)), la regresión anual muestra que el SAM positivo está asociado a anomalías de precipitación negativas en el Sudeste de Sudamérica (SESA) y el sur de Chile, y anomalías positivas en el sur de Brasil, cerca de la Zona de Convergencia del Atlántico Sur (SACZ) (Fig. \@ref(fig:pp-regr-america)a.1).
Las figuras \@ref(fig:pp-regr-america)b.1 y c.1 muestran que mientras la señal sobre SESA y el sur de Brasil está asociada con A-SAM, la del sur de Chile está relacionada con S-SAM.

Excepto en invierno, las regresiones estacionales reflejan este mismo patrón.
Aunque no sean estadísticamente significativas, todas muestran valores negativos en SESA y el sur de Chile junto con valores positivos en el sur de Brasil en relación con el SAM.
La separación de estas características entre los mapas de regresión A-SAM y S-SAM es también bastante consistente.

La circulación anómala a 700 hPa asociada a S-SAM (Fig. \@ref(fig:pp-regr-america)c.1) indica un flujo anómalo del este sobre el sur de Chile.
Esto conduce a una menor advección de aire húmedo desde el Océano Pacífico, que es la principal fuente de agua precipitable en esa región [@garreaud2007].
Por otro lado, la circulación anómala asociada a valores positivos del A-SAM (Fig. \@ref(fig:pp-regr-america)b.1) en el Atlántico es anticiclónica al este y ciclónica al oeste de Sudamérica.
Esto promueve un flujo anómalo del sudeste sobre el SESA que inhibe el flujo del chorro de baja altura desde Sudamérica hacia la región [@silvestri2009; @zamboni2010].
Se encontró que este mismo patrón está asociado con el aumento de las precipitaciones en el sur de Brasil durante los eventos de SACZ [@rosso2018].
Hay una pequeña área de anomalías positivas significativas de precipitación con el SAM cerca del centro de Argentina, también observado en el análisis basado en estaciones de @gillett2006, que se explica por el A-SAM.

## Conclusiones

La división del SAM entre su parte zonalmente asimétrica y simétrica muestra que estos dos aspectos del SAM tienen variabilidad, tendencias e impactos distintivos.

En el capítulo siguiente estudiará la relación entre los cEOFs y las distintas componentes del SAM.
