---
knit: purrr::partial(bookdown::render_book, output_format = 'all', preview = TRUE)
---


```{r setup, include=FALSE}
source(here::here("tesis/scripts/globals.R"))
library(eliotesis)

library(metR)
library(data.table)
library(magrittr)

library(kableExtra)

library(ggplot2)
library(tagger)
library(ggperiodic)
```

```{r read-data}
ceof <- readRDS(data_path("derived", "ceof.Rds"))

sams <- SAM() %>% 
  fread() %>% 
  .[, time := as.Date(time)]
```


# Relación entre los modos de variabilidad del hemisferio sur {#sam-ceof}

En los capítulos anteriores se describieron los modos de circulación del hemisferio sur a través de Funciones Empíricas Complejas (cEOF) y las componentes simétricas y asimétricas del Modo Anular del Sur (SAM). 
En este capítulo se explora la relación entre estos modos de variabilidad, así como con el Modo del Pacífico-Sudamérica (PSA). 
Éste último se calcula según @mo2001 como el segundo y tercer EOF de las anomalías trimestrales de altura geopotencial en 500 hPa. 

## SAM {#sam}

(ref:sam-eof-vertical-cap) Coeficiente de determinación ($r^2$) entre la fase de 0º (fila a) y 90º (fila b) de los cEOFs con el SAM, A-SAM y S-SAM para cada nivel durante el período `r periodo`. 
Las líneas gruesas representan valores con p-valor menor a 0.01 ajustado por FDR.

```{r sam-eof-vertical, fig.height=4, fig.width=width_column}
time <- ceof$left %>%
  sep_ReIm() %>%
  .[, hgt := scale(hgt), by = .(cEOF, part)]

sam_r2 <- sams %>%
  .[, .(estimate = mean(estimate)), by = .(lev, term, time = seasonally(time))] %>% 
  .[time, on = .NATURAL, allow.cartesian = TRUE] %>%
  na.omit() %>% 
  .[, correlate(hgt, estimate), by = .(lev, term, part, cEOF, season(time))]

max_r2 <- sam_r2[part == "Imaginario"] %>% 
  .[, .SD[which.max(estimate^2)], by = .(cEOF, term, season)]

sam_r2 %>%
  .[, p.value_a := p.adjust(p.value, "fdr")] %>% 
  ggplot(aes(lev, estimate^2)) +
  geom_vline(xintercept = c(50, 200),  size = 0.2, color = "gray50") +
  # geom_point(data = ~.x[p.adjust(p.value, "fdr") < 0.01], aes(color = term)) +
  geom_line(data = ~copy(.x)[p.value_a > 0.01, estimate := NA], 
            aes(colour = stage(term, after_scale = scales::alpha(colour, 0.5))), 
            size = 2) +
  geom_line(aes(color = term, group = term)) +
  
  scale_x_level("Level (hPa)", minor_breaks = NULL) +
  scale_y_continuous(r2, limits = c(0, 1), 
                     guide = guide_axis(check.overlap = TRUE)) +
  scale_size_manual("p-value", values = c("TRUE" = 1, 
                                          "FALSE" = 0.5), 
                    guide = "none") +
  scale_color_brewer(NULL, palette = "Dark2", labels = c(full = "SAM",
                                                         asym = "A-SAM",
                                                         sym = "S-SAM")) +
  facet_grid(part ~ cEOF, labeller = labeller(part = lab_cplx)) +
  coord_flip() +
  tag_facets("rc") +
  panel_background() 
```

Calculamos el coeficiente de determinación entre las series temporales de los cEOFs y los tres índices SAM (SAM, A-SAM y S-SAM) definidos en cada nivel vertical (Fig. \@ref(fig:sam-eof-vertical)).
El índice SAM está correlacionado de forma estadísticamente significativa con la fase de 0º del cEOF1 en todos los niveles, y con la fase de 90º del cEOF1 y la fase de 90º del cEOF2 en la tropósfera.
Por otro lado, las correlaciones entre SAM y la fase de  0º del cEOF2 son prácticamente nulas. 

En la tropósfera la correlación de ambas fases del cEOF1 y el SAM es igual a su correlación con el S-SAM, y su correlación con el A-SAM es mucho más baja y no significativa. 
Esto indica que la relación entre el SAM y el cEOF1 en la tropósfera se explica en su totalidad por la componente zonalmente simétrica del SAM. 
En la estratosfera, la fase de 0º del cEOF1 está correlacionada tanto con la A-SAM como con la S-SAM, mientras que la fase de 90º está altamente correlacionada sólo con la A-SAM.
Estas correlaciones son consistentes con los mapas de regresión de la altura geopotencial en la Figura \@ref(fig:eof1-regr-gh) y su comparación con los obtenidos para SAM, A-SAM y S-SAM (Fig. \@ref(fig:2d-regr)).

<!-- Viene del cEOF pero hay que moverlo y adaptarlo a esta parte
-->
Esta falta de relación fuerte entre el cEOF1 y la SST, la temperatura y la precipitación podría ser sorprendente teniendo en cuenta la correlación entre el cEOF1 y la SAM (Fig. \@ref(fig:sam-eof-vertical) columna 1) y la correlación entre la SAM y la SST del Pacífico Central, la temperatura al este y oeste de la Península Antártica, y con la precipitación en el oeste de Australia [@fogt2020].
Esto se debe principalmente a dos razones.
En primer lugar, la correlación entre cEOF1 y la SAM en la troposfera es modesta, con menos del 50% de varianza compartida (Fig. \@ref(fig:sam-eof-vertical) columna 1), por lo que no se espera que estos índices sean equivalentes.
En segundo lugar, @campitelli2022 demostró que la fuerte relación entre la SAM y las SST del Pacífico y las anomalías de temperatura alrededor de la Península Antártica se debe principalmente a la parte asimétrica de la SAM.
Mientras tanto, el cEOF1 está significativamente correlacionado sólo con la parte simétrica de la SAM (Fig. \@ref(fig:sam-eof-vertical) columna 1), que por sí misma no está significativamente correlacionada con las temperaturas superficiales en esa zona.

El cEOF2 sólo tiene relación con el SAM en su fase de 90º y asociada a la parte asimétrica y únicamente en la tropósfera.
La correlación entre ambos índices es muy alta, con valores superiores al 75% de la varianza compartida en toda la tropósfera y un máximo de `r scales::percent(max_r2[cEOF == "cEOF2" & term == "asym"]$estimate^2, 2)` en `r max_r2[cEOF == "cEOF2" & term == "asym"]$lev` hPa. 
Esta altísima correlación es comparable a la correlación observada entre distintos índices del SAM (@ho2012) y sugiere que esta fase es capaz de caracterizar la componente zonalmente asimétrica de la SAM prácticamente en su totalidad. 

## PSA {#psa}

(ref:psa-eof2-cap) Coeficiente de correlación entre las fases del cEOF2 y los modos PSA1 y PSA2 para el período `r periodo`. 
Los intervalos de confianza de 95% se muestran en paréntesis. 
Estimaciones con p-valor menor a 0.01 en negrita. 

```{r psa-eof2, fig.width=7, fig.height=3}
psa <- PSA() %>% 
  readRDS()

psa_time <- psa$left[PC != "SAM"]
cEOF2 <- ceof$left %>% 
  .[cEOF == "cEOF2"] %>% 
  copy() %>% 
  .[, cEOF := NULL] %>% 
  .[]

# rotations_psa <- lapply(angles, function(a) {
#   cEOF2 %>% 
#     copy() %>% 
#     .[, hgt := rotate(hgt, a)] %>% 
#     .[psa2, on = "time"] %>% 
#     .[, cor(value, Re(hgt)), by = season] %>% 
#     .[, angle := a]
# }) %>% 
#   rbindlist()
# 
# psa_angle <- angles[which.max(unlist(rotations_psa))]

make_numeric <- function(x) {
  x <- strsplit(x, "\ ")
  vapply(x, function(x) as.numeric(x[[1]]), numeric(1))
}

background_palette <- grDevices::colorRampPalette(c(scales::muted("blue"),
                                                    "white",
                                                    scales::muted("red")),
                                                  space = "Lab")

table <- psa_time[cEOF2, on = .NATURAL] %>% 
  .[PC != "SAM"] %>% 
  copy() %>% 
  sep_ReIm() %>% 
  .[, correlate(value, hgt), by = .(PC, part)] 

p.val <- table %>% 
  dcast(PC ~ part, value.var = "p.value") 

if (is_word()) {
  table %>% 
    dcast(PC  ~ part, value.var = "text") %>% 
    flextable::flextable() %>% 
    flextable::set_caption("(ref:psa-eof2-cap)")
} else {
  table %>% 
    dcast(PC  ~ part, value.var = "text") %>% 
    kbl2(booktabs = TRUE, caption = "(ref:psa-eof2-cap)") %>%
    column_spec2(2:3, bold = p.val[[.col]] < 0.01) %>%
    # add_header_above(c("", "cEOF2" = 2)) %>%
    collapse_rows(columns = 2, valign = "top") %>% 
    kable_classic() 
}


```

Dada la similitud entre las estructuras asociadas al cEOF2 (Fig. \@ref(fig:eof2-regr-gh)) y los patrones del PSA, estudiamos la relación entre ellos.
La tabla \@ref(tab:psa-eof2) muestra las correlaciones entre los dos índices del PSA y las series temporales para las fases de 0º y 90º del cEOF2.
Como se anticipaba visualmente la figura \@ref(fig:eof2-regr-gh), en SON existe una gran correlación positiva entre el PSA1 y la fase de 90º y  entre el PSA2 y la fase de 0º cEOF2.
Por otro lado, no existe una relación significativa entre el PSA1 y la fase de 0º ni entre el PSA2 y la fase de 90º cEOF2.
Estas relaciones también se mantienen en DJF, aunque no en los otros trimestres. 
En consecuencia, cEOF2 representa bien tanto la estructura espacial como la evolución temporal de los modos PSA, por lo que es posible establecer una asociación entre sus dos fases y los dos modos del PSA.
Es decir, la elección de fase para cEOF2 que maximiza la relación entre ENSO y la fase de 90º del cEOF2, también maximiza la asociación entre los componentes de cEOF2 y los modos PSA (no mostrado).

(ref:phase-histogram-cap) Histograma de la distribución de fases del cEOF2 para el periodo `r periodo`. 
Los intervalos están centrados en 90º, 0º, -90º, -180º con un ancho del intervalo de 90º.
Las pequeñas líneas verticales cerca del eje horizontal marcan las observaciones.

```{r phase-histogram, fig.width=width_column*.8, fig.height=2.5}
N <- ceof$left %>% 
  .[, .N]

plot <- cut(ceof, 2)$left %>% 
  .[, arg := Arg(hgt)] %>% 
  .[, w := Mod(hgt)/mean(Mod(hgt))] %>% 
  qwrap(arg = c(-pi, pi) ~  c(-pi - 1/4*pi, pi - 1/4*pi)) %>% 
  ggplot(aes(arg)) +
  geom_histogram(binwidth = 90*pi/180, center = 0, size = 0.2,
                 color = "black", fill = "gray70") + 
  # annotate("text",
  #          label = c("- Real", "- Imaginary", "+ Real", "+ Imaginary"),
  #          color = "black", size = 3,
  #          y = 0.5, x = c(-pi, -pi/2, 0, pi/2), angle = 90, hjust = 0) +
  geom_rug() +
  scale_y_continuous("Number of years",
                     sec.axis = sec_axis(~.x/N,
                                         name = "Proportion of years",
                                         labels = scales::percent)) +
  scale_x_continuous("Phase", trans = scales::reverse_trans(),
                     breaks = seq(-pi - 1/4*pi, pi - 1/4*pi, by = 45*pi/180),
                     labels = function(x) paste0(round(x*180/pi, 5), "º")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(panel.grid = element_blank()) 

imaginary <- ggplot_build(plot)$data[[1]] %>% 
  as.data.table() %>% 
  .[, .(x, count, panel = PANEL)] %>% 
  .[, percent := count/sum(count), by = panel] %>% 
  .[] %>% 
  .[, .SD[x %~% 1.570796 | x %~% -1.570796], by = panel] %>% 
  .[, .(percent = sum(percent)), by = panel]

plot
```

La Figura \@ref(fig:phase-histogram) muestra un histograma para cada trimestre con la distribución de la fase del cEOF2 con las observaciones marcadas con líneas verticales en el eje horizontal.
En SON (panel 4), el cEOF2 tiene una fase similar a $\pm$ 90º un `r scales::percent(imaginary$percent)` de los años, indicando que es la fase más común. 
Esta preferencia de fase está de acuerdo con @irving2016, que encontró una distribución bimodal a la variabilidad tipo PSA (compare nuestra Figura \@ref(fig:phase-histogram) con su Figura 6).


## Conclusión
