---
knit: purrr::partial(bookdown::render_book, output_format = 'all', preview = TRUE)
---

```{r setup, include=FALSE}
source(here::here("tesis/scripts/globals.R"))

library(knitr)

library(eliotesis)

library(metR)
library(data.table)
library(magrittr)

library(kableExtra)

library(ggplot2)
library(tagger)
library(ggperiodic)
library(ggnewscale)
library(tidyfast)

Sys.setenv(HDF5_USE_FILE_LOCKING = FALSE)

alpha_from_n <- function(n, max_alpha = 0.99) {
  1 - (1 - max_alpha)^(1/n)
}
```

```{r scales}
experiments <- c("historical", "hist-GHG", "hist-stratO3", "hist-nat", "hist-aer")
colores <- setNames(c("black", RColorBrewer::brewer.pal(length(experiments) - 1, "Dark2")),
                    experiments)
scale_color_experiments <- function(...) {
  scale_color_manual(..., name = NULL, 
                     values =  colores)
}


scale_fill_experiments <- function(...) {
  scale_fill_manual(..., name = NULL, 
                    values = colores)
}

```


# Análisis de los modos de variabilidad de la circulación zonalmente asimétrica en los modelos del CMIP6

El análisis previo estudió la circulación zonalmente asimétrica en los datos de reanálisis.
Sin embargo, el estudio de tendencias y variabilidad de estos modelos se ve limitada por la corta longitud de los datos observacionales y la posible inhomogeneidad del reanálisis al cambiar la densidad y tipo de observaciones; un problema que afecta particularmente al hemisferio sur.
Además, es imposible abordar la atribución de las tendencias observadas utilizando únicamente observaciones.

Estas limitaciones motivan la inclusión de datos de modelos climáticos.
En este capítulo se analiza la habilidad de los modelos del sexto Proyecto de Intercomparación de Modelos Acoplados (CMIP6) y del Proyecto de Intercomparación de Modelos de Detección y Atribución (DAMIP) de capturar estos modos y sus principales características.
Al contar con corridas mucho más largas y múltiples miembros por modelo, es posible evaluar las tendencias a largo plazo con mayor robustez.
Utilizando los modelos incluidos en DAMPI, además podemos avanzar en la atribución de las tendencias observadas.

## Métodos

### Datos

El CMIP6 es un proyecto que organiza numerosos centros de modelado climático para establecer protocolos comunes para realizar experimentos de modelado.
DAMIP es una componente del CMIP6 que cuenta con experimentos particularmente diseñados para realizar estudios de atribución.

```{r references}
sims <- readRDS(data_path("derived", "sims.Rds")) %>% 
  .[, .(model = source_id,
        # experiment = experiment_id,
        id)] %>% 
  unique() %>% 
  .[, .(ref = paste0("[", paste0(paste0("@", id), collapse = "; "), "]")), by = model]
```

```{r simulaciones}
son_cmip_files <-  data_path("derived", "cmip", "SON") %>% 
  list.files(pattern = ".nc", full.names = TRUE) 

stopifnot(`No hay archivos de CMIP!` = length(son_cmip_files) > 0)

simulaciones <- son_cmip_files %>% 
  basename() %>% 
  unglue::unglue_data("{variable}_{mean}_{model}_{experiment}_r{member}i{init}p{physics}f{forcing}_{grid}_{start_date}-{end_date}.nc", 
                      convert = TRUE) %>% 
  data.table::as.data.table() %>% 
  .[, file := son_cmip_files] %>% 
  .[mean != "Emon"] %>% 
  .[order(variable, model, member)] %>% 
  .[, member := interaction(member, init, physics, forcing)] 
```

```{r modelos}
simulaciones %>% 
  .[, .(miembros = .N), by = .(model, experiment)] %>% 
  tidyr::pivot_wider(names_from = experiment, values_from = miembros, values_fill = 0) %>% 
  as.data.table() %>% 
  .[order(-historical, -(`hist-GHG` + `hist-nat` + `hist-stratO3` + `hist-aer`))] %>% 
  .[sims, on = "model"] %>% 
  .[, model := paste(model, ref)] %>% 
  .[, ref := NULL] %>% 
  setnames("model", "Modelo") %>% 
  knitr::kable(caption = "Modelos analizados y la cantidad de miembros para cada experimento.",
               format = "markdown", format.args = list(zero.print = "-"))
```

Los modelos usados se listan en la Tabla \@ref(tab:modelos) se listan todos los modelos y la cantidad de miembros de cada uno.
Usamos todos los modelos del CMIP6 con 5 o más miembros en las corridas históricas ("historical") y todos los modelos en los experimentos que contienen únicamente el efecto de los gases de efecto invernadero ("hist-GHG"), variabilidad natural sin forzantes antropogénicos ("hist-nat"), forznates de aerosoles antropogénicos ("hist-aer") o sólo el efecto de el ozono estratosférico ("hist-stratO3").

Para calcular los cEOFs y evaluar su desempeño, concatenamos todos los miembros para computar un único set de cEOFs para cada modelo y experimento.
Este método trata $k$ simulaciones de $n$ años como una única simulación de $k\times n$ años.
Luego, calculamos los cEOFs siguiendo la metodología de la Sección \@ref(ceof-metodo).
El resultado es que cada modelo y experimento tiene un único patrón espacial (complejo) por cEOF pero una serie temporal (compleja) por miembro.

Para que sea comparable al ERA5, computamos los cEOFs para el período moderno, entre 1979 y 2014 (el último año disponible para todos los miembros).

Como se explicó anteriormente, los cEOFs no están definidos unívocamente ya que aceptan cualquier rotación en el plano complejo análogamente a como los EOFs aceptan cambios de signo.
Los cEOFs computados en ERA5 fueron rotados para maximizar la correlación con el ozono estatosférico o el ENSO como se describe en la Sección \@ref(ceof-metodo).
Para los modelos de CMIP, rotamos los cEOFs para maximizar la correlación espacial de los patrones con el correspondiente cEOF de ERA5.
Esto busca que la localización del patrón sea parecido al observado.

```{r read-data}

ceof_era5 <- data.table(model = "ERA5",
                        experiment = "reanalysis",
                        eof = list(readRDS(cEOF())))

ceof_era5$eof[[1]]$sdev <- ceof_era5[, eof[[1]]]$sdev[, `:=`(correlation = 1,  angle = 0)]
ceof_era5$eof[[1]]$left <- ceof_era5$eof[[1]]$left[, ensemble := factor("1.1.1.1")]
ceof_era5$eof[[1]]$left[, time := as.integer(year(time))]

setcolorder(ceof_era5$eof[[1]]$left, c("time", "ensemble", "cEOF", "hgt"))

```

```{r ref_era5}
ref_era5 <- ceof_era5$eof[[1]]$right %>%
  copy() %>% 
  setnames("hgt", "eof_ref")
```

```{r pad_longitudes}
grid <- ceof_era5[, eof[[1]]$right] %>% 
  unique(by = c("lon", "lat")) %>% 
  .[, .(lon, lat)] 

interpolate_to_era <- function(data, formula = hgt ~ lon + lat) {
  Interpolate(formula, x.out = unique(ref_era5$lon), y.out = unique(ref_era5$lat), 
              data = pad_longitudes(data)) 
}
```

```{r ceofs}
times <- seq(as.Date("1979-01-01"), as.Date("2014-11-01"), by = "1 month") 
times <- range(seasonally(times[season(times) == "SON"]))

ceof_file <- data_path("derived", "ceofs_cmip.Rds")

if (file.exists(ceof_file)) {
  ceofs <- readRDS(ceof_file)
} else {
  ceofs <- simulaciones %>% 
    .[variable == "zg"] %>%
    .[, .(eof = list(compute_ceof_cmip(file, member, time = times, ref = ref_era5))),
      by = .(experiment, model)]
  
  saveRDS(ceofs, ceof_file)
}

ceofs <- rbind(ceofs, ceof_era5)
```

```{r plot_ceof}
plot_ceof <- function(data, n, which_lev = 200) {
  data <- data[, .(eof = list(cut(eof[[1]], n))), by = model]
  
  which_pc <- paste0("cEOF", n)
  
  models <- data %>% 
    .[, eof[[1]]$sdev, by = model] %>%
    .[cEOF == which_pc] %>% 
    .[order(-correlation)] 
  
  labels <- models %>%
    .[, setNames(paste0(model, "\n(", scales::number(correlation^2, 0.01), ")"), model)]
  
  data %>% 
    .[, eof[[1]]$right, by = model] %>%
    # .[, denormalise(eof[[1]], "right"), by = model] %>%
    .[cEOF == which_pc] %>% 
    # .[, eof[[1]]$right, by = model] %>%
    .[, model := factor(model, levels = models$model)] %>%
    .[lev == which_lev] %>% 
    .[, eof := eof/max(Mod(eof)), by = model] %>% 
    .[, interpolate_to_era(.SD), by = .(model, lev, cEOF)] %>% 
    # .[, eof := eof/sd(eof), by = .(model)] %>% 
    ggperiodic::periodic(lon = c(0, 360)) %>% 
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = Re(eof)), breaks = AnchorBreaks(exclude = 0)) +
    geom_contour2(aes(z = Im(eof), linetype = factor(-sign(..level..))), 
                  breaks = AnchorBreaks(exclude = 0)) +
    scale_linetype(guide = "none") +
    scale_fill_divergent(guide = "none") +
    geom_qmap(crop = c(ymax = -20)) +
    scale_x_longitude() +
    scale_y_latitude(limits = c(-90, NA)) +
    coord_polar() +
    facet_wrap(model ~., labeller = labeller(model = labels))
}
```

```{r cors}
cors <- ceofs %>% 
  # .[model != "ERA5"] %>%
  .[, eof[[1]]$sdev, by = .(experiment, model)] %>% 
  copy() %>% 
  .[, r2 := correlation^2] %>% 
  .[, label := paste0(model, "\n(", scales::number(correlation^2, 0.01), ")")]
```

## Comparación con los modos observados

Previo a otros análisis, es encesario evaluar la capacidad de los modelos de capturar las propiedades del los cEOFs observados.
Para esto estudiamos los modelos de las corridas históricas.

(ref:comparacion-r2-cap) $r^2$ de los patrones espaciales de cada modelo con ERA5 para cada cEOF.

```{r comparacion-r2, fig.width=5, fig.height=6}
cors %>% 
  .[experiment == "historical"] %>%
  .[, model := reorder(model, r2, fun = mean)] %>% 
  # .[, cEOF := forcats::fct_rev(cEOF)] %>%
  ggplot(aes(r2, model)) +
  geom_col(aes(fill = cEOF), 
           position = position_dodge2(reverse = TRUE, padding = 0)) +
  scale_fill_brewer(palette = "Set1") +
  scale_x_continuous("R^2 espacial", limits = c(0, 1), labels = scales::percent_format()) +
  scale_y_discrete(NULL)
```

La Figura \@ref(fig:comparacion-r2) muestra el $r^2$ de los modelos para los dos cEOFs.
Los modelos individuales tienen un $r^2$ entre `r combine_words(scales::percent(range(cors[experiment == "historical"]$r2), decimal.mark = ","))`. 
En todos los casos, la correlación con el cEOF1 observado es mayor que con el cEOF2 observado.
Aunque se pueden identificar modelos con menor correlación con los modos observados, como `r cors[experiment == "historical"][, model := reorder(model, r2, fun = mean)][, levels(model)[1:2]] %>% combine_words()`, aún éstos tienen similitudes mayores al 50%. 


```{r interpolated}
interpolated <- ceofs[, eof[[1]]$right, by = .(experiment, model)] %>% 
  copy() %>% 
  .[model != "ERA5"] %>% 
  .[, interpolate_to_era(.SD),
    by = .(model, experiment, lev, cEOF)] %>% 
  .[, hgt_norm := hgt/max(Mod(hgt), na.rm = TRUE), by = .(cEOF, lev, model, experiment)]


base <- ceof_era5[, eof[[1]]$right] %>% 
  copy() %>% 
  setnames("hgt", "base") %>%
  .[, base := base/max(Mod(base)), by = .(cEOF, lev)] %>% 
  .[, experiment := "historical"]
```

```{r plot_top_bottom}
plot_modelos <- function(which_cEOF, n = 4) {
  
  old <- sf::sf_use_s2(FALSE)
  on.exit(sf::sf_use_s2(old))
  
  which_lev = ifelse(which_cEOF == "cEOF1", 50, 200)
  top_bottom <- cors %>% 
    .[experiment == "historical"] %>%
    .[cEOF == which_cEOF] %>% 
    .[, model := reorder(model, r2, fun = mean)] 
  
  
  interpolated %>% 
    .[experiment == "historical"] %>% 
    .[top_bottom, on = .NATURAL] %>% 
    .[lev == which_lev] %>% 
    .[, hgt := NULL] %>% 
    .[, label := reorder(label, -r2, fun = mean)] %>% 
    sep_ReIm(format = "wide") %>% 
    periodic(lon = c(0, 360)) %>%
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = Real), breaks = AnchorBreaks(exclude = 0)) +
    geom_contour2(aes(z = Re(base), 
                      linetype = factor(-sign(..level..))),
                  data = base %>%
                    .[lev == which_lev & cEOF == which_cEOF] %>% 
                    periodic(lon = c(0, 360)),
                  breaks = AnchorBreaks(exclude = 0)) +
    scale_linetype(guide = "none") +
    scale_fill_divergent(guide = "none") +
    geom_qmap(crop = c(ymax = -20)) +
    scale_x_longitude() +
    scale_y_latitude(limits = c(-90, NA)) +
    coord_polar2() +
    facet_wrap(~ label, ncol = n) +
    tag_facets()
}
```

```{r todos-ceof1, fig.width=6, fig.height=8}
plot_modelos("cEOF1", 5)

```

(ref:todos-ceof1-cap) Fase de 0º del cEOF1 en 50 hPa (sombreado, valores positivos en rojo, negativos en azul) de las corridas históricas de los modelos de CMIP6 analizados. Los contornos marcan el patrón de ERA5 (valores positivos en líneas llenas, valores negativos en línea punteada)

```{r todos-ceof2, fig.width=6, fig.height=8}
plot_modelos("cEOF2", 5)

```

(ref:todos-ceof2-cap) Igual que la Figura \@ref(fig:todos-ceof1) pero para el cEOF2 en 200 hPa.

Para entender tener mejor los patrones de los modelos individuales, las Figuras \@ref(fig:todos-ceof1) y \@ref(fig:todos-ceof2) muestran la fase de 0º del cEOF1 y cEOF2, respectivamente, con los modelos ordenados de acuerdo al $r^2$ del respectivo cEOF.
Para el cEOF1 (Fig. \@ref(fig:todos-ceof1)) todo los modelos excepto FGOALS-g3 (panel t) capturan correctamente el patrón de onda 1 observado. 
Las diferencias con ERA5 es mínima, como es de esperarse por la alta correlación espacial de estos patrones. 
Para el cEOF2 (Fig. \@ref(fig:todos-ceof2)), todos los modelos capturan el patrón de onda 3 localizado en el sector Pacífico-Atlántico. 
En particular, el centro positivo al sur de Sudamérica y los centros negativos a los lados del mismo coinciden en todos los modelos con los centros de ERA5. 
La principal característica de los modelos con baja correlación es la menor intensidad y mala localización del máximo localizado al sur de Nueva Zelanda.

El patrón medio multimodelo de la fase de cada cEOF en cada nivel, calculada promediando el patrón espacial correspondiente de todos los modelos se muestra en la Figura \@ref(fig:mmm), junto con el $r^2$ de estos patrones con respecto a los observados. 
Los patrones son extremadamente similares a los observados en ERA5 y tienen $r^2$ de 94% y 89% para el cEOF1 y el cEOF2 respectivamente. 
La media multimodelo es más similar a los patrones observados que cualquier modelo individual, indicando que las deficiencias de cada modelo se compensan al promediar.

```{r mmm, fig.width=6, fig.height=4}

cor_mmm <- interpolated %>% 
  na.omit() %>% 
  .[, mean(hgt_norm), by = .(cEOF, model, experiment, lon, lat, lev)] %>% 
  .[, mean(V1), by = .(cEOF, experiment, lon, lat, lev)] %>% 
  .[base, on = .NATURAL] %>% 
  na.omit() %>% 
  .[, weighted_correlation(Re(V1), Re(base), cos(lat*pi/180)), 
    by = .(cEOF, experiment)] %>% 
  .[, experiment := factor(experiment, levels = experiments)]

ceof_labs <- cor_mmm %>% 
  .[, paste0(cEOF, "\n(", scales::percent(V1^2, 1), ")") %>% 
      setNames(cEOF)
  ]

interpolated %>% 
  .[experiment == "historical"] %>% 
  .[, mean(hgt_norm), by = .(cEOF, model, experiment, lon, lat, lev)] %>% 
  .[, mean(V1), by = .(cEOF, experiment, lon, lat, lev)] %>% 
  # .[(cEOF == "cEOF1" & lev == 50) | (cEOF == "cEOF2" & lev == 200)] %>% 
  
  sep_ReIm() %>% 
  periodic(lon = c(0, 360)) %>%
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = V1), breaks = AnchorBreaks(exclude = 0)) +
  geom_contour2(aes(z = base, linetype = factor(-sign(..level..))),
                data = sep_ReIm(base) %>% 
                  periodic(lon = c(0, 360)),
                breaks = AnchorBreaks(exclude = 0)) +
  scale_linetype(guide = "none") +
  scale_fill_divergent(guide = "none") +
  geom_qmap(crop = c(ymax = -20)) +
  scale_x_longitude() +
  scale_y_latitude(limits = c(-90, NA)) +
  coord_polar2() +
  ggh4x::facet_nested(lev ~ cEOF + part, 
                      labeller = labeller(lev = AddSuffix(" hPa"),
                                          cEOF = ceof_labs,
                                          part = lab_cplx)) 
```

(ref:mmm-cap) Media multimodelo (sombreado, valores positivos en rojo, negativos en azul) de los campos espaciales de cada cEOF, fase y nivel. Los contornos marcan los patrones de ERA5 (valores positivos en líneas llenas, valores negativos en línea punteada). El $r^2$ entre ERA5 y la media multimodelo está entre paréntesis. 

Los modelos del CMIP6 capturan satisfactoriamente los patrones espaciales de los cEOFs, tanto en la media multimodelo como los modelos individuales. 
Lo siguiente es explorar si los modelos logran capturar características de segundo orden, como su variabilidad y relación con otras partes del sistema climático.


```{r ceof_largo_p}
campos <- ceofs[, denormalise(eof[[1]], "right"), by = .(experiment, model)] %>% 
  sep_ReIm()

setorder(campos, experiment, model, part, cEOF, -lev, lat, lon)
ceof_largo_file <- data_path("derived", "ceof_largo.Rds")

if (file.exists(ceof_largo_file)) {
  ceof_largo_p <- readRDS(ceof_largo_file)
} else {
  ceof_largo_p <- simulaciones %>%
    .[variable == "zg"] %>%
    .[, ceof_proyectado(file, member, model, experiment, fields = campos,
                        time = c(lubridate::NA_Date_, times[2])),
      by = .(experiment, model)]
  saveRDS(ceof_largo_p, ceof_largo_file)
}
```

### Relación con la variabilidad tropical


```{r enso_cmip}
compute_enso <- function(file) {
  ReadNetCDF(file, vars = c(sst = "tos"), 
             subset = list(lat = c(-5, 5),
                           time = c("1979-09-01", "2014-12-31"),
                           lon = ConvertLongitude(c(-170, -120)))) %>% 
    .[!is.na(sst)] %>% 
    .[, time := year(time)] %>% 
    .[, .(oni = mean(sst)), by = .(time)] %>% 
    .[, oni := (oni - mean(oni))/sd(oni)] %>% 
    .[]
}

enso_cmip <- simulaciones %>% 
  .[variable == "tos"] %>%
  .[, compute_enso(file), by = .(model, experiment, member)] 

enso_cmip <- ENSO() %>% 
  fread() %>% 
  .[season(time) == "SON"] %>% 
  .[, .(oni = mean(oni)), by = .(time = year(time))] %>% 
  .[, `:=`(model = "ERA5", member = factor("1.1.1.1"), experiment = "reanalysis")] %>% 
  rbind(enso_cmip)


enso_fft <- enso_cmip %>% 
  # .[experiment %in% c("historical", "reanalysis")] %>% 
  .[order(time)] %>% 
  .[, fftspectrum(oni, c(3, 5), B = 0, probs = c(0, 0.95)), by = .(model, member, experiment)] 

cors_enso_all <- ceofs[, eof[[1]]$left, by = .(experiment, model)] %>% 
  .[cEOF == "cEOF2"] %>%
  .[experiment %in% c("historical", "reanalysis")] %>% 
  setnames("ensemble", "member") %>% 
  enso_cmip[., on = .NATURAL, allow.cartesian = TRUE] %>% 
  na.omit() %>% 
  .[, c(correlate_complex(hgt, oni), list(n = .N)), by = .(model, experiment)]


cors_enso <- cors_enso_all %>%
  .[angle == 0] 

labs_cor_enso <- cors_enso %>% 
  .[part == "Imaginario"] %>% 
  .[, label := paste0(model, "\n(", scales::number(correlation^2, accuracy = 0.01), ")")] %>% 
  .[, setNames(label, model)]
```


Como se mostró en la Sección \@ref(fuentes-ceof), el cEOF2 está relacionado con la variabilidad tropical.
Una primera aproximación para explorar esta relación en los modelos del CMIP6 es calcular la correlación el cEOF2 y el ONI de cada modelo (Figura \@ref(fig:cor-enso-plot)).
Casi todos los modelos tienen una correlación alta entre el ONI y la fase de 90º del cEOF2 y casi nula correlación entre el ONI y la fase de 0º del cEOF2, lo cual es consistente con las observaciones. 
Sin embargo, existe una gran variabilidad en la capacidad de los modelos de capturar esta relación. 
Algunos, como MIROC6 y CESM2 tienen una correlación cercana a la observada, pero en la mayoría es mucho menor. 
IPSL-CM6A-LR y INM-CM5-0 virtualmente no muestran relación entre el cEOF2 y el ONI. 

(ref:cor-enso-plot-cap) $r^2$ entre el índice ONI y el cEOF2 para cada modelo del CMIP6 y ERA5.  

```{r cor-enso-plot, fig.width=4, fig.height=6}
cors_enso_all %>% 
  .[angle == 0] %>% 
  copy() %>% 
  .[, model := reorder(model, ifelse(part == "Real", 0, correlation^2))] %>% 
  ggplot(aes(correlation^2, model)) +
  geom_col(aes(fill = part), position = "dodge2") +
  scale_x_continuous(name = r2, labels = scales::percent_format()) +
  scale_y_discrete(name = NULL) +
  scale_fill_fase()

```



```{r enso-phase-cmip, fig.width=6, fig.height=5}
ceofs[, eof[[1]]$left, by = .(model, experiment)] %>% 
  .[cEOF == "cEOF2"] %>% 
  # .[, hgt := Anomaly(hgt)] %>% 
  .[, arg := Arg(hgt)] %>%
  .[, mag := Mod(hgt)] %>%
  .[enso_cmip, on = c("time", "model", "experiment", "ensemble" = "member")] %>% 
  .[cors_enso[part == "Imaginario"], on = .NATURAL] %>% 
  .[, model := reorder(model, -(correlation^2)*(part == "Imaginario"))] %>% 
  .[, ensembleN := uniqueN(ensemble), by = model] %>% 
  na.omit() %>% 
  ggplot(aes(arg, oni)) +
  geom_hline(yintercept = c(-0.5, 0, 0.5), size = 0.2, color = "gray50") +
  geom_vline(xintercept = 0, size = 0.2, color = "gray50") +
  # annotate(shadowtext:::GeomShadowText,
  #          label = c("- Real", "- Imaginario", "+ Real", "+ Imaginario", "- Real"),
  #          color = "gray60", bg.colour = "white", bg.r = 0.2,
  #          size = 3,
  #          y = -Inf, x = c(-pi, -pi/2, 0, pi/2, pi), angle = 90, hjust = 0) +
  
  geom_smooth(data = ~qwrap(.x, arg = c(-pi, pi) ~ c(-2*pi, 2*pi)),
              method = "lm", aes(weight = mag),
              formula = y ~ I(sin(x)) -1,
              se = FALSE,
              color = "black", linewidth = 0.5) +
  geom_point(size = 0.2, aes(alpha = I(alpha_from_n(ensembleN)))) +
  
  scale_color_brewer(NULL, palette = "Dark2") +
  scale_shape_manual(NULL, values = c(20, 18)) +
  scale_y_continuous("ONI") +
  scale_x_continuous("Fase de cEOF2",
                     breaks = seq(-pi, pi, by = 45*pi/180),
                     labels = function(x) paste0(round(x*180/pi, 5), "º")) +
  coord_cartesian(xlim = c(-pi, pi)) +
  # labs(subtitle = equation) +
  panel_background()+
  facet_wrap(~model, labeller = labeller(model = labs_cor_enso))

```

(ref:enso-phase-cmip-cap) Igual que la Figura \@ref(fig:enso-phase) pero para los modelos del CMIP6. El ajuste sinusoidal para cada modelo se realiza utilizando todos los miembros. 


```{r arg-enso-density, fig.width=6, fig.height=5}
ceofs[, eof[[1]]$left, by = .(model, experiment)] %>% 
  .[cEOF == "cEOF2"] %>% 
  # .[, hgt := Anomaly(hgt)] %>% 
  .[, arg := Arg(hgt)] %>%
  .[, mag := Mod(hgt)] %>%
  .[enso_cmip, on = c("time", "model", "experiment", "ensemble" = "member")] %>% 
  .[cors_enso[part == "Imaginario"], on = .NATURAL] %>% 
  .[, model := reorder(model, -(correlation^2)*(part == "Imaginario"))] %>% 
  na.omit() %>% 
  .[, ninio := cut(oni, c(-Inf, -0.5, 0.5, Inf), label = c("ONI < -0.5", "-0.5 < ONI < 0.5", "ONI > 0.5"))] %>% 
  qwrap(arg = c(-pi, pi) ~ c(-2*pi, 2*pi)) %>% 
  
  ggplot(aes(arg)) +
  # geom_density(aes(group = model)) +
  geom_density(aes(color = ninio),
               adjust = 0.5) +
  stat_density(aes(fill = ninio),
               adjust = 0.5, geom = "area",
               alpha = 0.4, position = "identity") +
  scale_color_brewer(NULL, palette = "Dark2", aesthetics = c("color", "fill")) +
  scale_y_continuous(NULL) +
  scale_x_continuous("Fase de cEOF2",
                     breaks = seq(-pi, pi, by = 90*pi/180),
                     labels = function(x) paste0(round(x*180/pi, 5), "º")) +
  facet_wrap(~model, labeller = labeller(model = labs_cor_enso)) +
  coord_cartesian(xlim = c(-pi, pi)) 

```

(ref:arg-enso-density-cap) Estimación de densidad por núcleos de la fase del cEOF2 para primaveras con ONI menor a -0.5, entre -0.5 y 0.5, y mayor a 0.5. 

La relación entre el cEOF2 y el ENSO se explica por una preferencia de fase cuando el forzante tropical está activo. 
Para evaluar esto en los modelos del CMIP6, las Figuras \@ref(fig:enso-phase-cmip) muestra la relación entre el ENSO y la fase del cEOF2 para los modelos del CMIP6 y la Figura \@ref(fig:arg-enso-density) la distribución de fases del cEOF2 para primaveras con ONI menor a -0.5, mayor a 0.5 y valores intermedios. 
Los modelos con una correlación alta entre el cEOF2 y el ENSO muestran una relación sinusoidal fuerte, mientras que en los modelos con baja correlación la relación es más chata. 
La distribución de las fases según categorías de índice ONI (Fig. \@ref(fig:arg-enso-density)) se ven bien separadas en las observaciones y en los modelos con alta correlación entre el cEOF2 y el ONI.
En estos modelos (p.e. MIROC6, CESM2), cuando el ENSO está activo (definido como ONI > 0.5 o ONI < -0.5), la fase del cEOF2 se concentra cerca de $\pm$ 90º (dependiendo del signo del ONI) mientras que cuando el ENSO no está tan activo (definido como ONI entre -0.5 y 0.5), la distribución de la fase es más uniforme. 
En los modelos con baja correlación entre cEOF2 y ONI (p.e. IPSL-CM6A-LR, INM-CM5-0) la distribución de fase es uniforme independientemente de la actividad del ENSO. 

```{r fft}
fft <- ceofs %>% 
  .[, eof[[1]]$left, by = .(experiment, model)] %>% 
  .[, hgt := hgt/sd(Mod(hgt)), by = .(model, experiment, cEOF)] %>%
  sep_ReIm() %>% 
  copy() %>% 
  .[order(time)] %>% 
  .[, fftspectrum(hgt, c(3, 5), B = 0, probs = c(0, 0.95)), by = .(model, experiment, ensemble, cEOF, part)]
```

```{r con_picos}
con_picos <- data.table(
  model = c("FGOALS-g3", "MIROC6", "GISS-E2-1-G", 
            "CESM2", "CNRM-ESM2-1", "CNRM-CM6-1")
)

rect <- geom_rect(data = ~.x[con_picos, on = "model"] %>% 
                    .[, model := reorder(model, -(correlation^2)*(part == "Imaginario"))],
                  inherit.aes = FALSE,
                  xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf,
                  fill = NA, color = "#7e8087") 
```

```{r fft-ceof2, fig.height=6, fig.width=6}
enso_gdata <- enso_fft %>% 
  .[cors_enso[part == "Imaginario"], on = .NATURAL] %>% 
  .[, model := reorder(model, -(correlation^2)*(part == "Imaginario"))] %>% 
  .[, ensembleN := uniqueN(member), by = model] %>% 
  .[, .(spec = mean(spec)), by = .(freq, model)]

fft %>% 
  .[cEOF == "cEOF2"] %>% 
  .[experiment %in% c("historical", "reanalysis")] %>% 
  # .[, .(spec = mean(spec)), by = .(freq, part, model, cEOF)] %>% 
  .[cors_enso, on = .NATURAL] %>% 
  .[, model := reorder(model, -(correlation^2)*(part == "Imaginario"))] %>% 
  .[, ensembleN := uniqueN(ensemble), by = model] %>% 
  ggplot(aes(1/freq, spec)) +
  # geom_ribbon(aes(ymin = 0, ymax = `95%`), position = "dodge", alpha = 0.1) +
  # geom_line(aes(y = ar_spectrum), alpha = 0.15) +
  geom_line(data = enso_gdata, aes(y = spec*3, color = "ONI")) +
  geom_line(aes(color = part, group = interaction(part, ensemble),
                alpha = alpha_from_n(ensembleN, 0.9))) +
  geom_line(data = ~.x[, .(spec = mean(spec)), by = .(freq, part, model, cEOF)],
            aes(color = part)) +
  # annotation_logticks(sides = "b") +
  scale_color_manual(name= NULL, 
                     values = c(Real = color_real, 
                                Imaginario = color_imaginario,
                                ONI = "gray20"), 
                     labels = setNames(paste0("cEOF2 - ", lab_cplx), names(lab_cplx))) +
  scale_x_log10("Period (years)") +
  scale_y_continuous("Spectrum")  +
  scale_alpha_identity() +
  facet_wrap(model ~ ., labeller = labeller(model = labs_cor_enso)) +
  rect

```

(ref:fft-ceof2-cap) Espectros de Fourier para las fases del cEOF2 y del ONI de cada modelo. En línea obscura es el espectro promedio de todos los miembros, que se muestran en líneas translúcidas. El espectro del ONI es el espectro promedio de todos los miembros de cada modelo. Los paneles están ordenados de mayor a menor según el $r^2$ entre la fase de 90º del cEOF2 y el ONI, el cual se muestra entre paréntesis en el título de cada panel.

La relación entre el cEOF2 y el ENSO también se evidencia en la similitud del periodograma de las series. 
La Figura \@ref(fig:fft-ceof2) muestra el periodograma para el cEOF2 con una línea por miembro y una línea gruesa marcando el periodograma promedio, así como el peridiograma promedio del ONI de cada modelo.
La mayoría de los modelos tiene una periodicidad del ONI de \~3 años similar a la observada en ERA5, aunque la intensidad y período máximo varía significativamente.

Todos los los modelos que tienen una periodicidad clara en \~3 años en la fase de 90º del cEOF2 también tienen una periodicidad del ENSO muy clara y además tienden a tener una correlación entre la fase de 90º del cEOF2 y el ENSO más alta.
Por otro lado, ninguno de los modelos con muy baja correlación con el ENSO pero periodicidad del ENSO clara presenta periodicidad clara en el cEOF2.

Sin embargo existen modelos con periodicidad del ENSO clara y correlación relativamente alta que no tienen periodicidad del cEOF2 clara.
MRI-ENSM2-0, UKESM1-0-LL, MPI-ESM1-2-LR son algunos ejemplos.

Estas observaciones sugieren que el ENSO es la fuente de periodicidad del cEOF2 en los modelos del CMIP6 pero que su capacidad para representar la periodicidad observada no sólo depende de la periodicidad del ENSO y del grado de correlación entre los índices.

```{r regress_sst}
standardised <- ceofs[, eof[[1]]$left, by = .(experiment, model)] %>% 
  .[experiment == "historical"] %>% 
  copy() %>% 
  .[, hgt := hgt/sd(Mod(hgt)), by = .(model, ensemble, cEOF)]


regress_sst_ <- function(..model, ..experiment) {
  sst_files <- simulaciones %>% 
    .[variable == "tos"] %>% 
    .[model == ..model & experiment == ..experiment] 
  
  message("Procesando: ", sst_files$file[1])
  
  data <- lapply(seq_len(nrow(sst_files)), function(i) {
    ReadNetCDF(sst_files[i, ]$file, c(sst = "tos"), 
               subset = list(lat  = c(-90, 10), 
                             time = c("1979-10-01", "2014-12-31"))) %>% 
      .[!is.na(sst)] %>% 
      .[, time := year(time)] %>% 
      .[, ensemble := sst_files[i, ]$member] 
  })
  
  data <- rbindlist(data) %>% 
    .[, sst := sst - mean(sst), by = .(lon, lat, ensemble)]
  
  # data[, sst := Detrend2(sst), by = .(lon, lat, ensemble)]
  
  regression <- standardised %>% 
    .[model == ..model & experiment == ..experiment & ensemble %in% unique(sst_files$member)] %>% 
    data[., on = c("time", "ensemble"), allow.cartesian = TRUE] %>% 
    sep_ReIm(format = "wider") %>% 
    .[, FitLm(sst, Real, Imaginario, se = TRUE), 
      by = .(lon, lat, cEOF, model)] %>% 
    .[term != "(Intercept)"] %>% 
    .[, model := NULL]
  
  return(regression)
}


regress_sst <- memoise::memoise(regress_sst_, cache = cachem::cache_disk(here::here("cache", "memoise", "regress_sst")))
```

```{r sst_regression}
sst_regression <- simulaciones %>% 
  .[experiment == "historical"] %>%
  # .[model == "EC-Earth3"] %>% 
  .[variable == "tos"] %>% 
  .[, regress_sst(model[1], experiment[1]), by = .(model, experiment)]
```

```{r plot_sst_regression}
plot_sst_regression <- function(sst_regression, which_ceof) {
  which_ceof <- paste0("cEOF", which_ceof)
  sst_regression %>% 
    .[cEOF == which_ceof] %>% 
    copy() %>% 
    .[!is.na(estimate)] %>% 
    .[, p.val := Pvaluate(estimate, std.error, df, "fdr"), 
      by = .(cEOF, term, model)] %>%
    # .[, estimate := estimate/sd(estimate), by = .(model)] %>%
    .[, enso := mean(estimate[is.enso34(lon, lat) & term == "Imaginario"]), 
      by = .(cEOF, model)] %>%
    # .[, model := reorder(model, -enso)] %>%
    # .[model == "CESM2"] %>%
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = estimate)) +
    geom_contour_pval(aes(z = p.val)) +
    scale_fill_divergent(guide = "none") +
    ggnewscale::new_scale_fill() +
    geom_qmap() +
    coord_sf(ylim = c(10, -90)) +
    scale_y_latitude() +
    scale_x_longitude() +
    facet_grid(model ~ term, labeller = labeller(term = lab_cplx)) 
}
```

```{r sst_regression_ERA5}
sst_regression_ERA5 <- readRDS(data_path("derived", "sst_regr_ERA5.Rds")) %>% 
  .[angle %in% c(0, -90) & lat <= max(sst_regression$lat)] %>% 
  .[, term := ifelse(angle == 0, "Real", "Imaginario")] %>% 
  .[, .(lon, lat, cEOF, term, era5 = estimate)]

```

(ref:sst-mmm-cap) Media multimodelo de regresión de TSM con los cEOFs. El área sombreada muestra las zonas donde más de la mitad de los modelos tienen p-valor menor a 0.01. Los contornos negros muestran la regresión de TSM observada en ERA5.

```{r sst-mmm, fig.width=6, fig.height=3.3}
sst_regression %>% 
  .[, pval := Pvaluate(estimate, std.error, df)] %>% 
  .[, .(estimate = mean(estimate), 
        prop = mean(pval < 0.01)), by = .(lon, lat, experiment, cEOF, term)] %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = estimate, fill = after_stat(level)), 
                    breaks = AnchorBreaks(exclude = 0)) +
  geom_contour_pval(aes(z = prop), p.value = 0.5, hatch = 9, pattern_spacing = 0.05) +
  
  geom_contour2(aes(z = era5, linetype = factor(-sign(..level..))),
                data = sst_regression_ERA5,
                breaks = AnchorBreaks(exclude = 0)) +
  geom_qmap() +
  coord_sf(ylim = c(10, -90)) +
  scale_y_latitude() +
  scale_x_longitude() +
  scale_fill_divergent_discretised("TSM (K)",
                                   labels = label_one_less,
                                   guide = guide_colorsteps_bottom(width = 15,
                                                                   show.limits = FALSE,
                                                                   ticks = TRUE,
                                                                   order = 1)) +
  scale_linetype(guide = "none") +
  facet_grid(cEOF ~ term, labeller = labeller(term = lab_cplx)) 
```

Para estudiar más en detalle esa relación, evaluamos la relación entre los cEOF y las anomalías de TSM.
La Figura \@ref(fig:sst-mmm) muestra la media multimodelo de la regresión entre TSM y las dos fases de cada cEOF, marcando las zonas donde más de la mitad de los modelos tienen p-valores menores a 0.01.
La señal Los modelos del CMIP6 reproducen los patrones de regresión de la fase de 90º del cEOF2 relativamente bien.
Se observa un exceso de señal en el Pacífico ecuatorial en la fase de 0º del cEOF2 que probablemente se deba a que estos modos no están alineados para minimizar esta relación.
Por otro lado, la señal asociada a la fase de 90º del cEOF1 sí muestra valores excesivamente altos no observados en ERA5.


(ref:cor-sst-regr-cap) R\^2 entre los patrones de regresión de TSM cada modelo y el patrón de regresión de TSM en ERA5.

```{r cor-sst-regr, fig.width=6, fig.height=4}
sst_cors <- sst_regression %>% 
  .[, Interpolate(estimate ~ lon + lat,
                  x.out = unique(sst_regression_ERA5$lon),
                  y.out = unique(sst_regression_ERA5$lat)),
    by = .(model, experiment, term, cEOF)] %>%
  na.omit() %>% 
  .[sst_regression_ERA5, on = .NATURAL] %>% 
  .[, correlate(estimate, era5), by = .(model, experiment, term, cEOF)] %>% 
  .[, r2 := estimate^2]

sst_cors %>% 
  .[, r2_ceof2 := r2[cEOF == "cEOF2" & term == "Imaginario"],
    by = .(model, experiment)] %>% 
  .[, model := reorder(model, r2_ceof2, fun = mean)] %>% 
  {
    models_sst_cor <<- levels(.$model)
    .
  } %>% 
  
  .[, picos := model %in% con_picos$model & cEOF == "cEOF2" & term == "Imaginario"] %>% 
  ggplot(aes(r2, model)) +
  # geom_col(aes(x = 1 , 
  #               y = ifelse(picos, model, NA)), alpha = 0.2, fill = "gray50") +
  geom_col(aes(fill = term), 
           position = position_dodge2(reverse = TRUE, padding = 0)) +
  scale_fill_fase() +
  scale_x_continuous("R^2 espacial", limits = c(0, 1), labels = scales::percent_format()) +
  scale_y_discrete(NULL) +
  facet_wrap(~cEOF)

```

Para una visión global y quantitativa de esta comparación, la Figura \@ref(fig:cor-sst-regr) muestra el $r^2$ los campos de regresión de cada modelo y el campo de regresión de ERA5.
En la mayoría de los modelos el patrón de regresión de la fase de 90º del cEOF2 es similar al observado, excepto por INM-CM5-0. 
El patrón de regresión de la fase de 0º, en cambio, tiene baja similitud con el observado en casi todos los modelos. 
Posiblemente esto se deba a el exceso de señal presente en la región del ENSO. 
Para ambas fases del cEOF1, las similitudes con el patrón de regresión observado son muy bajas.
Esto es esperable dado la falta de señal en las observaciones y el exceso de señal en los modelos. 

### Relación con el SAM

```{r sam_cors}
sam_rename <- c(sam = "full",
                asam = "asym",
                ssam = "sym")


cmip_sam <- readRDS(data_path("derived", "cmip_sam.Rds")) 

cmip_sam_series <- cmip_sam %>% 
  .[, time_series[[1]], by = .(model, experiment, lev)] %>% 
  setnames("type", "term") %>% 
  .[, term := sam_rename[term]] %>% 
  .[, estimate_norm := estimate/sd(estimate[term == "full" & year(time) %between% c(1979, 2014)]),
    by = .(model, experiment, lev)]

indices <- SAM() %>% 
  fread() %>% 
  .[, time := as.Date(time)] %>% 
  .[, `:=`(model = "ERA5",
           experiment = "reanalysis",
           ensemble = "1.1.1.1", 
           PC = NULL, 
           adj.r.squared = NULL)] 

sam_series <- rbind(indices, cmip_sam_series)

levs <- sam_series[model == "ERA5", unique(lev)]

sam_cors <- sam_series %>% 
  .[season(time) == "SON"] %>% 
  .[, .(estimate = mean(estimate)), 
    by = .(model, experiment, ensemble, term, time = year(time), lev)] %>% 
  .[ceofs[, eof[[1]]$left, by = .(model, experiment)], 
    on = c("model", "experiment", "ensemble", "time")] %>% 
  # best_angle[., on = .NATURAL] %>% 
  # .[cEOF == "cEOF2", hgt := rotate(hgt, angle)] %>% 
  sep_ReIm() %>% 
  na.omit() %>% 
  # .[experiment %in% c("historical", "reanalysis")] %>% 
  .[, .(correlation = cor(estimate, hgt)), 
    by = .(model, ensemble, experiment, cEOF, term, part, lev)]


rm(indices, cmip_sam_series, cmip_sam, sam_series)
```

```{r cor-sam-cmip6, fig.height=5, fig.width=6}
gdata <- sam_cors %>% 
  .[, .(correlation = mean(correlation)), by = .(cEOF, term, model, experiment, part, lev)] %>% 
  .[, approx(lev, correlation, xout = levs), by = .(cEOF, term, model, experiment, part)] %>% 
  setnames(c("x", "y"), c("lev", "correlation")) %>% 
  .[, term := factor_sam(term)]

# facet_grid2 shenanigans
panels <- paste(rep(letters[1:4], 3), rep(1:3, each = 4), sep = ".")
order <- order(c(1, 5, 9, 2, 6, 10, 3, 7, 11, 4, 8, 12))
panels <- panels[order]

# gdata <- gdata %>% 
#   .[, ggplot2::mean_se(correlation^2), by = .(lev, experiment, cEOF, part, term)]

ggplot(mapping = aes(lev, correlation^2)) +
  geom_line(data = gdata[experiment == "reanalysis"] %>% 
              .[, experiment := NULL],
            aes(color = term), 
            linewidth = 2) +
  stat_summary(data = gdata[experiment != "reanalysis"] %>% 
                 .[experiment == "historical"],
               fun.data = \(x) mean_se(x,
                                       mult = qt(.025, length(x), 
                                                 lower.tail = FALSE)), 
               
               geom = "ribbon", alpha = 0.4, aes(fill = term)) +
  
  
  stat_summary(data = gdata[experiment != "reanalysis"] %>% 
                 .[experiment == "historical"],
               fun = mean, 
               geom = "line", alpha = 1, aes(color = term)) +
  
  geom_line(data = gdata[experiment != "reanalysis"][experiment == "historical"],
            aes(group = interaction(term, model), color = term), alpha = 0.1) +
  
  # geom_line(data = gdata[experiment != "reanalysis"][experiment == "historical"] %>% 
  #             .[model == "NorCPM1"],
  #           aes(group = interaction(term, model))) +
  
  
  ggh4x::facet_grid2(term ~ cEOF + part, 
                     labeller = labeller(part = lab_cplx, 
                                         term = c(full = "SAM",
                                                  asym = "A-SAM",
                                                  sym = "S-SAM")), 
                     strip = ggh4x::strip_nested()) +
  coord_flip() +
  scale_x_level() +
  scale_y_continuous(name = r2,  limits = c(0, 1), 
                     labels = scales::percent_format()) +
  scale_color_brewer(NULL, palette = "Dark2", labels = c(full = "SAM",
                                                         asym = "A-SAM",
                                                         sym = "S-SAM"), 
                     aesthetics = c("colour", "fill")) +
  tag_facets(position = "tr", tag_pool = panels) +
  panel_background() 
```

(ref:cor-sam-cmip6-cap) Igual que la Figura \@ref(fig:sam-eof-vertical) pero para los modelos del CMIP6.

En la Sección \@ref(sam-ceof) se mostró que existía una relación importante entre las distintas fase de los cEOFs y las distintas componentes del SAM. 
La Figura \@ref(fig:cor-sam-cmip6) muestra el $r^2$ entre las componentes del SAM y las fases de los cEOFs para los modelos del CMIP6. 
Las líneas translúcidas son los valores promedio de cada modelo y las áreas llenas representan el promedio multimodelo y su intervalo de confianza del 95%; la línea gruesa es el valor de ERA5.

La relación entre el cEOF1 y el SAM en los modelos del CMIP6 es similar a la observada, aunque con diferencias en la magnitud. 

En cuanto al cEOF2, los modelos del CMIP6 capturan correctamente la falta de correlación entre fase de 0º del cEOF2 y el SAM y el S-SAM (paneles c.1 y c.3), pero tienen un nivel de correlación más alto de lo esperado con el A-SAM en la tropósfera (panel c.2).
La fase de 90º, en cambio, no muestra la relación observada con el SAM en la tropósfera (panel d.1). 
A pesar de esto, sí tiene una relación alta con el A-SAM (panel d.2). 
Esto sugiere que los modelos CMIP6 no capturan correctamente la relación entre el PSA2 el SAM, pero esta relación sí aparece si se filtra sólo la variabilidad de la parte asimétrica del SAM. 

## Tendencias

De la sección anterior surge que los modelos del CMIP6 logran capturar la estructura espacial de los cEOFs correctamente y que algunos modelos capturan también su variabilidad y relación con otras componentes del sistema climático.

En esta sección, aprovechamos las corridas largas de estos modelos y los experimentos de DAMIP para estudiar las tendencias a largo plazo y sus posibles forzantes. 
Para extender las series temporales para todo el período disponible en CMIP6 y DAMIP, proyectamos los campos espaciales del período moderno en los campos desde 1850 hasta 2014.

```{r series-largas, fig.width=6, fig.height=4}
ceof_largo_p %>% 
  sep_ReIm() %>% 
  .[experiment == "historical"] %>% 
  .[, hgt := Anomaly(hgt, time >= 1900), by = .(model, experiment, part, ensemble, cEOF)] %>%
  .[, hgt := hgt/sd(hgt[time >= 1900]), by = .(model, experiment, part, ensemble, cEOF)] %>% 
  .[, .(hgt = mean(hgt)), by = .(model, experiment, time, part, cEOF)] %>% 
  ggplot(aes(time, hgt)) +
  geom_line(aes(group = model), 
            alpha = 0.1) +
  geom_line(data = ~.x[, .(hgt = mean(hgt)), by = .(time, experiment, cEOF, part)]) +
  scale_x_continuous(NULL) +
  scale_y_continuous(NULL) +
  scale_color_fase(name = NULL, guide = "none") +
  coord_cartesian(ylim = c(-1, 1)) +
  facet_grid(cEOF ~ part, labeller = labeller(part = lab_cplx))
```

(ref:series-largas-cap) Series temporales de anomalías estandarizadas de los cEOFs computados usando el período 1850 -- 2014. Las anomalías están computadas sobre el período 1850 -- 1900. En líneas translúcidas, las series promedio de cada modelo. En línea oscura, la media multimodelo. 

La Figura \@ref(fig:series-largas) muestra las series temporales durante todo el período. 
La fase de 0º del cEOF1 tiene una pequeña tendencia positiva comenzando al rededor de 1950, consistente con la tendencia observada en ERA5 (Fig. \@ref(fig:extended-series)). 
Sin embargo, la fase de 90º del cEOF1 tiene una tendencia negativa mucho mayor, la cual no está está presente en ERA5. 


```{r trends}
trends <- ceof_largo_p %>% 
  sep_ReIm() %>% 
  .[experiment %in% c("historical", "reanalysis")] %>%
  .[, hgt := Anomaly(hgt, time >= 1900), by = .(model, experiment, part, ensemble, cEOF)] %>% 
  .[, hgt := hgt/sd(hgt[time >= 1900]), by = .(model, experiment, part, ensemble, cEOF)] %>%
  .[time >= 1950] %>% 
  # .[, .(hgt = mean(hgt)), by = .(model, experiment, ensemble, time, part, cEOF)] %>% 
  .[, FitLm(hgt, time = time/10, se = TRUE), 
    by = .(model, cEOF, ensemble, part, experiment)] %>% 
  .[term == "time"] %>%
  .[, p.value := Pvaluate(estimate, std.error, df, "fdr"), 
    by = .(model, experiment, cEOF)] %>% 
  cors[., on = c("model", "experiment", "cEOF")] 

plot_trend <- function(data) {
  data %>% 
    .[, model := paste0(model, "\n(", scales::number(correlation^2, 0.01), ")")] %>% 
    .[, model := reorder(model, correlation^2)] %>% 
    ggplot(aes(model, estimate)) +
    geom_hline(yintercept = 0, color = "gray50") +
    geom_point(alpha = 0) +
    geom_boxplot(width = 0.5,
                 outlier.shape = NA,
                 fill = NA,
                 data = ~.x[!startsWith(as.character(model), "ERA5")]) +
    ggforce::geom_sina(aes(shape = p.value < 0.05,
                           size = p.value < 0.05,
                           group = interaction(part, model)),
                       alpha = 1
                       # size = 1,
    ) +
    geom_hline(data = \(x) x %>% 
                 .[, .(estimate = mean(estimate)), by = .(part, model)] %>% 
                 .[, .(estimate = mean(estimate)), by = .(part)], 
               aes(yintercept = estimate), linetype = 2) +
    scale_color_brewer(NULL, palette = "Set1") +
    scale_x_discrete(NULL) +
    scale_y_continuous("Tendencia (desvío estándard por década)") +
    coord_flip()  +
    scale_shape_manual(values = c("FALSE" = 19,
                                  "TRUE" = 4), 
                       guide = "none") +
    scale_size_manual(values = c("TRUE" = 2.5,
                                 "FALSE" = 0.5),
                      guide = "none") +
    facet_wrap(~part, labeller = labeller(part = lab_cplx)) +
    NULL
}
```

```{r trends-ceof1,fig.width=6, fig.height=6}
trends %>% 
  .[cEOF == "cEOF1"] %>% 
  plot_trend()  
```

(ref:trends-ceof1-cap) Tendencias lineales de cada fase del cEOF1 desde 1950. Cada punto representa un miembro, donde los miembros con tendencias significativas (p-valor < 0.01) se marcan con una cruz. La línea vertical punteada representa la tendencia media de todos los modelos. 

Las tendencias de cada fase del cEOF1 para cada modelo desde 1950 se muestra en la Figura \@ref(fig:trends-ceof1) junto con la tendencia promedio de todos los modelos. 
La tendencia media de la fase de 0º es positiva pero muy pequeña.
Además, los modelos no son consistentes en sus tendencias y sólo algunos modelos tienen una tendencia promedio positiva.
Por otro lado, las tendencias de la fase de 90º son más consistentes. 

Estas tendencias son incompatibles con la variabilidad del cEOF1 observado, el cual tiene una tendencia positiva de su fase de 0º y ninguna tendencia en su fase de 90º. 
Es posible los modelos tengan algún problema fundamental al capturar la variabilidad a largo plazo de este modo, ya sea por falencias en la dinámica interna o por algún problema con el forzante involucrado. 

También es posible que la tendencia observada se deba a variabilidad interna de baja frecuencia. 
En este caso, no sería es esperable que los modelos capturen correctamente la fase de esta variabilidad, por lo que no sería observable ni en la media multimodelo ni en en las tendencias de cada miembro particularmente en el período 1950--2014. 

Finalmente, dado que el cEOF1 captura el campo medio de las anomalías zonales de altura geopotencial y que los distintos modelos de CMIP6 tienen potencialmente un campo medio distinto a ERA5, es posible que la rotación elegida del cEOF1 no sea la ideal para capturar la variabilidad de largo plazo compatible con lo observado en ERA5. 


```{r ceof-damip, fig.width=6, fig.height=4}
ceof_largo_p %>% 
  sep_ReIm() %>% 
  
  .[, hgt := Anomaly(hgt, time <= 1900), by = .(model, experiment, part, ensemble, cEOF)] %>% 
  .[, hgt := hgt/sd(hgt[time <= 1900]), by = .(model, experiment, part, ensemble, cEOF)] %>% 
  # .[, eof := scale_eof(eof, time <= 1900), by = .(model, experiment, part, ensemble, cEOF)] %>%
  # .[, eof := scale(eof, center = mean(eof[time <= 1900]), 
  #                  scale = sd(eof[time <= 1900])),
  #   by = .(model, part, cEOF)] %>% 
  .[, .(hgt = mean(hgt)), by = .(model, experiment, time, part, cEOF)] %>% 
  # .[experiment != "historical"] %>% 
  
  ggplot(aes(time, hgt, color = experiment)) +
  # geom_line(aes(group = model), alpha = 0.1) +
  geom_line(data = ~.x[, .(hgt = mean(hgt)), by = .(time, experiment, cEOF, part)], 
            alpha = 0.3) +
  geom_smooth(data = ~.x[, .(hgt = mean(hgt)), by = .(time, experiment, part, cEOF)],
              show.legend = FALSE) +
  
  # geom_line(data = ceof_era5[, eof[[1]]$left] %>% sep_ReIm() %>% .[, eof := scale_eof(eof), by = .(cEOF, part)]) +
  scale_x_continuous(NULL) +
  scale_y_continuous(NULL) +
  scale_color_experiments(guide = guide_legend(override.aes = list(linewidth = 2, alpha = 1))) +
  # coord_cartesian(ylim = c(-1.5, 1.5)) +
  facet_grid(cEOF ~ part, labeller = labeller(part = lab_cplx))
```

Aún considerando estas limitaciones, para tratar de atribuir esta tendencia, computamos los mismos cEOFs para experimentos de DAMIP.
La Figura \@ref(fig:ceof-damip) muestra las series temporales para los experimentos hist-GHG, hist-nat, hist-stratO3 e hist-aer junto a las corridas históricas.

Para la fase de 0º del cEOF1, ni hist-nat ni hist-aer muestran tendencias significativas, sugiriendo que la tendencia observada no se debe a variabilidad ni al forzante de los aerosoles antropogénicos. 
Por otro lado, hist-stratO3 muestra una tendencia mucho mayor a la observada e hist-GHG muestra una tendencia negativa de similar magnitud la de hist-stratO3. 
Esto sugiere que el ozono estatosférico y los gases de efecto invernadero tienen efectos contrarios sobre esta fase del cEOF1.

La fase de 90º del cEOF1, presenta una tendencia positiva en hist-aer y negativa en hist-GHG y, más débil, en hist-stratO3. 
Al igual que con la fase de 0º, esto sugiere una compensación parcial entre forzantes. 

(ref:suma-cap) Media multimodelo de las dos fases del cEOF1 para las corridas históricas y para la suma de las corridas hist-GHG, hist-stratO3 e hist-aer.

```{r suma, fig.width=6, fig.height=3}
ceof_largo_p %>%
  
  sep_ReIm() %>%
  # .[experiment == "historical"] %>%
  .[, hgt := Anomaly(hgt, time <= 1900), by = .(model, experiment, part, ensemble, cEOF)] %>%
  .[, hgt := hgt/sd(hgt[time <= 1900]), by = .(model, experiment, part, ensemble, cEOF)] %>%
  .[, .(hgt = mean(hgt)), by = .(model, experiment, time, part, cEOF)] %>%
  .[, .(hgt = mean(hgt)), by = .(experiment, time, part, cEOF)] %>%
  .[, .(historical = hgt[experiment == "historical"],
        # suma_forzantes = sum(hgt[experiment != "historical"]),
        antropogénicos = sum(hgt[!(experiment %in% c("historical", "hist-nat"))])),
    by = .(time, part, cEOF)] %>%
  .[cEOF == "cEOF1"] %>% 
  dt_pivot_longer(cols = historical:antropogénicos) %>%
  ggplot(aes(time, value)) +
  geom_line(aes(color = name), alpha = 0.4) +
  geom_smooth(aes(color = name)) +
  scale_color_brewer(palette = "Set1") +
  facet_grid(cEOF ~ part, labeller = labeller(part = lab_cplx))
```

Como una primera aproximación al efecto combinado de todos estos forzantes, la Figura \@ref(fig:suma) muestra la media multimodelo de la corrida histórica junto con la suma de las medias multimodelo de las corridas hist-GHG, hist-stratO3 e hist-aer.
Sorpendentemente ambas series presentan una variabilidad a largo plazo virtualmente idéntica, sugiriendo que el efecto de los forzantes es aproximadamente lineal.

Esta compensación parcial entre forzantes es otra posible explicación para las diferencias entre las tendencias observadas y las modeladas, ya que pequeñas diferencias en la respuesta de los modelos a los forzantes pueden hacer que la tendencia resultante cambie de signo o no se anule completamente. 


```{r trends_cmip, eval = FALSE}

no_poolling <- ceof_largo_p %>% 
  sep_ReIm() %>% 
  # .[experiment == "historical"] %>% 
  .[, hgt := Anomaly(hgt, time <= 1900), by = .(model, experiment, part, ensemble, cEOF)] %>% 
  .[, hgt := hgt/sd(hgt[time <= 1900]), by = .(model, experiment, part, ensemble, cEOF)] %>% 
  .[time >= 1960] %>% 
  .[, FitLm(hgt, time, se = TRUE), by = .(experiment, model, ensemble, part)] %>% 
  rm_intercept()


trends_cmip <-ceof_largo_p %>% 
  sep_ReIm() %>% 
  # .[experiment == "historical"] %>% 
  .[, hgt := Anomaly(hgt, time <= 1900), by = .(model, experiment, part, ensemble, cEOF)] %>% 
  .[, hgt := hgt/sd(hgt[time <= 1900]), by = .(model, experiment, part, ensemble, cEOF)] %>% 
  .[time >= 1960] %>% 
  .[, model := as.factor(model)] %>% 
  .[, .(model = list(lme4::lmer(hgt ~ time  + (time | model/ensemble), data = .SD))), by = .(part, cEOF, experiment)]
```

```{r lmer-funs, eval = FALSE}


lmer_fixed <- function(model) {
  summary <- summary(model)
  
  data.table::data.table(
    term = rownames(summary$coefficients),
    estimate = summary$coefficients[, 1],
    std.error = summary$coefficients[, 2],
    t.value = summary$coefficients[, 3]
  )
}

lmer_rand <- function(model, level) {
  
  coef(model)[[level]] %>% 
    data.table::as.data.table(keep.rownames = "level") %>% 
    tidyfast::dt_pivot_longer(cols = -level, names_to = "term", values_to = "estimate") %>% 
    tidyfast::dt_separate(level, sep = ":", into = strsplit(level, split = ":", fixed = TRUE)[[1]])
  
}

```

```{r trends-cmip, eval=FALSE, include=FALSE}
trends_cmip %>% 
  # [experiment == "historical"] %>% 
  .[cEOF == "cEOF1"] %>%
  ggplot() +
  geom_point(data = \(x) x[, lmer_rand(model[[1]], "ensemble:model"), by = .(part, experiment, cEOF)] %>%
               rm_intercept(),
             aes(estimate, model)) +
  geom_point(data = \(x) x[, lmer_rand(model[[1]], "model"), by = .(part, experiment, cEOF)] %>% rm_intercept(),
             aes(estimate, model), size  = 3) +
  geom_vline(data = \(x) x[, lmer_fixed(model[[1]]), by = .(part, experiment, cEOF)] %>% rm_intercept(),
             aes(xintercept = estimate)) +
  # geom_vline(data = \(x) x[, lmer_fixed(model[[1]]), by = .(part, cEOF)] %>% rm_intercept(),
  #            aes(xintercept = estimate + 2*std.error)) +
  #   geom_vline(data = \(x) x[, lmer_fixed(model[[1]]), by = .(part, cEOF)] %>% rm_intercept(),
  #            aes(xintercept = estimate - 2*std.error)) +
  
  facet_grid(experiment + cEOF ~ part, scales = "free") +
  panel_background()
```

```{r trends_cmip2,  eval=FALSE}
trends_cmip %>% 
  # .[cEOF == "cEOF1"] %>% 
  .[, broom.mixed::tidy(model[[1]]), by = .(part, cEOF, experiment)] %>% 
  .[effect == "fixed"] %>% 
  rm_intercept() %>% 
  ggplot(aes(part, estimate)) +
  geom_col(aes(fill = experiment), position = position_dodge()) +
  # geom_errorbar(aes(ymin = estimate - 2*std.error, ymax = estimate  + 2*std.error, 
  #                   group = experiment), 
  #               width = 0.3,
  #               position = position_dodge(width = 0.9)) +
  # scale_fill_experiments() +
  facet_wrap(~cEOF) +
  coord_flip() 

```

## Conclusiones

Los modelos del CMIP6 consiguen caracterizar la estructura espacial de los cEOFs satisfactoriamente, con una buena correlación entre los patrones espaciales, particularmente la media multimodelo. 
La habilidad de los modelos de capturar sus características de segundo orden, como la relación con el ENSO y el SAM no es tan buena ni homogénea entre modelos. 
Sólo algunos modelos, como MIROC6 y CESM2 consiguen capturar la influencia del ENSO en la fase del cEOF2 y la relación de la mayoría de los modelos con el SAM es menor a la observada. 

La tendencia positiva de la fase de 0º del cEOF1 es capturada por la media multimodelo y el análisis de las corridas de DAMIP indican que ésta es  principalmente por el forzarte del ozono estratosférico parcialmente compensado por el forzante de los gases de efecto invernadero. 
Los modelos del CMIP6 también presentan una tendencia negativa en la fase de 90º del cEOF1 no presente en las observaciones que también es influenciada por el forzante antropogénico 
